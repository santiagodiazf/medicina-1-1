<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Fisiología: Transporte Vesicular y Señalización</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* Naranja para procesos activos/vesículas */
            --success: #27ae60;
            --error: #c0392b;
            --warning: #f1c40f;
            --light: #ecf0f1;
            --text: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f7;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- PANTALLAS (Overlay) --- */
        #start-screen, #results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            text-align: center;
        }

        .hidden { display: none !important; }

        h1 { color: var(--primary); margin-bottom: 10px; }
        h2 { color: var(--primary); margin-bottom: 20px; }
        p { font-size: 1.1em; color: #555; max-width: 600px; margin-bottom: 20px; }

        .btn-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--accent); color: white; }
        .btn-danger { background-color: var(--error); color: white; }
        .btn-warning { background-color: var(--warning); color: #333; }
        .btn-info { background-color: #3498db; color: white; }

        /* --- LAYOUT PRINCIPAL --- */
        #app-container {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* Sidebar Navegación */
        #sidebar {
            width: 70px;
            background-color: var(--primary);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-dot {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.2);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .nav-dot:hover { background-color: rgba(255,255,255,0.4); }
        .nav-dot.active { border-color: white; transform: scale(1.15); font-weight: bold; }
        .nav-dot.correct { background-color: var(--success); }
        .nav-dot.wrong { background-color: var(--error); }
        .nav-dot.marked { border-color: var(--warning); color: var(--warning); font-weight: bold; }
        .nav-dot.marked.correct { background-color: var(--success); color: white; border-color: var(--warning); }
        .nav-dot.marked.wrong { background-color: var(--error); color: white; border-color: var(--warning); }

        /* Área de Preguntas */
        #main-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 50px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            border-left: 5px solid var(--accent);
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .q-title {
            font-size: 1.15em;
            font-weight: 600;
            color: var(--primary);
            line-height: 1.4;
            width: 85%;
        }

        /* Checkbox de Marcar */
        .mark-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9em;
            color: #7f8c8d;
            user-select: none;
        }
        .mark-container input { display: none; }
        .mark-icon { font-size: 1.5em; margin-right: 5px; transition: color 0.2s; }
        .mark-container input:checked ~ .mark-icon { color: var(--warning); }
        .mark-container input:checked ~ span { color: #d35400; font-weight: bold; }
        .mark-icon::before { content: '☆'; }
        .mark-container input:checked ~ .mark-icon::before { content: '★'; }

        /* Opciones */
        .options-list { display: flex; flex-direction: column; gap: 10px; }

        .option-btn {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: left;
            font-size: 1em;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .option-btn:hover:not(:disabled) { border-color: var(--accent); background-color: #f0f8ff; }
        
        .option-btn.correct { background-color: #d4edda; border-color: var(--success); color: #155724; }
        .option-btn.wrong { background-color: #f8d7da; border-color: var(--error); color: #721c24; }
        
        /* Explicación */
        .explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f6f3;
            border-left: 4px solid var(--success);
            border-radius: 4px;
            color: #2c3e50;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .explanation-text { margin-bottom: 10px; }
        .diagram-placeholder {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px dashed #ccc;
            color: #777;
            font-style: italic;
            font-size: 0.9em;
            text-align: center;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Botón Flotante Finalizar */
        #finish-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            font-size: 1.1em;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* Stats en Modal */
        .stats-row {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin: 20px 0;
        }
        .stat-box { text-align: center; }
        .stat-number { display: block; font-size: 2.5em; font-weight: bold; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--error); }

    </style>
</head>
<body>

    <div id="start-screen">
        <h1>Fisiología: Transporte Vesicular</h1>
        <p>50 Preguntas | Endocitosis, Exocitosis e Integración</p>
        <p>Selecciona el modo de orden de las preguntas:</p>
        <div class="btn-container">
            <button class="btn-primary" onclick="initQuiz('ordered')">Orden Numérico (1-50)</button>
            <button class="btn-secondary" onclick="initQuiz('random')">Orden Aleatorio</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav id="sidebar"></nav>
        <main id="main-area"></main>
        <button id="finish-btn" class="btn-danger" onclick="showResults()">Finalizar Quiz</button>
    </div>

    <div id="results-modal" class="hidden">
        <h2>Resultados</h2>
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-number text-success" id="res-correct">0</span>
                <span>Aciertos</span>
            </div>
            <div class="stat-box">
                <span class="stat-number text-danger" id="res-wrong">0</span>
                <span>Fallos</span>
            </div>
        </div>
        <p id="res-msg"></p>

        <h3>Opciones de Reintento</h3>
        <div class="btn-container">
            <button class="btn-primary" onclick="restartQuiz('all')">Repetir Completo</button>
            <button class="btn-danger" id="btn-retry-failed" onclick="restartQuiz('failed')">Repetir Falladas</button>
            <button class="btn-warning" id="btn-retry-marked" onclick="restartQuiz('marked')">Repetir Marcadas</button>
            <button class="btn-info" id="btn-retry-combo" onclick="restartQuiz('combo')">Falladas + Marcadas</button>
        </div>
        <br>
        <button style="background:transparent; color:#777; border:1px solid #ccc; font-size:0.9em;" onclick="closeModal()">Volver a revisar respuestas</button>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS (50 Items) ---
        const dbQuestions = [
            // Bloque 1: Fagocitosis vs Endocitosis
            { id: 1, q: "El profesor explica que la fagocitosis se diferencia mecanísticamente de la endocitosis convencional en que:", options: ["La fagocitosis no requiere ATP.", "La fagocitosis implica una reorganización activa del citoesqueleto de actina para emitir pseudópodos que \"abrazan\" la partícula.", "La fagocitosis ocurre por simple invaginación de la membrana sin cambios en el citoesqueleto.", "La fagocitosis la realizan todas las células del organismo."], ans: 1, exp: "Respuesta: B. " },
            { id: 2, q: "¿Qué tipos celulares son los únicos capacitados fisiológicamente para realizar fagocitosis según el audio?", options: ["Todas las células epiteliales.", "Eritrocitos y plaquetas.", "Células del sistema inmune: macrófagos, neutrófilos y células dendríticas.", "Neuronas y células gliales."], ans: 2, exp: "Respuesta: C" },
            { id: 3, q: "¿Cuál es el destino final del fagosoma tras la internalización de una bacteria?", options: ["Se recicla inmediatamente a la membrana.", "Se fusiona con el aparato de Golgi.", "Se fusiona con lisosomas que contienen enzimas hidrolíticas para degradar al patógeno.", "Se expulsa por transcitosis."], ans: 2, exp: "Respuesta: C" },
            { id: 4, q: "El proceso de fagocitosis es descrito en el audio como un proceso:", options: ["Inespecífico y aleatorio.", "Selectivo, requiriendo la unión de la partícula a receptores específicos en la membrana del fagocito.", "Pasivo, impulsado por gradientes osmóticos.", "Exclusivo de bacterias muertas."], ans: 1, exp: "Respuesta: B (Pista audio: \"el proceso es selectivo, no se fagocita cualquier cosa\")." },
            { id: 5, q: "Aproximadamente, ¿cuántos eritrocitos envejecidos o muertos debe eliminar un macrófago al día mediante fagocitosis según el dato curioso del profesor?", options: ["100.", "10 elevado a 11.", "1 millón.", "Ninguno, los eritrocitos se lisan solos en el plasma."], ans: 1, exp: "Respuesta: B" },

            // Bloque 2: Endocitosis Mediada por Receptor (LDL/Transferrina)
            { id: 6, q: "En la endocitosis mediada por receptor, ¿qué proteína se encarga de recubrir la vesícula intracelularmente formando una estructura de \"canasta\" o \"jaula\"?", options: ["Actina.", "Caveolina.", "Clatrina.", "Tubulina."], ans: 2, exp: "Respuesta: C 

[Image of clathrin-mediated endocytosis process]
" },
            { id: 7, q: "En el proceso de endocitosis de LDL, ¿cuál es la función de la adaptina?", options: ["Unir el colesterol al fosfolípido.", "Servir de puente de unión entre el receptor de LDL y la cubierta de clatrina.", "Degradar el LDL.", "Acidificar el endosoma."], ans: 1, exp: "Respuesta: B" },
            { id: 8, q: "¿Qué ocurre con la cubierta de clatrina inmediatamente después de que la vesícula endocítica se separa de la membrana plasmática?", options: ["Se degrada en el lisosoma.", "Se fusiona con el núcleo.", "Se desensambla (se pierde) y la clatrina se recicla hacia la membrana.", "Permanece unida hasta llegar al lisosoma."], ans: 2, exp: "Respuesta: C" },
            { id: 9, q: "En la hipercolesterolemia familiar causada por un fallo en el receptor de LDL, ¿cuál es el defecto molecular mencionado en clase?", options: ["El LDL no se une al colesterol.", "El receptor carece del sitio de unión a la adaptina, impidiendo su internalización en las fosas de clatrina.", "La clatrina no se forma.", "El lisosoma no tiene enzimas."], ans: 1, exp: "Respuesta: B" },
            { id: 10, q: "Una diferencia CRUCIAL que el profesor enfatiza entre el ciclo del LDL y el ciclo de la Transferrina es:", options: ["El LDL se recicla y la transferrina se degrada.", "En el LDL se recicla el receptor y se degrada el ligando; en la Transferrina se reciclan tanto el receptor como el ligando (apotransferrina).", "La transferrina no usa clatrina.", "El LDL entra por caveolas."], ans: 1, exp: "Respuesta: B " },
            { id: 11, q: "¿Qué factor físico-químico dentro del endosoma provoca la liberación del hierro de la transferrina?", options: ["La presencia de calcio.", "El pH ácido (alrededor de 5.0 - 6.0).", "La temperatura.", "La presión osmótica."], ans: 1, exp: "Respuesta: B" },
            { id: 12, q: "Una vez que la transferrina libera el hierro en el endosoma, se convierte en apotransferrina. ¿Qué le sucede?", options: ["Se degrada inmediatamente.", "Permanece unida al receptor y ambos se reciclan a la membrana plasmática donde el pH neutro provoca su disociación.", "Se transporta al núcleo.", "Se convierte en ferritina."], ans: 1, exp: "Respuesta: B" },
            { id: 13, q: "El LDL (Lipoproteína de Baja Densidad) es endocitado principalmente para:", options: ["Eliminar basura celular.", "Proporcionar colesterol a la célula para la síntesis de membranas y otros esteroides.", "Aumentar la presión oncótica celular.", "Generar ATP en la mitocondria."], ans: 1, exp: "Respuesta: B" },

            // Bloque 3: Exocitosis
            { id: 14, q: "La exocitosis constitutiva se caracteriza por:", options: ["Ocurrir solo en neuronas.", "Ser un proceso continuo de aporte de lípidos y proteínas a la membrana plasmática y secreción basal.", "Requerir siempre una señal de Calcio elevada.", "Estar regulada por hormonas."], ans: 1, exp: "Respuesta: B" },
            { id: 15, q: "La exocitosis regulada se diferencia de la constitutiva en que:", options: ["Ocurre en todas las células.", "Las vesículas se acumulan cerca de la membrana esperando una señal específica (ligando/Ca2+) para fusionarse.", "No gasta ATP.", "Transporta componentes estructurales de la membrana."], ans: 1, exp: "Respuesta: B " },
            { id: 16, q: "¿Qué ión juega un papel central como \"gatillo\" o señal intracelular para disparar la exocitosis regulada en sinapsis y células endocrinas?", options: ["Sodio (Na+).", "Potasio (K+).", "Calcio (Ca2+).", "Cloro (Cl-)."], ans: 2, exp: "Respuesta: C" },
            { id: 17, q: "El equilibrio entre endocitosis y exocitosis es fundamental para:", options: ["Mantener el tamaño y superficie de la membrana plasmática constante.", "Generar energía.", "La división celular exclusivamente.", "Cambiar el ADN."], ans: 0, exp: "Respuesta: A" },

            // Bloque 4: Transcitosis y Caveolas
            { id: 18, q: "La transcitosis se define como:", options: ["El transporte de moléculas entre el núcleo y el citoplasma.", "El transporte de moléculas a través de todo el espesor celular, combinando endocitosis en un polo y exocitosis en el opuesto.", "La degradación de moléculas en el citosol.", "El movimiento de organelas."], ans: 1, exp: "Respuesta: B " },
            { id: 19, q: "Un ejemplo clásico de transcitosis mencionado por el profesor es:", options: ["La absorción de glucosa.", "El paso de inmunoglobulinas (IgA) de la leche materna al bebé a través del epitelio intestinal.", "La entrada de colesterol.", "La bomba de sodio-potasio."], ans: 1, exp: "Respuesta: B" },
            { id: 20, q: "Además de la clatrina, existe otro tipo de endocitosis mediada por unas estructuras lipídicas ricas en colesterol llamadas:", options: ["Pseudópodos.", "Caveolas (recubiertas de caveolina).", "Desmosomas.", "Ribosomas."], ans: 1, exp: "Respuesta: B" },
            { id: 21, q: "Las caveolas son especialmente abundantes en:", options: ["Células endoteliales y musculares lisas.", "Glóbulos rojos.", "Bacterias.", "Neuronas exclusivamente."], ans: 0, exp: "Respuesta: A" },

            // Bloque 5: Integración Fisiológica (Célula Beta)
            { id: 22, q: "El profesor utiliza el ejemplo de la Insulina y el GLUT4 en el músculo para ilustrar:", options: ["La endocitosis de glucosa.", "Cómo la Vmax de transporte puede aumentar reclutando transportadores desde vesículas intracelulares a la membrana mediante exocitosis regulada.", "La degradación de glucosa.", "El transporte activo primario."], ans: 1, exp: "Respuesta: B " },
            { id: 23, q: "En la célula beta pancreática, ¿qué evento metabólico inicia la cascada de secreción de insulina?", options: ["La entrada de glucosa y el aumento de la relación ATP/ADP intracelular.", "La entrada de calcio directa.", "La salida de sodio.", "La hidrólisis de lípidos."], ans: 0, exp: "Respuesta: A " },
            { id: 24, q: "El aumento de ATP en la célula beta provoca el CIERRE de un canal específico. ¿Cuál es?", options: ["Canal de Sodio voltaje dependiente.", "Canal de Potasio sensible a ATP (K-ATP).", "Canal de Cloro.", "Canal de Calcio."], ans: 1, exp: "Respuesta: B" },
            { id: 25, q: "El cierre de los canales de K-ATP provoca una acumulación de cargas positivas dentro de la célula (K+), lo que lleva a:", options: ["Hiperpolarización de la membrana.", "Repolarización.", "Despolarización de la membrana.", "Apoptosis celular."], ans: 2, exp: "Respuesta: C" },
            { id: 26, q: "La despolarización de la membrana de la célula beta abre canales dependientes de voltaje de:", options: ["Potasio.", "Sodio.", "Calcio (Ca2+).", "Magnesio."], ans: 2, exp: "Respuesta: C" },
            { id: 27, q: "La entrada masiva de Calcio en la célula beta actúa como señal para:", options: ["La síntesis de ADN.", "La fusión de las vesículas de insulina con la membrana (exocitosis).", "Cerrar los canales de glucosa.", "Destruir la célula."], ans: 1, exp: "Respuesta: B" },
            { id: 28, q: "En la Diabetes Tipo 1, el fallo radica en:", options: ["Los receptores de insulina no funcionan.", "Destrucción autoinmune de las células beta, por lo que no se produce insulina.", "Los canales de potasio están mutados.", "Exceso de glucosa en la dieta."], ans: 1, exp: "Respuesta: B" },
            { id: 29, q: "En la Diabetes Tipo 2, el problema principal suele ser:", options: ["Ausencia total de insulina.", "Resistencia a la insulina (fallo en el receptor o señalización) en los tejidos diana.", "Falta de glucosa.", "Exceso de células beta."], ans: 1, exp: "Respuesta: B" },
            { id: 30, q: "Las sulfonilureas (fármacos para diabetes tipo 2) actúan cerrando artificialmente el canal K-ATP. ¿Qué efecto buscan?", options: ["Inhibir la secreción de insulina.", "Despolarizar la célula para estimular la secreción de insulina.", "Hiperpolarizar la célula.", "Matar a la célula beta."], ans: 1, exp: "Respuesta: B" },

            // Bloque 6: Conceptos Generales
            { id: 31, q: "La pinocitosis se diferencia de la endocitosis mediada por receptor en que:", options: ["La pinocitosis es un proceso inespecífico (fase fluida) y constitutivo.", "La pinocitosis solo incorpora sólidos.", "La pinocitosis usa receptores específicos.", "La pinocitosis no gasta energía."], ans: 0, exp: "Respuesta: A" },
            { id: 32, q: "¿Qué proteína corta el cuello de la vesícula recubierta de clatrina para liberarla en el citoplasma (aunque el audio se centra en clatrina, es un detalle molecular clave)?", options: ["Actina.", "Dinamina.", "Miosina.", "Tubulina."], ans: 1, exp: "Respuesta: B" },
            { id: 33, q: "Las balsas lipídicas (lipid rafts) asociadas a caveolas son ricas en:", options: ["Fosfolípidos insaturados.", "Colesterol y esfingolípidos.", "Proteínas contráctiles.", "Agua."], ans: 1, exp: "Respuesta: B" },
            { id: 34, q: "El término \"potocitosis\" se refiere a:", options: ["Beber grandes cantidades de agua.", "Endocitosis mediada por caveolas donde se concentran moléculas pequeñas.", "Muerte celular.", "Exocitosis masiva."], ans: 1, exp: "Respuesta: B" },
            { id: 35, q: "¿Qué proteínas del complejo SNARE son vitales para la fusión de la vesícula con la membrana plasmática (afectadas por la toxina botulínica)?", options: ["Clatrina y Adaptina.", "v-SNARE y t-SNARE.", "Actina y Miosina.", "Tubulina y Kinesina."], ans: 1, exp: "Respuesta: B " },
            { id: 36, q: "La toxina botulínica produce parálisis flácida porque:", options: ["Destruye los receptores de acetilcolina.", "Corta las proteínas SNARE, impidiendo la exocitosis de acetilcolina.", "Abre todos los canales de calcio.", "Inhibe la síntesis de ATP."], ans: 1, exp: "Respuesta: B" },
            { id: 37, q: "El transporte vesicular (endo/exocitosis) se clasifica energéticamente como:", options: ["Transporte pasivo.", "Difusión facilitada.", "Transporte activo (requiere ATP).", "Osmosis."], ans: 2, exp: "Respuesta: C" },
            { id: 38, q: "La membrana plasmática es impermeable a macromoléculas como proteínas. Por tanto, para que una célula secrete una proteína sintetizada, debe usar:", options: ["Difusión simple.", "Canales iónicos.", "Exocitosis.", "Bombas ATPasas."], ans: 2, exp: "Respuesta: C" },
            { id: 39, q: "¿Cuál de los siguientes es un ejemplo de fagocito profesional?", options: ["Fibroblasto.", "Adipocito.", "Neutrófilo.", "Miocito."], ans: 2, exp: "Respuesta: C" },
            { id: 40, q: "En el experimento de Loewi mencionado en el tema de comunicación (relacionado con exocitosis de neurotransmisores), se demostró:", options: ["La naturaleza eléctrica de la sinapsis.", "La naturaleza química de la transmisión sináptica (liberación de sustancias).", "La existencia de canales de voltaje.", "La fagocitosis."], ans: 1, exp: "Respuesta: B" },

            // Bloque 7: Integración y Patología
            { id: 41, q: "Si inhibimos la acidificación del endosoma con una droga, ¿qué proceso se vería afectado en el ciclo de la transferrina?", options: ["La entrada de la vesícula.", "La liberación del hierro de la transferrina.", "La formación de clatrina.", "La fusión con la membrana."], ans: 1, exp: "Respuesta: B" },
            { id: 42, q: "La opsonización es un proceso que facilita la:", options: ["Exocitosis.", "Pinocitosis.", "Fagocitosis (recubriendo al patógeno con anticuerpos/complemento).", "Transcitosis."], ans: 2, exp: "Respuesta: C" },
            { id: 43, q: "¿Qué afirmación es FALSA sobre la endocitosis mediada por receptor?", options: ["Es saturable.", "Es altamente específica.", "Permite captar sustancias que están a baja concentración en el medio.", "Es un proceso pasivo que no requiere energía."], ans: 3, exp: "Respuesta: D" },
            { id: 44, q: "El reciclaje de receptores a la membrana plasmática es un ejemplo de:", options: ["Exocitosis regulada.", "Exocitosis constitutiva.", "Fagocitosis.", "Apoptosis."], ans: 1, exp: "Respuesta: B" },
            { id: 45, q: "¿Qué molécula señalizadora induce la translocación de GLUT4 en el músculo esquelético?", options: ["Adrenalina.", "Glucagón.", "Insulina.", "Acetilcolina."], ans: 2, exp: "Respuesta: C" },
            { id: 46, q: "En la aterosclerosis, las células espumosas se forman por la acumulación excesiva de:", options: ["Glucosa.", "Ésteres de colesterol (provenientes de LDL) en macrófagos.", "Proteínas.", "Hierro."], ans: 1, exp: "Respuesta: B" },
            { id: 47, q: "La \"digestión\" del contenido de un fagosoma ocurre cuando este se fusiona con:", options: ["El Retículo Endoplasmático.", "El Lisosoma.", "La Mitocondria.", "El Núcleo."], ans: 1, exp: "Respuesta: B" },
            { id: 48, q: "¿Qué ventaja tiene la endocitosis mediada por receptor frente a la pinocitosis?", options: ["Es más rápida.", "Permite concentrar ligandos específicos hasta 1000 veces respecto al medio extracelular.", "No gasta membrana.", "No requiere proteínas."], ans: 1, exp: "Respuesta: B" },
            { id: 49, q: "El proceso por el cual una célula recupera la membrana \"gastada\" durante la exocitosis se denomina:", options: ["Exocitosis compensatoria.", "Endocitosis acoplada (reciclaje de membrana).", "Lisis celular.", "Plasmólisis."], ans: 1, exp: "Respuesta: B" },
            { id: 50, q: "¿Cuál es la señal que detiene la actividad de las proteasas lisosomales si se rompe un lisosoma en el citosol (pH 7.2)?", options: ["La falta de ATP.", "El pH neutro del citosol (las enzimas son ácido-dependientes).", "La presencia de inhibidores.", "La temperatura."], ans: 1, exp: "Respuesta: B" }
        ];

        // --- ESTADO ---
        let currentList = [];
        let markedIds = new Set();
        let failedIds = new Set();
        let answeredIds = new Set();
        
        // --- UTILIDADES ---
        const shuffle = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        // --- INICIALIZACIÓN ---
        function initQuiz(mode, customList = null) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('results-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            const container = document.getElementById('main-area');
            const sidebar = document.getElementById('sidebar');
            container.innerHTML = "";
            sidebar.innerHTML = "";
            
            let sourceList = customList ? customList : [...dbQuestions];
            
            if (!customList) {
                markedIds.clear();
                failedIds.clear();
                answeredIds.clear();
            }

            // Clonar y mezclar opciones
            currentList = sourceList.map(q => {
                let optionsObj = q.options.map((txt, idx) => ({ txt, isCorrect: idx === q.ans }));
                return { ...q, shuffledOpts: shuffle(optionsObj) };
            });

            // Ordenar preguntas
            if (mode === 'random') {
                currentList = shuffle(currentList);
            } else {
                currentList.sort((a,b) => a.id - b.id);
            }

            // Renderizar
            currentList.forEach((q, index) => {
                // 1. Sidebar Dot
                const dot = document.createElement('div');
                dot.className = 'nav-dot';
                dot.innerText = q.id;
                dot.id = `dot-${q.id}`;
                dot.onclick = () => document.getElementById(`card-${q.id}`).scrollIntoView();
                if(markedIds.has(q.id)) dot.classList.add('marked');
                sidebar.appendChild(dot);

                // 2. Card
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `card-${q.id}`;

                // Header
                const header = document.createElement('div');
                header.className = 'q-header';
                
                const title = document.createElement('div');
                title.className = 'q-title';
                title.innerText = `${q.id}. ${q.q}`;

                const markLabel = document.createElement('label');
                markLabel.className = 'mark-container';
                const markInput = document.createElement('input');
                markInput.type = 'checkbox';
                markInput.checked = markedIds.has(q.id);
                markInput.onchange = (e) => toggleMark(q.id, e.target.checked);
                
                const markIcon = document.createElement('i');
                markIcon.className = 'mark-icon';
                const markText = document.createElement('span');
                markText.innerText = "Revisar";

                markLabel.append(markInput, markIcon, markText);
                header.append(title, markLabel);

                // Opciones
                const optList = document.createElement('div');
                optList.className = 'options-list';

                q.shuffledOpts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt.txt;
                    btn.onclick = () => handleAnswer(q, opt, btn, card);
                    optList.appendChild(btn);
                });

                // Explicación
                const expBox = document.createElement('div');
                expBox.className = 'explanation';
                
                // Formatear explicación para manejar imágenes
                const explanationText = q.exp;
                let finalHtml = `<div class="explanation-text"><strong>${explanationText}</strong></div>`;
                
                if (explanationText.includes("[Image")) {
                    finalHtml = finalHtml.replace(/\/g, '<div class="diagram-placeholder">Diagrama: $1</div>');
                }

                expBox.innerHTML = finalHtml;
                card.append(header, optList, expBox);
                container.appendChild(card);
            });
        }

        // --- LÓGICA DE RESPUESTA ---
        function handleAnswer(qObj, optObj, btnElem, cardElem) {
            if (btnElem.disabled || cardElem.getAttribute('data-answered') === 'true') return;
            
            cardElem.setAttribute('data-answered', 'true');
            answeredIds.add(qObj.id);
            
            const allBtns = cardElem.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            // Marcar visualmente
            if (optObj.isCorrect) {
                btnElem.classList.add('correct');
                if(failedIds.has(qObj.id)) failedIds.delete(qObj.id);
            } else {
                btnElem.classList.add('wrong');
                failedIds.add(qObj.id);
                // Mostrar correcta
                const correctBtnText = qObj.shuffledOpts.find(o => o.isCorrect).txt;
                allBtns.forEach(b => {
                    if(b.innerText === correctBtnText) b.classList.add('correct');
                });
            }

            // Actualizar Dot
            const dot = document.getElementById(`dot-${qObj.id}`);
            dot.classList.add(optObj.isCorrect ? 'correct' : 'wrong');
            if (markedIds.has(qObj.id)) dot.classList.add('marked');

            // Mostrar explicación
            cardElem.querySelector('.explanation').style.display = 'block';
        }

        function toggleMark(id, isChecked) {
            const dot = document.getElementById(`dot-${id}`);
            if (isChecked) {
                markedIds.add(id);
                dot.classList.add('marked');
            } else {
                markedIds.delete(id);
                dot.classList.remove('marked');
            }
        }

        // --- FINALIZACIÓN ---
        function showResults() {
            const modal = document.getElementById('results-modal');
            const total = currentList.length;
            
            // Calcular aciertos en la sesión actual
            let currentFails = 0;
            let currentCorrect = 0;
            
            currentList.forEach(q => {
               const card = document.getElementById(`card-${q.id}`);
               if (card && card.getAttribute('data-answered') === 'true') {
                   if (card.querySelector('.option-btn.wrong')) currentFails++;
                   else currentCorrect++;
               }
            });

            document.getElementById('res-correct').innerText = currentCorrect;
            document.getElementById('res-wrong').innerText = currentFails;
            
            const answeredCount = currentCorrect + currentFails;
            document.getElementById('res-msg').innerText = `Has respondido ${answeredCount} de ${total} preguntas mostradas.`;

            // Botones de reintento
            const btnFailed = document.getElementById('btn-retry-failed');
            const btnMarked = document.getElementById('btn-retry-marked');
            const btnCombo = document.getElementById('btn-retry-combo');

            btnFailed.disabled = failedIds.size === 0;
            btnMarked.disabled = markedIds.size === 0;
            btnCombo.disabled = (failedIds.size === 0 && markedIds.size === 0);

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('results-modal').classList.add('hidden');
        }

        function restartQuiz(mode) {
            if (mode === 'all') {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('results-modal').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');
                return;
            }

            let idsToFilter = new Set();
            if (mode === 'failed') idsToFilter = failedIds;
            else if (mode === 'marked') idsToFilter = markedIds;
            else if (mode === 'combo') idsToFilter = new Set([...failedIds, ...markedIds]);

            const filteredList = dbQuestions.filter(q => idsToFilter.has(q.id));
            
            if (filteredList.length === 0) {
                alert("No hay preguntas en esta selección.");
                return;
            }

            initQuiz('random', filteredList);
        }

    </script>
</body>
</html>