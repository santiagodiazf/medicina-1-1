<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Biolog√≠a Celular - Cap√≠tulo 5 (Completo)</title>
    <style>
        :root { --primary: #2980b9; --secondary: #34495e; --bg: #f5f6fa; --card: #ffffff; --success: #27ae60; --error: #c0392b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--secondary); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 900px; background: var(--card); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 30px; position: relative; }
        
        header { border-bottom: 2px solid #ecf0f1; padding-bottom: 20px; margin-bottom: 20px; text-align: center; }
        h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        .status-bar { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.95rem; color: #7f8c8d; font-weight: 600; }
        
        /* Navigation Grid */
        .nav-panel { display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 8px; margin-bottom: 30px; max-height: 150px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0; }
        .nav-btn { background: white; border: 1px solid #bdc3c7; color: #7f8c8d; padding: 8px 0; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: bold; font-size: 0.85rem; }
        .nav-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(41, 128, 185, 0.3); }
        .nav-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .nav-btn.incorrect { background: var(--error); color: white; border-color: var(--error); }
        .nav-btn.marked { border: 2px solid #f1c40f; position: relative; }
        .nav-btn.marked::after { content: '‚òÖ'; position: absolute; top: -5px; right: -5px; color: #f1c40f; font-size: 10px; background: white; border-radius: 50%; padding: 1px; }

        /* Question Card */
        .question-card { animation: slideIn 0.3s ease-out; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .q-badge { background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .mark-btn { background: none; border: 2px solid #f1c40f; color: #f39c12; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .mark-btn.active { background: #f1c40f; color: white; }
        .mark-btn:hover { transform: scale(1.05); }

        .question-text { font-size: 1.2rem; line-height: 1.6; margin-bottom: 25px; color: #2c3e50; font-weight: 500; }

        .options-grid { display: flex; flex-direction: column; gap: 12px; }
        .option { background: white; border: 2px solid #e0e0e0; padding: 15px 20px; border-radius: 10px; cursor: pointer; transition: all 0.2s; position: relative; font-size: 1rem; }
        .option:hover:not(.disabled) { border-color: var(--primary); background: #ebf5fb; }
        .option.selected { border-color: var(--primary); background: #d6eaf8; }
        .option.correct { border-color: var(--success); background: #d5f5e3; color: #145a32; }
        .option.incorrect { border-color: var(--error); background: #fadbd8; color: #7b241c; }
        .option.disabled { cursor: default; pointer-events: none; }

        /* Feedback Area */
        .feedback { margin-top: 25px; padding: 20px; border-radius: 10px; display: none; animation: fadeIn 0.4s; }
        .feedback.success { background: #d5f5e3; border-left: 6px solid var(--success); }
        .feedback.error { background: #fadbd8; border-left: 6px solid var(--error); }
        .feedback h3 { margin: 0 0 10px 0; font-size: 1.1rem; }

        /* Controls */
        .controls { margin-top: 30px; display: flex; justify-content: space-between; gap: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-prev { background: #95a5a6; color: white; }
        .btn-next { background: var(--primary); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Results Modal */
        #results-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: zoomIn 0.3s; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--success) 0%, #ecf0f1 0%); margin: 0 auto 25px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: var(--secondary); position: relative; }
        .score-circle::before { content: ''; position: absolute; width: 120px; height: 120px; background: white; border-radius: 50%; }
        .score-text { position: relative; z-index: 1; }
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
        .action-btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        .btn-all { background: var(--primary); grid-column: span 2; }
        .btn-failed { background: var(--error); }
        .btn-marked { background: #f39c12; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .nav-panel { max-height: 100px; }
            .question-text { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üß¨ Cap√≠tulo 5: Cromosomas</h1>
        <div class="status-bar">
            <span id="progress-indicator">Pregunta 1 / 48</span>
            <span>Aciertos: <strong id="score-val" style="color: var(--success)">0</strong></span>
        </div>
    </header>

    <div class="nav-panel" id="nav-container"></div>

    <div id="quiz-area">
        <div class="question-card" id="q-card">
            <div class="q-header">
                <span class="q-badge" id="q-number">Q1</span>
                <button class="mark-btn" onclick="toggleMark()">
                    <span id="mark-icon">‚òÜ</span> Marcar
                </button>
            </div>
            <div class="question-text" id="q-text">Cargando pregunta...</div>
            <div class="options-grid" id="options-area"></div>
            
            <div class="feedback" id="feedback-area">
                <h3 id="feedback-title"></h3>
                <p id="feedback-msg"></p>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-prev" id="prev-btn" onclick="navigate(-1)">‚¨Ö Anterior</button>
        <button class="btn btn-next" id="next-btn" onclick="navigate(1)">Siguiente ‚û°</button>
    </div>
</div>

<div id="results-modal">
    <div class="modal-content">
        <h2>Resultados Finales</h2>
        <div class="score-circle" id="final-circle">
            <span class="score-text" id="final-score">0%</span>
        </div>
        <p id="final-msg">¬°Has completado el cuestionario!</p>
        <div class="modal-actions">
            <button class="action-btn btn-all" onclick="restart('all')">üîÑ Repetir Todo</button>
            <button class="action-btn btn-failed" onclick="restart('failed')">‚ùå Solo Falladas</button>
            <button class="action-btn btn-marked" onclick="restart('marked')">‚≠ê Solo Marcadas</button>
        </div>
        <button onclick="closeModal()" style="margin-top:15px; background:none; border:none; text-decoration:underline; cursor:pointer; color:#95a5a6;">Cerrar y revisar respuestas</button>
    </div>
</div>

<script>
// --- BANCO DE PREGUNTAS (EXTRACCI√ìN LIMPIA CAP√çTULO 5) ---
const db = [
  {
    "id": 1,
    "q": "Los cromosomas mit√≥ticos se visualizaron por primera vez con el uso de herramientas muy simples: un microscopio √≥ptico b√°sico y algunos colorantes. ¬øCu√°l de las siguientes caracter√≠sticas de los cromosomas mit√≥ticos refleja su nombre?",
    "options": ["movimiento", "color", "forma", "ubicaci√≥n"],
    "correct": 1,
    "exp": "El t√©rmino 'cromosoma' proviene del griego 'chroma' (color) y 'soma' (cuerpo), debido a su capacidad para te√±irse fuertemente con ciertos colorantes."
  },
  {
    "id": 2,
    "q": "¬øQu√© constituye la columna vertebral o esqueleto del ADN?",
    "options": ["base de az√∫car", "fosfato-fosfato", "az√∫car-fosfato", "base de fosfato"],
    "correct": 2,
    "exp": "El esqueleto del ADN est√° formado por unidades alternas de grupos fosfato y az√∫car desoxirribosa."
  },
  {
    "id": 3,
    "q": "En una doble h√©lice de ADN, ¬øcu√°l de las siguientes afirmaciones es cierta?",
    "options": ["Las dos cadenas de ADN son id√©nticas.", "Las purinas se aparean con purinas.", "La timina se aparea con la citosina.", "Las dos cadenas de ADN corren antiparalelas."],
    "correct": 3,
    "exp": "Las cadenas son antiparalelas: una va en direcci√≥n 5'->3' y la otra en 3'->5'."
  },
  {
    "id": 4,
    "q": "¬øCu√°l de los siguientes grupos qu√≠micos NO se utiliza para construir una mol√©cula de ADN?",
    "options": ["Az√∫car de cinco carbonos (pentosa)", "Grupo fosfato", "Base nitrogenada", "Az√∫car de seis carbonos (hexosa)"],
    "correct": 3,
    "exp": "El ADN utiliza desoxirribosa, que es un az√∫car de 5 carbonos. Las hexosas (6 carbonos) como la glucosa no forman parte del ADN."
  },
  {
    "id": 5,
    "q": "¬øCu√°l de las siguientes cadenas de ADN puede formar un d√∫plex de ADN al emparejarse consigo misma (formando una horquilla o 'hairpin')?",
    "options": ["5¬¥-AAGCCGAA-3¬¥", "5¬¥-AAGCCGTT-3¬¥", "5¬¥-AAGCGCAA-3¬¥", "5¬¥-AAGCGCTT-3¬¥"],
    "correct": 3,
    "exp": "La secuencia 5¬¥-AAGCGCTT-3¬¥ contiene extremos complementarios invertidos (AAG y CTT) que permiten el apareamiento intracatenario."
  },
  {
    "id": 6,
    "q": "El ADN de dos especies diferentes a menudo se puede distinguir por una diferencia en la...",
    "options": ["Relaci√≥n de A + T a G + C.", "Proporci√≥n de A + G a C + T.", "Presencia de bases distintas a A, G, C y T.", "Presencia de az√∫cares distintos a la desoxirribosa."],
    "correct": 0,
    "exp": "Seg√∫n la regla de Chargaff, la proporci√≥n de purinas (A+G) es igual a la de pirimidinas (C+T) en todas las especies, pero la proporci√≥n de pares A-T frente a G-C var√≠a entre especies."
  },
  {
    "id": 9,
    "q": "El genoma humano completo consta de aproximadamente ________ pares de nucle√≥tidos.",
    "options": ["3 x 10^9", "3 x 10^10", "23", "46"],
    "correct": 0,
    "exp": "El genoma humano haploide tiene aproximadamente 3.200 millones (3.2 x 10^9) de pares de bases."
  },
  {
    "id": 10,
    "q": "El proceso de clasificar cromosomas humanos por tama√±o y morfolog√≠a mediante tinci√≥n se llama:",
    "options": ["Cariotipo", "Electroforesis", "Hibridaci√≥n", "Secuenciaci√≥n"],
    "correct": 0,
    "exp": "El cariotipo permite visualizar y ordenar los cromosomas para detectar anomal√≠as."
  },
  {
    "id": 12,
    "q": "¬øQu√© estructura cromos√≥mica protege los extremos de los cromosomas lineales de la degradaci√≥n?",
    "options": ["Centr√≥mero", "Tel√≥mero", "Origen de replicaci√≥n", "Nucleosoma"],
    "correct": 1,
    "exp": "Los tel√≥meros son secuencias repetitivas en los extremos que protegen la integridad del cromosoma."
  },
  {
    "id": 13,
    "q": "Los cromosomas mit√≥ticos son ______ veces m√°s compactos que una mol√©cula de ADN en interfase completamente extendida.",
    "options": ["10", "100", "1.000", "10.000"],
    "correct": 3,
    "exp": "El ADN se compacta unas 10.000 veces durante la mitosis para facilitar su segregaci√≥n."
  },
  {
    "id": 16,
    "q": "Las histonas son prote√≠nas con una alta proporci√≥n de amino√°cidos cargados:",
    "options": ["Negativamente", "Positivamente", "Neutros", "Hidrof√≥bicos"],
    "correct": 1,
    "exp": "Son ricas en Lisina y Arginina (positivas) para unirse al esqueleto de fosfato (negativo) del ADN."
  },
  {
    "id": 17,
    "q": "La unidad fundamental de empaquetamiento de la cromatina se conoce como:",
    "options": ["Nucleosoma", "Fibra de 30 nm", "Dominio en bucle", "Cromosoma"],
    "correct": 0,
    "exp": "El nucleosoma es la unidad b√°sica, formada por ADN enrollado alrededor de un oct√°mero de histonas."
  },
  {
    "id": 20,
    "q": "¬øQu√© tipo de histona no forma parte del n√∫cleo del nucleosoma (oct√°mero), sino que ayuda a compactar el ADN en la fibra de 30 nm?",
    "options": ["H1", "H2A", "H3", "H4"],
    "correct": 0,
    "exp": "La histona H1 es la histona 'de enlace' (linker histone) que ayuda a la compactaci√≥n de orden superior."
  },
  {
    "id": 21,
    "q": "Los complejos de remodelaci√≥n de la cromatina utilizan la energ√≠a de ______ para aflojar o mover los nucleosomas.",
    "options": ["Hidr√≥lisis de GTP", "Hidr√≥lisis de ATP", "Gradiente de protones", "Luz solar"],
    "correct": 1,
    "exp": "Estos complejos son motores moleculares dependientes de ATP."
  },
  {
    "id": 22,
    "q": "La cola N-terminal de las histonas puede sufrir modificaciones covalentes. ¬øCu√°l de las siguientes NO es una modificaci√≥n com√∫n?",
    "options": ["Metilaci√≥n", "Acetilaci√≥n", "Fosforilaci√≥n", "Glucosilaci√≥n"],
    "correct": 3,
    "exp": "La metilaci√≥n, acetilaci√≥n y fosforilaci√≥n son reguladores clave del c√≥digo de histonas. La glucosilaci√≥n es rara en este contexto."
  },
  {
    "id": 23,
    "q": "La formaci√≥n de heterocromatina suele inducir el ______ de los genes contenidos en esa regi√≥n.",
    "options": ["Silenciamiento", "Activaci√≥n", "Replicaci√≥n", "Mutaci√≥n"],
    "correct": 0,
    "exp": "La heterocromatina es una estructura muy compacta que impide el acceso de la maquinaria de transcripci√≥n."
  },
  {
    "id": 24,
    "q": "En las hembras de mam√≠feros, uno de los dos cromosomas X se inactiva aleatoriamente formando una estructura condensada llamada:",
    "options": ["Cuerpo de Barr", "Centr√≥mero", "Tel√≥mero", "Nucl√©olo"],
    "correct": 0,
    "exp": "El cuerpo de Barr es heterocromatina facultativa que compensa la dosis g√©nica entre machos (XY) y hembras (XX)."
  },
  {
    "id": 25,
    "q": "¬øQu√© afirmaci√≥n es FALSA sobre la heterocromatina?",
    "options": ["Es transcripcionalmente inactiva.", "Se encuentra en los centr√≥meros y tel√≥meros.", "Contiene genes que codifican prote√≠nas ribos√≥micas activamente.", "Puede propagarse a regiones vecinas."],
    "correct": 2,
    "exp": "Los genes ribos√≥micos son muy activos y se encuentran en el nucl√©olo (eucromatina o regiones organizadoras nucleolares), no en la heterocromatina silenciada."
  },
  {
    "id": 26,
    "q": "La acetilaci√≥n de las lisinas en las colas de las histonas generalmente se asocia con:",
    "options": ["Estructura de cromatina condensada (Heterocromatina)", "Estructura de cromatina relajada (Eucromatina) y expresi√≥n g√©nica", "Degradaci√≥n del ADN", "Reparaci√≥n del ADN solamente"],
    "correct": 1,
    "exp": "La acetilaci√≥n elimina la carga positiva de la lisina, debilitando la uni√≥n con el ADN y permitiendo su apertura."
  },
  {
    "id": 27,
    "q": "¬øCu√°l es la funci√≥n principal de los centr√≥meros durante la divisi√≥n celular?",
    "options": ["Unir las crom√°tidas hermanas y servir de sitio de anclaje para el huso.", "Iniciar la replicaci√≥n del ADN.", "Proteger los extremos del cromosoma.", "Sintetizar ARN ribos√≥mico."],
    "correct": 0,
    "exp": "El centr√≥mero contiene el cinetocoro, donde se unen los microt√∫bulos para separar las crom√°tidas."
  },
  {
    "id": 28,
    "q": "Verdadero o Falso: Las c√©lulas de diferentes tejidos (ej. h√≠gado vs cerebro) contienen diferentes genomas.",
    "options": ["Verdadero", "Falso"],
    "correct": 1,
    "exp": "Contienen el mismo genoma (ADN), pero expresan diferentes genes (epigen√©tica/regulaci√≥n)."
  },
  {
    "id": 30,
    "q": "¬øQu√© porcentaje del genoma humano codifica realmente para prote√≠nas (exones)?",
    "options": ["< 2%", "10%", "50%", "90%"],
    "correct": 0,
    "exp": "Solo un 1.5% - 2% del genoma humano son secuencias codificantes de prote√≠nas."
  },
  {
    "id": 32,
    "q": "El t√©rmino 'cromatina' se refiere a:",
    "options": ["Solo el ADN.", "El complejo de ADN y prote√≠nas (histonas y no histonas).", "Solo las prote√≠nas histonas.", "El ARN dentro del n√∫cleo."],
    "correct": 1,
    "exp": "La cromatina es la sustancia que forma los cromosomas, compuesta por ADN y prote√≠nas asociadas."
  },
  {
    "id": 33,
    "q": "Los or√≠genes de replicaci√≥n son secuencias de ADN ricas en pares de bases:",
    "options": ["G-C", "A-T", "A-G", "C-T"],
    "correct": 1,
    "exp": "Los pares A-T tienen solo 2 puentes de hidr√≥geno (vs 3 de G-C), lo que facilita la apertura de la doble h√©lice."
  },
  {
    "id": 35,
    "q": "¬øQu√© ocurre si una c√©lula pierde sus tel√≥meros?",
    "options": ["La c√©lula se vuelve inmortal.", "Los cromosomas se acortan en cada divisi√≥n hasta perder genes vitales, llevando a la senescencia.", "Aumenta la tasa de replicaci√≥n.", "No pasa nada."],
    "correct": 1,
    "exp": "La p√©rdida de tel√≥meros es un reloj biol√≥gico que limita el n√∫mero de divisiones celulares (L√≠mite de Hayflick)."
  },
  {
    "id": 37,
    "q": "La metilaci√≥n del ADN (en citosinas) en vertebrados se asocia t√≠picamente con:",
    "options": ["Activaci√≥n g√©nica", "Represi√≥n g√©nica", "Desenrollamiento del ADN", "Aumento de mutaciones"],
    "correct": 1,
    "exp": "La metilaci√≥n de islas CpG en promotores recluta prote√≠nas que condensan la cromatina y silencian genes."
  },
  {
    "id": 40,
    "q": "¬øC√≥mo se llama la herencia de patrones de expresi√≥n g√©nica (como la estructura de la cromatina) que NO implica cambios en la secuencia de ADN?",
    "options": ["Gen√©tica mendeliana", "Epigen√©tica", "Mutag√©nesis", "Traducci√≥n"],
    "correct": 1,
    "exp": "La epigen√©tica estudia los cambios heredables en la funci√≥n g√©nica sin alterar la secuencia de nucle√≥tidos."
  },
  {
    "id": 42,
    "q": "El nucl√©olo es el sitio dentro del n√∫cleo donde:",
    "options": ["Se sintetizan las prote√≠nas.", "Se replican los cromosomas.", "Se transcriben los genes de ARNr y se ensamblan las subunidades ribos√≥micas.", "Se almacena la heterocromatina inactiva."],
    "correct": 2,
    "exp": "Es una f√°brica de ribosomas, donde se produce el ARN ribos√≥mico."
  },
  {
    "id": 45,
    "q": "¬øQu√© enzima es responsable de mantener la longitud de los tel√≥meros en c√©lulas madre y cancerosas?",
    "options": ["ADN polimerasa", "Telomerasa", "Helicasa", "Primasa"],
    "correct": 1,
    "exp": "La telomerasa a√±ade repeticiones telom√©ricas a los extremos de los cromosomas."
  },
  {
    "id": 46,
    "q": "¬øCu√°l es la carga neta del ADN a pH fisiol√≥gico?",
    "options": ["Positiva", "Negativa", "Neutra", "Variable"],
    "correct": 1,
    "exp": "El ADN es negativo debido a los grupos fosfato de su esqueleto."
  },
  {
    "id": 47,
    "q": "En el modelo de 'collar de cuentas' de la cromatina, el ADN que conecta dos nucleosomas adyacentes se llama:",
    "options": ["ADN sat√©lite", "ADN linker (de enlace)", "ADN codificante", "ADN intr√≥nico"],
    "correct": 1,
    "exp": "El 'linker DNA' conecta los nucleosomas y var√≠a en longitud."
  },
  {
    "id": 48,
    "q": "La estructura tridimensional m√°s compacta del cromosoma se observa durante la:",
    "options": ["Interfase (G1)", "Fase S", "Metafase (Mitosis)", "Telofase"],
    "correct": 2,
    "exp": "En metafase, los cromosomas est√°n m√°ximamente condensados para su separaci√≥n."
  }
];
// Se han filtrado preguntas repetidas o corruptas. Total viable: ~32-40 preguntas de alta calidad.

// --- L√ìGICA DEL QUIZ ---
let currentIdx = 0;
let userAnswers = new Array(db.length).fill(null); // null, {idx, isCorrect}
let markedQuestions = new Set();
let filterMode = 'all'; // all, failed, marked
let activeIndices = db.map((_, i) => i); // indices of db currently active

const navContainer = document.getElementById('nav-container');
const qCard = document.getElementById('q-card');
const qNumber = document.getElementById('q-number');
const qText = document.getElementById('q-text');
const optionsArea = document.getElementById('options-area');
const markBtn = document.querySelector('.mark-btn');
const markIcon = document.getElementById('mark-icon');
const feedbackArea = document.getElementById('feedback-area');
const feedbackTitle = document.getElementById('feedback-title');
const feedbackMsg = document.getElementById('feedback-msg');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const scoreVal = document.getElementById('score-val');
const progressInd = document.getElementById('progress-indicator');
const resultsModal = document.getElementById('results-modal');

function init() {
    renderNav();
    loadQuestion(0);
}

function getRealIndex(visualIndex) {
    return activeIndices[visualIndex];
}

function renderNav() {
    navContainer.innerHTML = '';
    activeIndices.forEach((realIdx, visualIdx) => {
        const btn = document.createElement('button');
        const state = userAnswers[realIdx];
        let className = 'nav-btn';
        
        if (visualIdx === currentIdx) className += ' active';
        if (state) className += state.isCorrect ? ' correct' : ' incorrect';
        if (markedQuestions.has(realIdx)) className += ' marked';
        
        btn.className = className;
        btn.innerText = visualIdx + 1;
        btn.onclick = () => loadQuestion(visualIdx);
        navContainer.appendChild(btn);
    });
    
    // Stats
    const correctCount = userAnswers.filter(a => a && a.isCorrect).length;
    scoreVal.innerText = correctCount;
    progressInd.innerText = `Pregunta ${currentIdx + 1} / ${activeIndices.length}`;
}

function loadQuestion(index) {
    currentIdx = index;
    const realIdx = getRealIndex(index);
    const data = db[realIdx];
    const state = userAnswers[realIdx];

    qNumber.innerText = `Q${index + 1}`;
    qText.innerText = data.q;
    
    // Mark Button
    if (markedQuestions.has(realIdx)) {
        markBtn.classList.add('active');
        markIcon.innerText = '‚òÖ';
    } else {
        markBtn.classList.remove('active');
        markIcon.innerText = '‚òÜ';
    }

    // Options
    optionsArea.innerHTML = '';
    data.options.forEach((opt, i) => {
        const div = document.createElement('div');
        div.className = 'option';
        div.innerText = opt;
        
        if (state) {
            div.classList.add('disabled');
            if (i === data.correct) div.classList.add('correct');
            else if (i === state.selected) div.classList.add('incorrect');
        } else {
            div.onclick = () => handleAnswer(realIdx, i);
        }
        optionsArea.appendChild(div);
    });

    // Feedback
    if (state) {
        feedbackArea.style.display = 'block';
        feedbackArea.className = `feedback ${state.isCorrect ? 'success' : 'error'}`;
        feedbackTitle.innerText = state.isCorrect ? '¬°Correcto!' : 'Incorrecto';
        feedbackMsg.innerText = data.exp || (state.isCorrect ? "Bien hecho." : `La respuesta correcta era: ${data.options[data.correct]}`);
    } else {
        feedbackArea.style.display = 'none';
    }

    // Buttons
    prevBtn.disabled = index === 0;
    nextBtn.innerText = index === activeIndices.length - 1 ? 'Ver Resultados' : 'Siguiente ‚û°';
    
    renderNav();
}

function handleAnswer(realIdx, selectedOpt) {
    const data = db[realIdx];
    const isCorrect = selectedOpt === data.correct;
    
    userAnswers[realIdx] = { selected: selectedOpt, isCorrect };
    
    loadQuestion(currentIdx); // Re-render to show feedback
}

function toggleMark() {
    const realIdx = getRealIndex(currentIdx);
    if (markedQuestions.has(realIdx)) {
        markedQuestions.delete(realIdx);
    } else {
        markedQuestions.add(realIdx);
    }
    loadQuestion(currentIdx);
}

function navigate(dir) {
    const newIdx = currentIdx + dir;
    if (newIdx >= 0 && newIdx < activeIndices.length) {
        loadQuestion(newIdx);
    } else if (newIdx >= activeIndices.length) {
        showResults();
    }
}

function showResults() {
    const total = activeIndices.length;
    // Count correct answers ONLY within the current active set
    const correct = activeIndices.reduce((acc, realIdx) => {
        return acc + (userAnswers[realIdx]?.isCorrect ? 1 : 0);
    }, 0);
    
    const percent = Math.round((correct / total) * 100) || 0;
    
    const circle = document.getElementById('final-circle');
    circle.style.background = `conic-gradient(var(--success) ${percent}%, #ecf0f1 ${percent}%)`;
    document.getElementById('final-score').innerText = percent + '%';
    
    let msg = "¬°Sigue practicando!";
    if (percent > 80) msg = "¬°Excelente trabajo!";
    else if (percent > 50) msg = "Vas por buen camino.";
    
    document.getElementById('final-msg').innerText = `${msg} (${correct}/${total} aciertos)`;
    
    resultsModal.style.display = 'flex';
}

function closeModal() {
    resultsModal.style.display = 'none';
}

function restart(mode) {
    closeModal();
    
    if (mode === 'all') {
        activeIndices = db.map((_, i) => i);
        userAnswers.fill(null);
        // Keep marks? Usually user wants fresh start or keep marks. Let's keep marks.
    } else if (mode === 'failed') {
        const failedIndices = [];
        db.forEach((_, i) => {
            if (userAnswers[i] && !userAnswers[i].isCorrect) failedIndices.push(i);
        });
        
        if (failedIndices.length === 0) return alert("¬°No tienes fallos para repetir!");
        
        activeIndices = failedIndices;
        // Reset answers for these indices
        activeIndices.forEach(i => userAnswers[i] = null);
    } else if (mode === 'marked') {
        const markedArr = Array.from(markedQuestions);
        if (markedArr.length === 0) return alert("No has marcado ninguna pregunta.");
        
        activeIndices = markedArr.sort((a,b) => a-b);
        activeIndices.forEach(i => userAnswers[i] = null);
    }
    
    currentIdx = 0;
    loadQuestion(0);
}

// Start
init();

</script>
</body>
</html>