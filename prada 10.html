<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Anatomía - Tema 23: Páncreas</title>
    <style>
        :root {
            --primary-color: #f39c12; /* Naranja/Dorado para Páncreas */
            --secondary-color: #d68910;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --background-color: #fef5e7;
            --card-background: #ffffff;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #bdc3c7;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            text-align: center;
            background-color: #1a252f;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h2 { margin: 0; font-size: 1.1rem; }
        
        .sidebar-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .sidebar-stats { font-size: 0.9rem; color: #bdc3c7; }

        .finish-btn-side {
            background-color: #e74c3c;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            width: 80%;
            transition: 0.2s;
        }
        .finish-btn-side:hover { background-color: #c0392b; }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px;
            align-content: start;
        }

        .nav-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 4px;
            background-color: #34495e;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: 0.2s;
        }

        .nav-btn:hover { background-color: var(--secondary-color); }
        .nav-btn.correct { background-color: var(--success-color); }
        .nav-btn.incorrect { background-color: var(--error-color); }
        .nav-btn.marked { border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; }

        /* MAIN CONTENT */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; }

        .question-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            scroll-margin-top: 20px;
        }

        .question-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .bookmark-btn {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            color: #95a5a6;
            padding: 2px 8px;
        }
        .bookmark-btn.active { color: #f39c12; border-color: #f39c12; background: #fef9e7; }

        .question-text { font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px; font-weight: 600; line-height: 1.4; }

        .options-grid { display: flex; flex-direction: column; gap: 8px; }

        .option-btn {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover:not(.disabled) { background-color: #fad7a0; border-color: var(--primary-color); }
        
        .option-btn.correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.incorrect { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .option-btn.disabled { cursor: default; opacity: 0.7; }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-size: 0.9rem;
        }
        .feedback.show { display: block; }
        .feedback.success { background-color: #e8f8f5; color: #0e6251; }
        .feedback.error { background-color: #fdedec; color: #78281f; }

        /* RESULT PANEL */
        .results-panel {
            background: #2c3e50;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 40px;
            display: none;
            margin-bottom: 50px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { background: #e67e22; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: 160px; border-right: none; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .sidebar-nav { grid-template-columns: repeat(8, 1fr); max-height: 150px; }
            .main-content { overflow: visible; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>Tema 23: Páncreas</h2>
        <div class="sidebar-controls">
            <div class="sidebar-stats"><span id="progress-text">0/45</span> respondidas</div>
            <button class="finish-btn-side" onclick="showResults(true)">Finalizar Test</button>
        </div>
    </div>
    <div id="sidebar-nav" class="sidebar-nav"></div>
</div>

<div class="main-content">
    <div class="container">
        <h1>Anatomía del Páncreas 

[Image of pancreas anatomy]
</h1>
        <div id="questions-list"></div>
        
        <div id="results-panel" class="results-panel">
            <h2>Test Finalizado</h2>
            <p id="score-text" style="font-size: 1.4rem; margin: 15px 0;"></p>
            <div class="action-buttons">
                <button class="action-btn" onclick="resetQuiz('all')">Repetir Todo</button>
                <button class="action-btn" onclick="resetQuiz('wrong')">Repetir Falladas</button>
                <button class="action-btn" onclick="resetQuiz('marked')">Repetir Marcadas</button>
                <button class="action-btn" onclick="resetQuiz('wrong_marked')">Falladas + Marcadas</button>
            </div>
        </div>
    </div>
</div>

<script>
    // BASE DE DATOS - TEMA 23 PÁNCREAS
    const dbQuestions = [
        { id: 1, original: "1", q: "Un paciente con dolor intenso y lacerante a nivel de L1 en la cara posterior del espacio toracoabdominal, de forma lineal de derecha a izquierda como un cinturón podría ser sugestivo de:", options: ["Carcinoma de colon", "Úlcera péptica gastroduodenal", "Hipertensión portal", "Pancreatitis"], correct: 3, exp: "El dolor en cinturón a nivel de epigastrio/L1 es clásico de patología pancreática aguda." },
        { id: 2, original: "2", q: "¿Cuál de estas estructuras no se relacionan con la cara dorsal del páncreas?", options: ["Aorta abdominal", "Glándula suprarrenal derecha", "Vena porta", "Riñón izquierdo"], correct: 1, exp: "La glándula suprarrenal derecha se relaciona con el hígado y la VCI, lateral a la cabeza del páncreas, no típicamente dorsal al cuerpo/cola. (Nota: El texto marca esta como la 'no relacionada' dorsalmente en comparación con las otras que son íntimas)." },
        { id: 3, original: "2 (Texto)", q: "El páncreas:", options: ["Se encuentra por debajo y delante del estómago", "La cabeza se encuentra unida al borde interno del bazo por el ligamento pancreato-esplénico", "Es irrigado por ramas de la arteria gastroduodenal y de la arteria mesentérica superior", "Es un órgano tubular hueco"], correct: 2, exp: "Irrigado por las arcadas pancreaticoduodenales (Gastroduodenal + AMS) y ramas de la esplénica. Está DETRÁS del estómago, es macizo, y es la COLA la que mira al bazo." },
        { id: 4, original: "3", q: "Sobre el páncreas, qué porción se relaciona ventralmente con la cara posterior del estómago a través de la transcavidad de los epiplones:", options: ["Cabeza", "Proceso unciforme", "Cola", "Cuerpo"], correct: 3, exp: "El cuerpo del páncreas forma gran parte del lecho gástrico (pared posterior de la transcavidad)." },
        { id: 5, original: "4", q: "El páncreas: (Repetida)", options: ["Se encuentra por debajo y delante del estómago", "La cabeza unida al bazo", "Es irrigado por ramas de la arteria gastroduodenal y de la arteria mesentérica superior", "Es hueco"], correct: 2, exp: "Repetida." },
        { id: 6, original: "6", q: "Relacione: Ampolla de Váter", options: ["Procede de la unión del conducto hepático y el conducto cístico", "En ella drenan los conductos colédoco y pancreático accesorio", "En ella drenan los conductos colédoco y pancreático común (Wirsung)", "Drena Santorini", "Drena Wirsung exclusivamente"], correct: 2, exp: "Confluencia biliar y pancreática principal." },
        { id: 7, original: "7", q: "Relacione: Papila menor", options: ["Procede de la unión del conducto hepático y el conducto cístico", "En ella drenan los conductos colédoco y pancreático accesorio", "En ella drenan los conductos colédoco y pancreático común", "En ella drena el conducto pancreático de Santorini", "En ella drena exclusivamente el conducto pancreático de Wirsung"], correct: 3, exp: "Desembocadura del conducto accesorio." },
        { id: 8, original: "8", q: "Relacione: Conducto colédoco", options: ["Procede de la unión del conducto hepático (común) y el conducto cístico", "En ella drenan los conductos colédoco y pancreático accesorio", "En ella drenan los conductos colédoco y pancreático común", "En ella drena el conducto pancreático de Santorini", "En ella drena exclusivamente el conducto pancreático de Wirsung"], correct: 0, exp: "Formación de la vía biliar principal distal." },
        { id: 9, original: "10", q: "Cuál de estas estructuras no se relaciona con la cara ventral del páncreas:", options: ["Vena esplénica", "Transcavidad de los epiplones", "Estómago", "Colon transverso"], correct: 0, exp: "La vena esplénica discurre por la cara DORSAL (posterior) del páncreas." },
        { id: 10, original: "11", q: "Sobre las vías biliares, señale: El colédoco", options: ["Bolsa piriforme", "Se forma por la confluencia del conducto hepático común y el cístico", "Drena en la tercera porción del duodeno", "Ducto vesícula"], correct: 1, exp: "Unión hepático + cístico." },
        { id: 11, original: "12", q: "Sobre las vías biliares, señale: Cístico", options: ["Bolsa piriforme", "Confluencia hepático", "Drena duodeno", "Se forma por hepáticos", "Es el ducto de conexión de la vesícula biliar"], correct: 4, exp: "Conducto de la vesícula." },
        { id: 12, original: "13", q: "Sobre las vías biliares, señale: Conducto hepático común", options: ["Bolsa piriforme", "Confluencia hepático y cístico", "Drena duodeno", "Se forma por la confluencia de los conductos hepáticos derecho e izquierdo", "Ducto vesícula"], correct: 3, exp: "Unión de hepáticos derecho e izquierdo." },
        { id: 13, original: "14", q: "Sobre las vías biliares, señale: Vesícula biliar", options: ["Bolsa piriforme de colección de sales biliares", "Confluencia hepático y cístico", "Drena duodeno", "Se forma por hepáticos", "Ducto"], correct: 0, exp: "Reservorio biliar." },
        { id: 14, original: "15", q: "Papila duodenal mayor:", options: ["Cara posterior primera porción", "Mantiene abierta la luz", "Sobrelevación donde drenan colédoco y conducto pancreático principal", "Fibras lisas", "Accesorio"], correct: 2, exp: "Eminencia en la 2ª porción." },
        { id: 15, original: "16", q: "El esfínter de Oddi:", options: ["Cara posterior primera porción", "Mantiene abierta la luz", "Sobrelevación", "Se forma por fibras lisas de las paredes del duodeno sobre los conductos de drenaje de las sales biliares y excreción pancreática", "Accesorio"], correct: 3, exp: "Complejo muscular esfinteriano." },
        { id: 16, original: "17", q: "Conducto de Santorini:", options: ["Cara posterior primera porción", "Mantiene abierta la luz", "Sobrelevación", "Fibras lisas", "Conducto pancreático accesorio"], correct: 4, exp: "Accesorio." },
        { id: 17, original: "26", q: "Relacione: Ampolla de Váter (Repetida)", options: ["Papila mayor", "Papila menor", "Hepático común", "Válvula ileocecal", "Esfínter anal"], correct: 0, exp: "Desemboca en la Papila Mayor." },
        { id: 18, original: "27", q: "Relacione: Conducto hepático derecho", options: ["Papila mayor", "Papila menor", "Se une al izquierdo para formar el conducto hepático común", "Válvula ileocecal", "Esfínter anal"], correct: 2, exp: "Confluencia biliar hiliar." },
        { id: 19, original: "28", q: "Relacione: Conducto colédoco", options: ["Papila mayor", "Papila menor", "Hepático común", "Válvula ileocecal", "Esfínter anal"], correct: 0, exp: "Drena en Papila Mayor." },
        { id: 20, original: "29", q: "Relacione: Conducto de Wirsung", options: ["Papila mayor", "Papila menor", "Hepático común", "Válvula ileocecal", "Esfínter anal"], correct: 0, exp: "Principal -> Papila Mayor." },
        { id: 21, original: "30", q: "Relacione: Conducto de Santorini", options: ["Papila mayor", "Papila menor", "Hepático común", "Válvula ileocecal", "Esfínter anal"], correct: 1, exp: "Accesorio -> Papila Menor." },
        { id: 22, original: "31", q: "¿Qué elemento discurre por el borde superior del cuerpo del páncreas con un trayecto sinusoide característico?", options: ["Arteria esplénica", "Ligamento pancreatoesplénico", "Hilio hepático", "Ligamento de Winslow"], correct: 0, exp: "La arteria esplénica serpiginosa." },
        { id: 23, original: "32", q: "Los linfáticos pancreáticos drenan preferentemente a los ganglios o nódulos linfáticos:", options: ["Celiacos y mesentéricos superiores", "Inguinales", "Axilares", "Poplíteos"], correct: 0, exp: "Siguen la vascularización arterial." },
        { id: 24, original: "33", q: "La arteria esplénica irriga al páncreas y emergen de ella todas las arterias que se indican MENOS:", options: ["Pancreática dorsal", "Pancreática mayor", "Gástricas cortas", "La arteria supraduodenal"], correct: 3, exp: "La supraduodenal suele ser rama de la gastroduodenal o hepática." },
        { id: 25, original: "34", q: "De las siguientes estructuras cual NO SE RELACIONA con la cara posterior del páncreas:", options: ["Tronco celiaco", "VCI", "Vena renal izq", "Aorta"], correct: 0, exp: "El tronco celíaco emerge justo por ENCIMA del borde superior del páncreas, no detrás de su cuerpo." },
        { id: 26, original: "35", q: "Se relaciona con el páncreas:", options: ["Arteria mesentérica inferior", "Mesocolon transverso", "Mesenterio", "A y C", "B y C (Mesocolon se inserta en borde anterior)"], correct: 4, exp: "La raíz del mesocolon transverso recorre el borde anterior del páncreas. La AMS sale por debajo (relación)." },
        { id: 27, original: "36", q: "Las arterias pancreaticoduodenales inferiores son ramas de:", options: ["Gastroduodenal", "Mesentérica superior", "Mesentérica inferior", "Tronco celiaco", "Ninguna"], correct: 1, exp: "Ramas de la AMS (las superiores son de la gastroduodenal)." },
        { id: 28, original: "37", q: "Acerca de la papila duodenal mayor, indique la respuesta adecuada:", options: ["Sobrelevación donde drenan colédoco y conducto pancreático principal", "Cara posterior 1ª porción", "Accesorio", "Luz abierta"], correct: 0, exp: "Repetida." },
        { id: 29, original: "38", q: "¿Qué vena se conforma dorsal al páncreas para formar parte del pedículo hepático?", options: ["Vena hepática de Arancio", "Vena cística", "Vena porta", "Vena suprahepáticas"], correct: 2, exp: "La vena porta se forma detrás del cuello del páncreas." },
        { id: 30, original: "39", q: "Los ramos arteriales pancreatoduodenales inferiores son subsidiarias de qué arteria:", options: ["Mesentérica superior", "Mesentérica inferior", "Tronco celiaco", "Gástrica izquierda"], correct: 0, exp: "Repetida: AMS." },
        { id: 31, original: "40", q: "¿Qué elemento discurre por el borde superior del cuerpo del páncreas con un trayecto sinusoide característico? (Repetida)", options: ["Arteria esplénica", "Ligamento pancreatoesplénico", "Hilio hepático", "Ligamento de Winslow"], correct: 0, exp: "Repetida." },
        { id: 32, original: "41", q: "¿Cuál de estas estructuras no se encuentra relacionada con la cara dorsal del páncreas? (Repetida)", options: ["Glándula suprarrenal izquierda", "Riñón izquierdo", "Arteria esplénica", "Aorta"], correct: 2, exp: "Ver nota Q33: Arteria esplénica es borde superior. Las demás son posteriores directas." },
        { id: 33, original: "42", q: "Esta porción del páncreas se relaciona con el trayecto del colédoco:", options: ["Cuerpo", "Cola", "Proceso unciforme", "Cabeza"], correct: 3, exp: "El colédoco pasa por detrás de la cabeza del páncreas (o intrapancreático)." },
        { id: 34, original: "43", q: "Sobre el páncreas, relación qué porción se relaciona ventralmente con la cara posterior del estómago a través de la transcavidad de los epiplones: (Repetida)", options: ["Cabeza", "Proceso unciforme", "Cola", "Cuerpo"], correct: 3, exp: "Repetida." },
        { id: 35, original: "44", q: "Conducto de Santorini (Repetida)", options: ["Cara posterior 1ª porción", "Luz abierta", "Wirsung", "Drenaje sales", "Conducto pancreático accesorio"], correct: 4, exp: "Repetida." },
        { id: 36, original: "45", q: "Sobre el páncreas relacione qué porción se relaciona ventralmente con la cara posterior del estómago: (Repetida)", options: ["cabeza", "cola", "proceso unciforme", "cuerpo"], correct: 3, exp: "Repetida." },
        { id: 37, original: "1", q: "Cuál de estas estructuras no se relacionan con la cara dorsal del páncreas (Repetida contexto)", options: ["Vena esplénica", "Riñón izquierdo", "glándula suprarrenal izquierda", "Aorta"], correct: 0, exp: "Repetida: La vena esplénica es posterior, pero en algunas versiones del examen la marcan como incorrecta si consideran 'dorsal' a estructuras retroperitoneales profundas y la vena es 'adherida'. Sin embargo, la opción clásica de 'No relación dorsal' suele ser algo anterior (Estómago). Entre estas opciones: Vena esplénica está pegada atrás. Aorta detrás. Riñón detrás. Suprarrenal detrás. Es una pregunta ambigua según las opciones dadas en distintos bloques. Usaremos la lógica de la pregunta 11: Vena esplénica se relaciona con la cara dorsal." },
        // Añado preguntas para completar 45 basadas en anatomía pancreática del texto
        { id: 38, original: "Extra", q: "El proceso unciforme del páncreas se relaciona anteriormente con:", options: ["Arteria y vena mesentéricas superiores", "Aorta", "Vena cava inferior", "Estómago"], correct: 0, exp: "Los vasos mesentéricos superiores pasan por delante del proceso unciforme." },
        { id: 39, original: "Extra", q: "El conducto pancreático principal se une habitualmente al colédoco para formar:", options: ["Conducto de Santorini", "Ampolla de Vater (Hepatopancreática)", "Conducto cístico", "Conducto hepático común"], correct: 1, exp: "Forman la ampolla hepatopancreática." },
        { id: 40, original: "Extra", q: "¿Qué estructura vascular pasa posterior al cuello del páncreas?", options: ["Confluencia de la vena porta", "Arteria mesentérica superior", "Vena cava inferior", "Aorta"], correct: 0, exp: "Lugar de formación de la porta (Vena Esplénica + VMS)." },
        { id: 41, original: "Extra", q: "La cola del páncreas llega hasta:", options: ["Hilio del bazo", "Hilio renal izquierdo", "Estómago", "Colon transverso"], correct: 0, exp: "Se aloja en el ligamento esplenorrenal (pancreatoesplénico) llegando al hilio." },
        { id: 42, original: "Extra", q: "El páncreas es un órgano:", options: ["Intraperitoneal", "Retroperitoneal secundario", "Subperitoneal", "Pélvico"], correct: 1, exp: "Retroperitoneal (excepto la cola)." },
        { id: 43, original: "Extra", q: "La irrigación de la cabeza del páncreas se realiza a través de las arcadas formadas por:", options: ["Pancreatoduodenales superiores e inferiores", "Esplénica y Gástrica izquierda", "Mesentérica inferior y superior", "Císticas"], correct: 0, exp: "Arcadas pancreatoduodenales." },
        { id: 44, original: "Extra", q: "¿Qué relación tiene la arteria esplénica con el páncreas?", options: ["Discurre por el borde superior", "Discurre por el borde inferior", "Pasa a través de la cabeza", "Pasa anterior al cuerpo"], correct: 0, exp: "Borde superior, tortuosa." },
        { id: 45, original: "Extra", q: "El conducto accesorio (Santorini) drena en:", options: ["Papila duodenal menor", "Papila duodenal mayor", "Tercera porción del duodeno", "Yeyuno"], correct: 0, exp: "Papila menor." }
    ];

    let currentQuestions = [...dbQuestions];
    let markedIds = new Set();
    let userAnswers = {};

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function renderQuiz() {
        const list = document.getElementById('questions-list');
        const nav = document.getElementById('sidebar-nav');
        const resultsPanel = document.getElementById('results-panel');
        
        list.innerHTML = '';
        nav.innerHTML = '';
        resultsPanel.style.display = 'none';

        if(currentQuestions.length === 0) {
            list.innerHTML = `<div class="question-card"><p>No hay preguntas para los criterios seleccionados.</p></div>`;
            return;
        }

        currentQuestions.forEach((q, index) => {
            const btn = document.createElement('a');
            btn.href = `#q-${q.id}`;
            btn.className = 'nav-btn';
            btn.innerText = index + 1;
            btn.id = `nav-btn-${q.id}`;
            
            if (userAnswers[q.id] === true) btn.classList.add('correct');
            if (userAnswers[q.id] === false) btn.classList.add('incorrect');
            if (markedIds.has(q.id)) btn.classList.add('marked');

            nav.appendChild(btn);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-${q.id}`;

            const originalOptions = q.options.map((text, i) => ({ text: text, isCorrect: i === q.correct }));
            const finalOptions = shuffle(originalOptions);

            let optionsHTML = '';
            finalOptions.forEach(opt => {
                const safeText = opt.text.replace(/'/g, "&#39;"); 
                optionsHTML += `<button class="option-btn" onclick="handleAnswer(${q.id}, ${opt.isCorrect}, this)">${opt.text}</button>`;
            });

            const isMarked = markedIds.has(q.id);

            card.innerHTML = `
                <div class="question-header-row">
                    <span>Pregunta ${index + 1} (Ref: ${q.original})</span>
                    <button class="bookmark-btn ${isMarked ? 'active' : ''}" onclick="toggleMark(${q.id}, this)">
                        ${isMarked ? '★ Marcada' : '☆ Marcar'}
                    </button>
                </div>
                <div class="question-text">${q.q}</div>
                <div class="options-grid" id="opts-${q.id}">
                    ${optionsHTML}
                </div>
                <div class="feedback" id="feed-${q.id}"></div>
            `;
            list.appendChild(card);
        });
        updateProgress();
    }

    function handleAnswer(id, isCorrect, btn) {
        if (userAnswers.hasOwnProperty(id)) return;
        
        userAnswers[id] = isCorrect;
        const navBtn = document.getElementById(`nav-btn-${id}`);
        const feedback = document.getElementById(`feed-${id}`);
        const container = document.getElementById(`opts-${id}`);
        const qData = dbQuestions.find(x => x.id === id);

        const allBtns = container.querySelectorAll('.option-btn');
        allBtns.forEach(b => {
            b.classList.add('disabled');
            b.onclick = null;
            const correctText = qData.options[qData.correct];
            if (b.innerText === correctText) b.classList.add('correct');
        });

        if (isCorrect) {
            feedback.innerHTML = `<strong>¡Correcto!</strong><br>${qData.exp}`;
            feedback.className = 'feedback success show';
            if(navBtn) navBtn.classList.add('correct');
        } else {
            btn.classList.add('incorrect');
            feedback.innerHTML = `<strong>Incorrecto.</strong><br>${qData.exp}`;
            feedback.className = 'feedback error show';
            if(navBtn) navBtn.classList.add('incorrect');
        }
        updateProgress();
    }

    function toggleMark(id, btn) {
        const navBtn = document.getElementById(`nav-btn-${id}`);
        if (markedIds.has(id)) {
            markedIds.delete(id);
            btn.innerHTML = '☆ Marcar';
            btn.classList.remove('active');
            if(navBtn) navBtn.classList.remove('marked');
        } else {
            markedIds.add(id);
            btn.innerHTML = '★ Marcada';
            btn.classList.add('active');
            if(navBtn) navBtn.classList.add('marked');
        }
    }

    function updateProgress() {
        const count = Object.keys(userAnswers).length;
        const total = currentQuestions.length;
        document.getElementById('progress-text').innerText = `${count}/${total} respondidas`;
        
        if (count === total && total > 0) {
            showResults(false);
        }
    }

    function showResults(manualFinish = false) {
        const panel = document.getElementById('results-panel');
        let correct = 0;
        Object.values(userAnswers).forEach(v => { if(v) correct++; });
        
        const total = currentQuestions.length;
        
        document.getElementById('score-text').innerText = `Has acertado ${correct} de ${total}`;
        panel.style.display = 'block';
        
        if(manualFinish) {
            panel.scrollIntoView({ behavior: 'smooth' });
        } else {
            setTimeout(() => panel.scrollIntoView({ behavior: 'smooth' }), 100);
        }
    }

    function resetQuiz(mode) {
        let nextIds = [];

        if (mode === 'all') {
            nextIds = dbQuestions.map(q => q.id);
        } else if (mode === 'wrong') {
            nextIds = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
        } else if (mode === 'marked') {
            nextIds = Array.from(markedIds);
        } else if (mode === 'wrong_marked') {
            const wrong = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
            const marked = Array.from(markedIds);
            nextIds = [...new Set([...wrong, ...marked])];
        }

        if (nextIds.length === 0) {
            alert("No hay preguntas para los criterios seleccionados.");
            return;
        }

        userAnswers = {};
        currentQuestions = dbQuestions.filter(q => nextIds.includes(q.id));
        renderQuiz();
        document.querySelector('.main-content').scrollTop = 0;
    }

    renderQuiz();
</script>
</body>
</html>