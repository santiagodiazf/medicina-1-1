<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Biología Celular - Completo</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #f5f6fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #ecf0f1;
        }

        /* BARRA LATERAL (Índice) */
        #sidebar {
            width: 70px;
            background-color: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            padding-top: 10px;
            padding-bottom: 20px;
            flex-shrink: 0;
            border-right: 1px solid #1a252f;
            z-index: 100;
        }

        .nav-dot {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            background-color: rgba(255,255,255,0.1);
            color: white;
            border: none;
            margin: 4px 0;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            transition: all 0.2s;
        }

        .nav-dot:hover { background-color: var(--accent); }
        .nav-dot.correct { background-color: var(--success); }
        .nav-dot.wrong { background-color: var(--danger); }
        
        /* Indicador de "Marcada" en la barra lateral */
        .nav-dot.marked::after {
            content: '★';
            position: absolute;
            top: -5px;
            right: -5px;
            color: var(--warning);
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* ÁREA PRINCIPAL */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* CABECERA */
        header {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h2 { margin: 0; font-size: 1.2rem; color: var(--primary); }

        /* LISTA DE PREGUNTAS (SCROLL) */
        #quiz-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px 15%;
            scroll-behavior: smooth;
        }

        @media (max-width: 768px) {
            #quiz-container { padding: 20px 5%; }
            #sidebar { width: 50px; }
        }

        /* TARJETA DE PREGUNTA */
        .question-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 5px solid transparent;
            transition: border-color 0.3s;
        }

        .question-card.status-correct { border-left-color: var(--success); }
        .question-card.status-wrong { border-left-color: var(--danger); }

        .q-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #7f8c8d;
            font-weight: bold;
        }

        .btn-mark {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #bdc3c7;
            transition: color 0.2s;
        }
        .btn-mark.active { color: var(--warning); }

        .q-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        /* OPCIONES */
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            padding: 15px;
            text-align: left;
            background: #f8f9fa;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .option-btn:hover:not(:disabled) {
            background-color: #e3f2fd;
            border-color: var(--accent);
        }

        /* ESTILOS DE RESPUESTA */
        .option-btn.correct-answer {
            background-color: #d4edda !important;
            border-color: var(--success) !important;
            color: #155724;
        }
        
        .option-btn.wrong-answer {
            background-color: #f8d7da !important;
            border-color: var(--danger) !important;
            color: #721c24;
        }

        .option-btn:disabled { cursor: default; opacity: 0.8; }

        /* EXPLICACIÓN */
        .explanation-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f8f5;
            border-radius: 5px;
            border: 1px solid #a3e4d7;
            display: none; /* Oculto por defecto */
        }

        .image-placeholder {
            display: block;
            background: #eee;
            border: 1px dashed #999;
            padding: 10px;
            margin: 10px 0;
            color: #555;
            font-style: italic;
            text-align: center;
        }

        /* PANTALLAS MODALES (INICIO / FIN) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .hidden { display: none !important; }

        .btn {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { border: 2px solid var(--primary); background: transparent; color: var(--primary); }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
            text-align: center;
        }
        .stat-box { background: #f1f2f6; padding: 15px; border-radius: 8px; width: 120px; }
        .stat-num { display: block; font-size: 2rem; font-weight: bold; }
        .stat-label { color: #7f8c8d; font-size: 0.9rem; }

    </style>
</head>
<body>

    <div id="sidebar">
        </div>

    <div id="main-content">
        <header>
            <h2>Quiz Biología</h2>
            <button class="btn btn-danger" onclick="showResults()" style="padding:8px 15px; font-size:0.9rem;">Finalizar Test</button>
        </header>
        <div id="quiz-container">
            </div>
    </div>

    <div id="start-screen" class="modal-overlay">
        <h1>Configuración del Quiz</h1>
        <p>50 Preguntas disponibles</p>
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="initQuiz(false)">Orden Preestablecido</button>
            <button class="btn btn-success" onclick="initQuiz(true)">Preguntas Aleatorias</button>
        </div>
    </div>

    <div id="results-screen" class="modal-overlay hidden">
        <h1>Resultados Finales</h1>
        <div class="stats-panel">
            <div class="stat-box">
                <span id="score-correct" class="stat-num" style="color: var(--success)">0</span>
                <span class="stat-label">Aciertos</span>
            </div>
            <div class="stat-box">
                <span id="score-wrong" class="stat-num" style="color: var(--danger)">0</span>
                <span class="stat-label">Fallos</span>
            </div>
            <div class="stat-box">
                <span id="score-marked" class="stat-num" style="color: var(--warning)">0</span>
                <span class="stat-label">Marcadas</span>
            </div>
            <div class="stat-box">
                <span id="score-total" class="stat-num">0</span>
                <span class="stat-label">Total</span>
            </div>
        </div>

        <h3>¿Qué deseas hacer ahora?</h3>
        <div>
            <button class="btn btn-outline" onclick="retryQuiz('all')">Repetir Completo</button>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn btn-danger" onclick="retryQuiz('failed')">Repetir Falladas</button>
            <button class="btn btn-warning" onclick="retryQuiz('marked')" style="color:white">Repetir Marcadas</button>
            <button class="btn btn-primary" onclick="retryQuiz('failed_marked')">Falladas + Marcadas</button>
        </div>
    </div>

<script>
    // --- BASE DE DATOS (Literal) ---
    const questionsDB = [
        { id: 1, q: "El proceso por el cual una señal química externa se transforma en una señal intracelular que desencadena una respuesta biológica se denomina:", options: ["Transfección.", "Transducción de señal.", "Transcripción génica.", "Potencial de acción."], ans: 1, exp: "Respuesta: B <br><br>

[Image of signal transduction pathway overview]
" },
        { id: 2, q: "¿Qué determina que una célula responda a una señal y otra célula vecina no lo haga ante la misma molécula?", options: ["La cantidad de ATP disponible en la célula.", "La presencia del receptor específico para ese ligando en la célula diana.", "El tamaño de la célula.", "La temperatura del medio extracelular."], ans: 1, exp: "Respuesta: B (El profesor insiste: 'reconocen de forma selectiva y específica')." },
        { id: 3, q: "En la farmacología de los receptores, un antagonista se define como:", options: ["Un ligando que activa desencadenando la respuesta máxima.", "Una molécula que destruye el receptor.", "Un ligando que se une al receptor pero no lo activa, bloqueando la unión del agonista.", "Una enzima que degrada al ligando endógeno."], ans: 2, exp: "Respuesta: C" },
        { id: 4, q: "¿Qué fenómeno ocurre cuando una célula está expuesta de forma continua a altas concentraciones de un ligando?", options: ["Hipersensibilización.", "Regulación a la baja (down-regulation) o desensibilización.", "Aumento de afinidad.", "Síntesis masiva."], ans: 1, exp: "Respuesta: B" },
        { id: 5, q: "La especificidad de la comunicación celular depende fundamentalmente de:", options: ["Solubilidad del ligando.", "Encaje estructural preciso entre el ligando y el receptor.", "Velocidad de difusión.", "pH del medio."], ans: 1, exp: "Respuesta: B" },
        { id: 6, q: "¿Qué característica debe tener una molécula para actuar sobre receptores intracelulares?", options: ["Hidrofílica y grande.", "Lipofílica (hidrofóbica) o un gas para atravesar la membrana.", "Cargada positivamente.", "Proteína grande."], ans: 1, exp: "Respuesta: B (Ej. Hormonas esteroideas, NO)." },
        { id: 7, q: "En el mecanismo de la testosterona, ¿qué función cumplen las chaperonas en el citoplasma?", options: ["Degradan la hormona.", "Estabilizan el receptor y lo mantienen inactivo hasta que llega la hormona.", "Transportan el receptor antes de la señal.", "Fosforilan."], ans: 1, exp: "Respuesta: B <br><br>

[Image of intracellular receptor mechanism steroid hormone]
" },
        { id: 8, q: "¿Por qué la respuesta mediada por receptores intracelulares es más lenta?", options: ["La hormona tarda en entrar.", "Implica translocación al núcleo y regulación de la expresión génica.", "No hay amplificación.", "Poca afinidad."], ans: 1, exp: "Respuesta: B" },
        { id: 9, q: "Activado el receptor intracelular, su función principal en el núcleo es:", options: ["Quinasa.", "Canal iónico.", "Factor de transcripción que se une al ADN.", "Polimerasa."], ans: 2, exp: "Respuesta: C" },
        { id: 10, q: "¿Cuál de estos ligandos actúa por receptor intracelular?", options: ["Insulina.", "Adrenalina.", "Cortisol o Testosterona.", "Acetilcolina."], ans: 2, exp: "Respuesta: C" },
        { id: 11, q: "Los receptores ionotrópicos se caracterizan por:", options: ["Respuestas muy rápidas (milisegundos).", "Síntesis proteica.", "Activar proteína G.", "Células no excitables."], ans: 0, exp: "Respuesta: A" },
        { id: 12, q: "Mecanismo básico de un receptor canal:", options: ["Fosforilación.", "Unión ligando -> cambio conformacional -> apertura poro.", "Endocitosis.", "Unión ADN."], ans: 1, exp: "Respuesta: B <br><br>

[Image of ligand-gated ion channel mechanism]
" },
        { id: 13, q: "Ejemplo de ligando ionotrópico mencionado en el audio:", options: ["Insulina.", "GABA o Glutamato.", "Hormona crecimiento.", "Estrógenos."], ans: 1, exp: "Respuesta: B" },
        { id: 14, q: "El receptor de insulina pertenece a la familia de:", options: ["GPCR.", "Canales.", "Actividad enzimática intrínseca (Tirosina Quinasa).", "Nucleares."], ans: 2, exp: "Respuesta: C" },
        { id: 15, q: "Evento tras la unión de insulina al receptor:", options: ["Apertura canal Na.", "Autofosforilación en residuos de tirosina de la parte intracelular.", "Activación Adenilato Ciclasa.", "Translocación nuclear."], ans: 1, exp: "Respuesta: B" },
        { id: 16, q: "La vía PI3K/Akt activada por insulina provoca:", options: ["Síntesis ADN.", "Translocación de vesículas GLUT-4 a la membrana.", "Apertura canales K.", "Degradación receptor."], ans: 1, exp: "Respuesta: B" },
        { id: 17, q: "La vía de las MAP-kinasas regula:", options: ["Contracción muscular.", "Expresión génica, proliferación y supervivencia celular.", "Canales cloro.", "Digestión."], ans: 1, exp: "Respuesta: B" },
        { id: 18, q: "¿Qué define a la fosforilación en cascada?", options: ["Ruptura receptor.", "Una quinasa activa fosforila a otra, amplificando la señal.", "Fosfato sale de la célula.", "Gasto total de ATP."], ans: 1, exp: "Respuesta: B" },
        { id: 19, q: "Los GPCR atraviesan la membrana:", options: ["1 vez.", "Canales.", "7 veces (dominios transmembrana).", "0 veces."], ans: 2, exp: "Respuesta: C <br><br>

[Image of G protein coupled receptor structure]
" },
        { id: 20, q: "Activación de la proteína G heterotrimérica:", options: ["Fosforilación alfa.", "Intercambio GDP por GTP en subunidad alfa.", "Unión de las tres subunidades.", "Hidrólisis GTP."], ans: 1, exp: "Respuesta: B <br><br>

[Image of G protein activation cycle]
" },
        { id: 21, q: "La subunidad Gs (estimuladora) activa a:", options: ["Fosfolipasa C.", "Adenilato Ciclasa.", "Fosfodiesterasa.", "Tirosina quinasa."], ans: 1, exp: "Respuesta: B" },
        { id: 22, q: "La Adenilato Ciclasa aumenta el nivel de:", options: ["Calcio.", "IP3.", "AMP cíclico (AMPc).", "GMP cíclico."], ans: 2, exp: "Respuesta: C" },
        { id: 23, q: "El AMPc activa principalmente a:", options: ["Proteína Quinasa A (PKA).", "Proteína Quinasa C (PKC).", "Calmodulina.", "Canales Na."], ans: 0, exp: "Respuesta: A" },
        { id: 24, q: "Si el receptor se acopla a Gq, la PLC genera:", options: ["Solo AMPc.", "IP3 y DAG (Diacilglicerol).", "GMPc.", "Óxido Nítrico."], ans: 1, exp: "Respuesta: B" },
        { id: 25, q: "El IP3 actúa en el retículo endoplasmático para:", options: ["Síntesis proteica.", "Liberar Calcio (Ca2+) al citosol.", "Guardar calcio.", "Activar adenilato ciclasa."], ans: 1, exp: "Respuesta: B" },
        { id: 26, q: "Proteína sensora de calcio frecuente en el citosol:", options: ["Calmodulina.", "Clatrina.", "Actina.", "Albúmina."], ans: 0, exp: "Respuesta: A" },
        { id: 27, q: "Apagado de la señal de la proteína G:", options: ["Actividad GTPasa intrínseca de la subunidad alfa (GTP -> GDP).", "Destrucción proteína G.", "Fosforilación receptor.", "Falta ATP."], ans: 0, exp: "Respuesta: A" },
        { id: 28, q: "% aproximado de fármacos que actúan sobre GPCR:", options: ["10%", "50%", "90%", "0%."], ans: 1, exp: "Respuesta: B" },
        { id: 29, q: "En Diabetes Tipo 1, el fallo es:", options: ["Receptor no funciona.", "Destrucción autoinmune de células beta (falta ligando).", "Exceso insulina.", "Fallo proteína G."], ans: 1, exp: "Respuesta: B <br><br>

[Image of type 1 diabetes mechanism autoimmune]
" },
        { id: 30, q: "Tratamiento lógico para Diabetes Tipo 1:", options: ["Dieta solo.", "Administración exógena de insulina.", "Aumentar sensibilidad.", "Antibióticos."], ans: 1, exp: "Respuesta: B" },
        { id: 31, q: "En Diabetes Tipo 2, el problema es:", options: ["Ausencia insulina.", "Resistencia a la insulina (transducción post-receptor fallida).", "Páncreas destruido.", "Falta glucosa."], ans: 1, exp: "Respuesta: B <br><br>

[Image of insulin resistance mechanism type 2 diabetes]
" },
        { id: 32, q: "¿Qué fármaco análogo de GLP-1 actúa sobre GPCR?", options: ["Morfina.", "Semaglutida (Ozempic).", "Aspirina.", "Insulina."], ans: 1, exp: "Respuesta: B" },
        { id: 33, q: "El Óxido Nítrico (NO) activa a:", options: ["Receptores membrana.", "Guanilato Ciclasa citosólica (genera GMPc).", "Adenilato Ciclasa.", "Factor transcripción."], ans: 1, exp: "Respuesta: B" },
        { id: 34, q: "Efecto cardiovascular del Óxido Nítrico:", options: ["Vasoconstricción.", "Vasodilatación (relajación músculo liso).", "Coagulación.", "Taquicardia."], ans: 1, exp: "Respuesta: B" },
        { id: 35, q: "El Sildenafilo (Viagra) actúa:", options: ["Produciendo NO.", "Inhibiendo fosfodiesterasa (mantiene GMPc).", "Bloqueando receptor NO.", "Destruyendo GMPc."], ans: 1, exp: "Respuesta: B" },
        { id: 36, q: "¿Por qué la Acetilcolina tiene efectos distintos en músculo y corazón?", options: ["Cambia de forma.", "Activa diferentes receptores (Nicotínico vs Muscarínico).", "Corazón no tiene receptores.", "Temperatura."], ans: 1, exp: "Respuesta: B" },
        { id: 37, q: "La amplificación de señal significa:", options: ["Ruido.", "Un ligando activa millones de moléculas efectoras finales.", "Mucho ligando, poco efecto.", "Señal sale fuera."], ans: 1, exp: "Respuesta: B" },
        { id: 38, q: "Inhibidores de fosfodiesterasa (ej. cafeína) causan:", options: ["Baja de AMPc.", "Aumento y prolongación de segundos mensajeros (AMPc/GMPc).", "Cierre canales.", "Inactiva PKA."], ans: 1, exp: "Respuesta: B" },
        { id: 39, q: "Si Gs no puede hidrolizar GTP:", options: ["No se activa.", "Adenilato Ciclasa permanentemente activa (como toxina cólera).", "Degradación.", "Muerte."], ans: 1, exp: "Respuesta: B" },
        { id: 40, q: "Ventaja de segundos mensajeros:", options: ["Rapidez.", "Amplificación y regulación compleja.", "Sin energía.", "Simplicidad."], ans: 1, exp: "Respuesta: B" },
        { id: 41, q: "Proteína \"interruptor\" (GTP activa / GDP inactiva):", options: ["Tirosina quinasa.", "Proteína G.", "Adenilato ciclasa.", "Calmodulina."], ans: 1, exp: "Respuesta: B" },
        { id: 42, q: "Tras activarse, los receptores de membrana suelen:", options: ["Seguir activos.", "Sufrir desensibilización, endocitosis o degradación.", "Duplicarse.", "Convertirse en ligandos."], ans: 1, exp: "Respuesta: B" },
        { id: 43, q: "En la vía Gq, el Calcio y DAG activan a:", options: ["PKA.", "PKC.", "PKG.", "Tirosina Quinasa."], ans: 1, exp: "Respuesta: B" },
        { id: 44, q: "Los receptores de citoquinas suelen usar la vía:", options: ["Canal iónico.", "GPCR.", "JAK-STAT (reclutan quinasas citosólicas).", "Esteroidea."], ans: 2, exp: "Respuesta: C" },
        { id: 45, q: "El 'Primer mensajero' es:", options: ["AMPc.", "Ligando extracelular.", "Proteína G.", "Receptor."], ans: 1, exp: "Respuesta: B" },
        { id: 46, q: "Fosforilación es regulada por:", options: ["Quinasas y Fosfatasas.", "Quinasas y Proteasas.", "Sintetasas.", "Receptores."], ans: 0, exp: "Respuesta: A" },
        { id: 47, q: "Receptor para huida rápida (contracción):", options: ["Nuclear.", "Canal iónico (Nicotínico).", "Insulina.", "Crecimiento."], ans: 1, exp: "Respuesta: B" },
        { id: 48, q: "La 'afinidad' es:", options: ["Distinguir señales.", "Fuerza de unión ligando-receptor (Kd).", "Velocidad.", "Número."], ans: 1, exp: "Respuesta: B" },
        { id: 49, q: "La toxina colérica causa diarrea porque:", options: ["Cierra canales Cl.", "Sube masivo AMPc, abre canales Cl- y arrastra agua.", "Inhibe Adenilato.", "Destruye intestino."], ans: 1, exp: "Respuesta: B" },
        { id: 50, q: "Afirmación CORRECTA sobre transducción:", options: ["Todas las células responden igual.", "Una señal puede generar respuestas distintas según el tejido.", "Receptores siempre van al núcleo.", "Sin energía."], ans: 1, exp: "Respuesta: B" }
    ];

    // --- ESTADO DE LA APLICACIÓN ---
    let currentSessionQuestions = []; // Array con las preguntas activas
    const markedIDs = new Set(); // IDs de preguntas marcadas (persistente)
    const failedIDs = new Set(); // IDs de preguntas falladas en la sesión actual
    const correctIDs = new Set(); // IDs de preguntas acertadas en la sesión actual

    // --- ELEMENTOS DOM ---
    const domSidebar = document.getElementById('sidebar');
    const domQuiz = document.getElementById('quiz-container');
    const domStart = document.getElementById('start-screen');
    const domResults = document.getElementById('results-screen');

    // --- UTILIDADES ---
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function parseText(text) {
        // Convierte saltos de línea y placeholders de imagen
        return text.replace(/\/g, '<div class="image-placeholder">Imagen Referencia: $1</div>')
                   .replace(/\n/g, '<br>');
    }

    // --- LÓGICA PRINCIPAL ---

    // 1. INICIAR QUIZ (Normal o Aleatorio)
    function initQuiz(randomize) {
        // Limpiamos fallos y aciertos de la sesión anterior
        failedIDs.clear();
        correctIDs.clear();
        
        // Copiamos todas las preguntas
        currentSessionQuestions = [...questionsDB];
        
        if (randomize) {
            shuffle(currentSessionQuestions);
        }
        
        renderQuiz();
        domStart.classList.add('hidden');
        domResults.classList.add('hidden');
    }

    // 2. REPETIR QUIZ (Lógica de filtrado)
    function retryQuiz(mode) {
        let subsetIds = [];
        
        if (mode === 'all') {
            initQuiz(false); // Reinicio total ordenado
            return;
        } else if (mode === 'failed') {
            subsetIds = Array.from(failedIDs);
        } else if (mode === 'marked') {
            subsetIds = Array.from(markedIDs);
        } else if (mode === 'failed_marked') {
            subsetIds = [...new Set([...failedIDs, ...markedIDs])]; // Unir sin duplicados
        }

        if (subsetIds.length === 0) {
            alert("No hay preguntas en esta categoría para repetir.");
            return;
        }

        // Filtramos la base de datos original para obtener los objetos completos
        // El orden será el original (1, 2, 3...) salvo que mezclemos, pero aquí respetamos orden ID
        currentSessionQuestions = questionsDB.filter(q => subsetIds.includes(q.id));

        // Limpiamos el estado de estas preguntas (ya no cuentan como falladas/acertadas hasta que se respondan de nuevo)
        subsetIds.forEach(id => {
            failedIDs.delete(id);
            correctIDs.delete(id);
        });

        renderQuiz();
        domResults.classList.add('hidden');
    }

    // 3. RENDERIZADO (Dibuja el HTML)
    function renderQuiz() {
        domSidebar.innerHTML = '';
        domQuiz.innerHTML = '';

        currentSessionQuestions.forEach((q, index) => {
            // A. Botón Lateral
            const navBtn = document.createElement('button');
            navBtn.className = 'nav-dot';
            navBtn.textContent = index + 1;
            navBtn.onclick = () => document.getElementById(`card-${q.id}`).scrollIntoView({behavior: 'smooth'});
            navBtn.id = `nav-${q.id}`; // ID para buscarlo luego
            if (markedIDs.has(q.id)) navBtn.classList.add('marked');
            domSidebar.appendChild(navBtn);

            // B. Tarjeta de Pregunta
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `card-${q.id}`;

            // Cabecera de tarjeta
            const header = document.createElement('div');
            header.className = 'q-header';
            header.innerHTML = `<span>Pregunta ${index + 1}</span>`;
            
            const markBtn = document.createElement('button');
            markBtn.className = `btn-mark ${markedIDs.has(q.id) ? 'active' : ''}`;
            markBtn.innerHTML = '★';
            markBtn.title = "Marcar / Desmarcar";
            markBtn.onclick = () => toggleMark(q.id, markBtn, navBtn);
            
            header.appendChild(markBtn);
            card.appendChild(header);

            // Texto Pregunta
            const qText = document.createElement('div');
            qText.className = 'q-text';
            qText.innerHTML = parseText(q.q);
            card.appendChild(qText);

            // Opciones (Mezcladas aleatoriamente cada vez)
            const optsList = document.createElement('div');
            optsList.className = 'options-list';

            // Mapeamos opciones para guardar cuál es la correcta antes de mezclar
            let optionsObj = q.options.map((txt, idx) => ({
                text: txt,
                isCorrect: (idx === q.ans) // true si es la respuesta correcta
            }));
            
            shuffle(optionsObj); // Mezclamos el array de objetos

            optionsObj.forEach(opt => {
                const btnOpt = document.createElement('button');
                btnOpt.className = 'option-btn';
                btnOpt.textContent = opt.text;
                // Guardamos en el dataset si es correcta para leerlo al hacer click
                btnOpt.dataset.isCorrect = opt.isCorrect; 
                
                btnOpt.onclick = () => handleAnswer(q, opt.isCorrect, btnOpt, card, navBtn);
                optsList.appendChild(btnOpt);
            });
            card.appendChild(optsList);

            // Explicación (Oculta al inicio)
            const expBox = document.createElement('div');
            expBox.className = 'explanation-box';
            expBox.innerHTML = `<strong>Explicación:</strong><br>${parseText(q.exp)}`;
            card.appendChild(expBox);

            domQuiz.appendChild(card);
        });
    }

    // 4. MANEJO DE RESPUESTA
    function handleAnswer(qObj, isCorrect, btnClicked, card, navBtn) {
        // Bloquear todos los botones de esta tarjeta
        const allOpts = card.querySelectorAll('.option-btn');
        allOpts.forEach(b => b.disabled = true);

        const expBox = card.querySelector('.explanation-box');
        expBox.style.display = 'block';

        if (isCorrect) {
            // ACIERTO
            btnClicked.classList.add('correct-answer');
            card.classList.add('status-correct');
            navBtn.classList.add('correct');
            correctIDs.add(qObj.id);
        } else {
            // FALLO
            btnClicked.classList.add('wrong-answer');
            card.classList.add('status-wrong');
            navBtn.classList.add('wrong');
            failedIDs.add(qObj.id);

            // Buscar y resaltar la correcta
            allOpts.forEach(b => {
                if (b.dataset.isCorrect === "true") {
                    b.classList.add('correct-answer');
                }
            });
        }
    }

    // 5. MARCAR / DESMARCAR
    function toggleMark(id, btnMark, btnNav) {
        if (markedIDs.has(id)) {
            markedIDs.delete(id);
            btnMark.classList.remove('active');
            btnNav.classList.remove('marked');
        } else {
            markedIDs.add(id);
            btnMark.classList.add('active');
            btnNav.classList.add('marked');
        }
    }

    // 6. FINALIZAR Y MOSTRAR RESULTADOS
    function showResults() {
        const total = currentSessionQuestions.length;
        const correct = correctIDs.size;
        const failed = failedIDs.size; // Solo las que falló explícitamente
        const marked = markedIDs.size;

        document.getElementById('score-correct').textContent = correct;
        document.getElementById('score-wrong').textContent = failed;
        document.getElementById('score-marked').textContent = marked;
        document.getElementById('score-total').textContent = total;

        domResults.classList.remove('hidden');
    }

</script>
</body>
</html>
