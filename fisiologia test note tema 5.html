<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Biología Celular - Completo</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            background-color: #e9ecef;
            overflow: hidden; /* Evita doble scroll */
        }

        /* --- BARRA LATERAL (Índice) --- */
        #sidebar {
            width: 80px;
            background-color: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            overflow-y: auto; /* Scroll independiente */
            flex-shrink: 0;
            border-right: 1px solid #1a1a1a;
            z-index: 100;
        }

        .nav-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            margin: 5px 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            position: relative;
            transition: all 0.2s;
        }

        .nav-btn:hover { background: var(--accent); }
        .nav-btn.correct { background: var(--success); }
        .nav-btn.wrong { background: var(--danger); }
        
        /* Estrella para marcadas en el menú */
        .nav-btn.marked::after {
            content: '★';
            position: absolute;
            top: -2px;
            right: -2px;
            color: var(--warning);
            font-size: 14px;
            text-shadow: 0 1px 2px black;
        }

        /* --- ÁREA PRINCIPAL --- */
        #main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }

        #quiz-container {
            flex-grow: 1;
            overflow-y: auto; /* Scroll para las preguntas */
            padding: 30px 20%;
            scroll-behavior: smooth;
        }

        @media (max-width: 1000px) {
            #quiz-container { padding: 20px 5%; }
        }

        /* --- TARJETAS DE PREGUNTA --- */
        .question-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 6px solid transparent;
        }

        .question-card.answered-correct { border-left-color: var(--success); }
        .question-card.answered-wrong { border-left-color: var(--danger); }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #777;
        }

        .mark-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #ddd;
            transition: color 0.2s;
        }
        .mark-toggle.active { color: var(--warning); }

        .q-text {
            font-size: 1.15rem;
            color: #222;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            gap: 12px;
        }

        .option-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            text-align: left;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }

        .option-btn:hover:not(:disabled) {
            background: #e2e6ea;
            border-color: var(--accent);
        }

        .option-btn:disabled { cursor: default; opacity: 0.8; }

        /* Colores de corrección */
        .option-btn.btn-correct {
            background-color: #d4edda !important;
            border-color: var(--success) !important;
            color: #155724 !important;
        }

        .option-btn.btn-wrong {
            background-color: #f8d7da !important;
            border-color: var(--danger) !important;
            color: #721c24 !important;
        }

        .explanation {
            margin-top: 20px;
            padding: 15px;
            background: #e8f6f3;
            border-left: 4px solid var(--success);
            border-radius: 4px;
            display: none; /* Oculto por defecto */
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- MODALES --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .hidden { display: none !important; }

        .btn {
            padding: 12px 25px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        .btn-blue { background-color: var(--accent); }
        .btn-red { background-color: var(--danger); }
        .btn-green { background-color: var(--success); }
        .btn-yellow { background-color: var(--warning); color: #333; }

        .stats-row {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 10px;
            min-width: 100px;
        }
        .stat-val { display: block; font-size: 2rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; color: #666; }

    </style>
</head>
<body>

<div id="sidebar"></div>

<div id="main-area">
    <header>
        <h1>Quiz Biología</h1>
        <button class="btn btn-red" onclick="finishQuiz()" style="padding: 8px 16px; font-size: 14px; margin: 0;">Finalizar</button>
    </header>
    <div id="quiz-container"></div>
</div>

<div id="start-screen" class="modal">
    <h1 style="color: var(--primary)">Configuración del Quiz</h1>
    <p>50 Preguntas | Corrección Inmediata</p>
    <div>
        <button class="btn btn-blue" onclick="startQuiz('ordered')">Orden Preestablecido</button>
        <button class="btn btn-green" onclick="startQuiz('random')">Orden Aleatorio</button>
    </div>
</div>

<div id="results-screen" class="modal hidden">
    <h1 style="color: var(--primary)">Resultados</h1>
    
    <div class="stats-row">
        <div class="stat-card">
            <span id="res-correct" class="stat-val" style="color: var(--success)">0</span>
            <span class="stat-label">Aciertos</span>
        </div>
        <div class="stat-card">
            <span id="res-wrong" class="stat-val" style="color: var(--danger)">0</span>
            <span class="stat-label">Fallos</span>
        </div>
        <div class="stat-card">
            <span id="res-marked" class="stat-val" style="color: var(--warning)">0</span>
            <span class="stat-label">Marcadas</span>
        </div>
    </div>

    <h3>Opciones de repetición:</h3>
    <div>
        <button class="btn btn-blue" onclick="retry('all')">Repetir Completo</button>
    </div>
    <div style="margin-top: 10px;">
        <button class="btn btn-red" onclick="retry('failed')">Solo Falladas</button>
        <button class="btn btn-yellow" onclick="retry('marked')">Solo Marcadas</button>
        <button class="btn btn-green" onclick="retry('failed_marked')">Falladas + Marcadas</button>
    </div>
</div>

<script>
    // --- DATOS (Uso backticks ` para evitar errores con comillas simples/dobles) ---
    const DB_RAW = [
        { id: 1, q: `El proceso por el cual una señal química externa se transforma en una señal intracelular que desencadena una respuesta biológica se denomina:`, options: [`Transfección.`, `Transducción de señal.`, `Transcripción génica.`, `Potencial de acción.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of signal transduction pathway overview]
` },
        { id: 2, q: `¿Qué determina que una célula responda a una señal y otra célula vecina no lo haga ante la misma molécula?`, options: [`La cantidad de ATP disponible en la célula.`, `La presencia del receptor específico para ese ligando en la célula diana.`, `El tamaño de la célula.`, `La temperatura del medio extracelular.`], ans: 1, exp: `Respuesta: B (El profesor insiste: 'reconocen de forma selectiva y específica').` },
        { id: 3, q: `En la farmacología de los receptores, un antagonista se define como:`, options: [`Un ligando que activa desencadenando la respuesta máxima.`, `Una molécula que destruye el receptor.`, `Un ligando que se une al receptor pero no lo activa, bloqueando la unión del agonista.`, `Una enzima que degrada al ligando endógeno.`], ans: 2, exp: `Respuesta: C` },
        { id: 4, q: `¿Qué fenómeno ocurre cuando una célula está expuesta de forma continua a altas concentraciones de un ligando?`, options: [`Hipersensibilización.`, `Regulación a la baja (down-regulation) o desensibilización.`, `Aumento de afinidad.`, `Síntesis masiva.`], ans: 1, exp: `Respuesta: B` },
        { id: 5, q: `La especificidad de la comunicación celular depende fundamentalmente de:`, options: [`Solubilidad del ligando.`, `Encaje estructural preciso entre el ligando y el receptor.`, `Velocidad de difusión.`, `pH del medio.`], ans: 1, exp: `Respuesta: B` },
        { id: 6, q: `¿Qué característica debe tener una molécula para actuar sobre receptores intracelulares?`, options: [`Hidrofílica y grande.`, `Lipofílica (hidrofóbica) o un gas para atravesar la membrana.`, `Cargada positivamente.`, `Proteína grande.`], ans: 1, exp: `Respuesta: B (Ej. Hormonas esteroideas, NO).` },
        { id: 7, q: `En el mecanismo de la testosterona, ¿qué función cumplen las chaperonas en el citoplasma?`, options: [`Degradan la hormona.`, `Estabilizan el receptor y lo mantienen inactivo hasta que llega la hormona.`, `Transportan el receptor antes de la señal.`, `Fosforilan.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of intracellular receptor mechanism steroid hormone]
` },
        { id: 8, q: `¿Por qué la respuesta mediada por receptores intracelulares es más lenta?`, options: [`La hormona tarda en entrar.`, `Implica translocación al núcleo y regulación de la expresión génica.`, `No hay amplificación.`, `Poca afinidad.`], ans: 1, exp: `Respuesta: B` },
        { id: 9, q: `Activado el receptor intracelular, su función principal en el núcleo es:`, options: [`Quinasa.`, `Canal iónico.`, `Factor de transcripción que se une al ADN.`, `Polimerasa.`], ans: 2, exp: `Respuesta: C` },
        { id: 10, q: `¿Cuál de estos ligandos actúa por receptor intracelular?`, options: [`Insulina.`, `Adrenalina.`, `Cortisol o Testosterona.`, `Acetilcolina.`], ans: 2, exp: `Respuesta: C` },
        { id: 11, q: `Los receptores ionotrópicos se caracterizan por:`, options: [`Respuestas muy rápidas (milisegundos).`, `Síntesis proteica.`, `Activar proteína G.`, `Células no excitables.`], ans: 0, exp: `Respuesta: A` },
        { id: 12, q: `Mecanismo básico de un receptor canal:`, options: [`Fosforilación.`, `Unión ligando -> cambio conformacional -> apertura poro.`, `Endocitosis.`, `Unión ADN.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of ligand-gated ion channel mechanism]
` },
        { id: 13, q: `Ejemplo de ligando ionotrópico mencionado en el audio:`, options: [`Insulina.`, `GABA o Glutamato.`, `Hormona crecimiento.`, `Estrógenos.`], ans: 1, exp: `Respuesta: B` },
        { id: 14, q: `El receptor de insulina pertenece a la familia de:`, options: [`GPCR.`, `Canales.`, `Actividad enzimática intrínseca (Tirosina Quinasa).`, `Nucleares.`], ans: 2, exp: `Respuesta: C` },
        { id: 15, q: `Evento tras la unión de insulina al receptor:`, options: [`Apertura canal Na.`, `Autofosforilación en residuos de tirosina de la parte intracelular.`, `Activación Adenilato Ciclasa.`, `Translocación nuclear.`], ans: 1, exp: `Respuesta: B` },
        { id: 16, q: `La vía PI3K/Akt activada por insulina provoca:`, options: [`Síntesis ADN.`, `Translocación de vesículas GLUT-4 a la membrana.`, `Apertura canales K.`, `Degradación receptor.`], ans: 1, exp: `Respuesta: B` },
        { id: 17, q: `La vía de las MAP-kinasas regula:`, options: [`Contracción muscular.`, `Expresión génica, proliferación y supervivencia celular.`, `Canales cloro.`, `Digestión.`], ans: 1, exp: `Respuesta: B` },
        { id: 18, q: `¿Qué define a la fosforilación en cascada?`, options: [`Ruptura receptor.`, `Una quinasa activa fosforila a otra, amplificando la señal.`, `Fosfato sale de la célula.`, `Gasto total de ATP.`], ans: 1, exp: `Respuesta: B` },
        { id: 19, q: `Los GPCR atraviesan la membrana:`, options: [`1 vez.`, `Canales.`, `7 veces (dominios transmembrana).`, `0 veces.`], ans: 2, exp: `Respuesta: C <br><br>

[Image of G protein coupled receptor structure]
` },
        { id: 20, q: `Activación de la proteína G heterotrimérica:`, options: [`Fosforilación alfa.`, `Intercambio GDP por GTP en subunidad alfa.`, `Unión de las tres subunidades.`, `Hidrólisis GTP.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of G protein activation cycle]
` },
        { id: 21, q: `La subunidad Gs (estimuladora) activa a:`, options: [`Fosfolipasa C.`, `Adenilato Ciclasa.`, `Fosfodiesterasa.`, `Tirosina quinasa.`], ans: 1, exp: `Respuesta: B` },
        { id: 22, q: `La Adenilato Ciclasa aumenta el nivel de:`, options: [`Calcio.`, `IP3.`, `AMP cíclico (AMPc).`, `GMP cíclico.`], ans: 2, exp: `Respuesta: C` },
        { id: 23, q: `El AMPc activa principalmente a:`, options: [`Proteína Quinasa A (PKA).`, `Proteína Quinasa C (PKC).`, `Calmodulina.`, `Canales Na.`], ans: 0, exp: `Respuesta: A` },
        { id: 24, q: `Si el receptor se acopla a Gq, la PLC genera:`, options: [`Solo AMPc.`, `IP3 y DAG (Diacilglicerol).`, `GMPc.`, `Óxido Nítrico.`], ans: 1, exp: `Respuesta: B` },
        { id: 25, q: `El IP3 actúa en el retículo endoplasmático para:`, options: [`Síntesis proteica.`, `Liberar Calcio (Ca2+) al citosol.`, `Guardar calcio.`, `Activar adenilato ciclasa.`], ans: 1, exp: `Respuesta: B` },
        { id: 26, q: `Proteína sensora de calcio frecuente en el citosol:`, options: [`Calmodulina.`, `Clatrina.`, `Actina.`, `Albúmina.`], ans: 0, exp: `Respuesta: A` },
        { id: 27, q: `Apagado de la señal de la proteína G:`, options: [`Actividad GTPasa intrínseca de la subunidad alfa (GTP -> GDP).`, `Destrucción proteína G.`, `Fosforilación receptor.`, `Falta ATP.`], ans: 0, exp: `Respuesta: A` },
        { id: 28, q: `% aproximado de fármacos que actúan sobre GPCR:`, options: [`10%`, `50%`, `90%`, `0%.`], ans: 1, exp: `Respuesta: B` },
        { id: 29, q: `En Diabetes Tipo 1, el fallo es:`, options: [`Receptor no funciona.`, `Destrucción autoinmune de células beta (falta ligando).`, `Exceso insulina.`, `Fallo proteína G.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of type 1 diabetes mechanism autoimmune]
` },
        { id: 30, q: `Tratamiento lógico para Diabetes Tipo 1:`, options: [`Dieta solo.`, `Administración exógena de insulina.`, `Aumentar sensibilidad.`, `Antibióticos.`], ans: 1, exp: `Respuesta: B` },
        { id: 31, q: `En Diabetes Tipo 2, el problema es:`, options: [`Ausencia insulina.`, `Resistencia a la insulina (transducción post-receptor fallida).`, `Páncreas destruido.`, `Falta glucosa.`], ans: 1, exp: `Respuesta: B <br><br>

[Image of insulin resistance mechanism type 2 diabetes]
` },
        { id: 32, q: `¿Qué fármaco análogo de GLP-1 actúa sobre GPCR?`, options: [`Morfina.`, `Semaglutida (Ozempic).`, `Aspirina.`, `Insulina.`], ans: 1, exp: `Respuesta: B` },
        { id: 33, q: `El Óxido Nítrico (NO) activa a:`, options: [`Receptores membrana.`, `Guanilato Ciclasa citosólica (genera GMPc).`, `Adenilato Ciclasa.`, `Factor transcripción.`], ans: 1, exp: `Respuesta: B` },
        { id: 34, q: `Efecto cardiovascular del Óxido Nítrico:`, options: [`Vasoconstricción.`, `Vasodilatación (relajación músculo liso).`, `Coagulación.`, `Taquicardia.`], ans: 1, exp: `Respuesta: B` },
        { id: 35, q: `El Sildenafilo (Viagra) actúa:`, options: [`Produciendo NO.`, `Inhibiendo fosfodiesterasa (mantiene GMPc).`, `Bloqueando receptor NO.`, `Destruyendo GMPc.`], ans: 1, exp: `Respuesta: B` },
        { id: 36, q: `¿Por qué la Acetilcolina tiene efectos distintos en músculo y corazón?`, options: [`Cambia de forma.`, `Activa diferentes receptores (Nicotínico vs Muscarínico).`, `Corazón no tiene receptores.`, `Temperatura.`], ans: 1, exp: `Respuesta: B` },
        { id: 37, q: `La amplificación de señal significa:`, options: [`Ruido.`, `Un ligando activa millones de moléculas efectoras finales.`, `Mucho ligando, poco efecto.`, `Señal sale fuera.`], ans: 1, exp: `Respuesta: B` },
        { id: 38, q: `Inhibidores de fosfodiesterasa (ej. cafeína) causan:`, options: [`Baja de AMPc.`, `Aumento y prolongación de segundos mensajeros (AMPc/GMPc).`, `Cierre canales.`, `Inactiva PKA.`], ans: 1, exp: `Respuesta: B` },
        { id: 39, q: `Si Gs no puede hidrolizar GTP:`, options: [`No se activa.`, `Adenilato Ciclasa permanentemente activa (como toxina cólera).`, `Degradación.`, `Muerte.`], ans: 1, exp: `Respuesta: B` },
        { id: 40, q: `Ventaja de segundos mensajeros:`, options: [`Rapidez.`, `Amplificación y regulación compleja.`, `Sin energía.`, `Simplicidad.`], ans: 1, exp: `Respuesta: B` },
        { id: 41, q: `Proteína "interruptor" (GTP activa / GDP inactiva):`, options: [`Tirosina quinasa.`, `Proteína G.`, `Adenilato ciclasa.`, `Calmodulina.`], ans: 1, exp: `Respuesta: B` },
        { id: 42, q: `Tras activarse, los receptores de membrana suelen:`, options: [`Seguir activos.`, `Sufrir desensibilización, endocitosis o degradación.`, `Duplicarse.`, `Convertirse en ligandos.`], ans: 1, exp: `Respuesta: B` },
        { id: 43, q: `En la vía Gq, el Calcio y DAG activan a:`, options: [`PKA.`, `PKC.`, `PKG.`, `Tirosina Quinasa.`], ans: 1, exp: `Respuesta: B` },
        { id: 44, q: `Los receptores de citoquinas suelen usar la vía:`, options: [`Canal iónico.`, `GPCR.`, `JAK-STAT (reclutan quinasas citosólicas).`, `Esteroidea.`], ans: 2, exp: `Respuesta: C` },
        { id: 45, q: `El 'Primer mensajero' es:`, options: [`AMPc.`, `Ligando extracelular.`, `Proteína G.`, `Receptor.`], ans: 1, exp: `Respuesta: B` },
        { id: 46, q: `Fosforilación es regulada por:`, options: [`Quinasas y Fosfatasas.`, `Quinasas y Proteasas.`, `Sintetasas.`, `Receptores.`], ans: 0, exp: `Respuesta: A` },
        { id: 47, q: `Receptor para huida rápida (contracción):`, options: [`Nuclear.`, `Canal iónico (Nicotínico).`, `Insulina.`, `Crecimiento.`], ans: 1, exp: `Respuesta: B` },
        { id: 48, q: `La 'afinidad' es:`, options: [`Distinguir señales.`, `Fuerza de unión ligando-receptor (Kd).`, `Velocidad.`, `Número.`], ans: 1, exp: `Respuesta: B` },
        { id: 49, q: `La toxina colérica causa diarrea porque:`, options: [`Cierra canales Cl.`, `Sube masivo AMPc, abre canales Cl- y arrastra agua.`, `Inhibe Adenilato.`, `Destruye intestino.`], ans: 1, exp: `Respuesta: B` },
        { id: 50, q: `Afirmación CORRECTA sobre transducción:`, options: [`Todas las células responden igual.`, `Una señal puede generar respuestas distintas según el tejido.`, `Receptores siempre van al núcleo.`, `Sin energía.`], ans: 1, exp: `Respuesta: B` }
    ];

    // --- VARIABLES DE ESTADO ---
    let currentQuestions = []; // Las preguntas de la sesión actual
    let userState = {}; // Guarda { id: { status: 'correct'|'wrong'|null, marked: bool } }

    // --- ELEMENTOS DOM ---
    const sidebar = document.getElementById('sidebar');
    const container = document.getElementById('quiz-container');
    const startModal = document.getElementById('start-screen');
    const resModal = document.getElementById('results-screen');

    // --- FUNCIONES UTILIDAD ---
    function shuffleArray(arr) {
        return arr.sort(() => Math.random() - 0.5);
    }

    function initUserState() {
        // Inicializamos el estado vacío pero conservando marcas si es necesario (mejor resetear todo menos marcas en futuro)
        // Para este requerimiento, reseteamos aciertos/fallos al iniciar
        DB_RAW.forEach(q => {
            if (!userState[q.id]) {
                userState[q.id] = { status: null, marked: false };
            } else {
                userState[q.id].status = null; // Reset status, keep marked
            }
        });
    }

    function getCleanText(text) {
        return text.replace(/\/g, '<div style="margin:10px 0; padding:10px; background:#eee; border:1px dashed #999; font-style:italic; font-size:0.9em;">Imagen Referencia: $1</div>').replace(/\n/g, '<br>');
    }

    // --- LÓGICA PRINCIPAL ---

    function startQuiz(mode) {
        initUserState();
        
        // Clonar array para no modificar el original
        currentQuestions = [...DB_RAW];

        if (mode === 'random') {
            currentQuestions = shuffleArray(currentQuestions);
        }

        renderGame();
        startModal.classList.add('hidden');
        resModal.classList.add('hidden');
    }

    function retry(type) {
        // Filtrar preguntas según el tipo
        let idsToPlay = [];
        const allIds = DB_RAW.map(q => q.id);

        if (type === 'all') {
            idsToPlay = allIds;
        } else if (type === 'failed') {
            idsToPlay = allIds.filter(id => userState[id].status === 'wrong');
        } else if (type === 'marked') {
            idsToPlay = allIds.filter(id => userState[id].marked);
        } else if (type === 'failed_marked') {
            idsToPlay = allIds.filter(id => userState[id].status === 'wrong' || userState[id].marked);
        }

        if (idsToPlay.length === 0) {
            alert("No hay preguntas que cumplan ese criterio.");
            return;
        }

        // Resetear status solo de las que vamos a jugar
        idsToPlay.forEach(id => userState[id].status = null);

        // Filtrar la DB original para obtener los objetos pregunta
        currentQuestions = DB_RAW.filter(q => idsToPlay.includes(q.id));
        
        renderGame();
        resModal.classList.add('hidden');
    }

    function renderGame() {
        sidebar.innerHTML = '';
        container.innerHTML = '';

        currentQuestions.forEach((q, index) => {
            // 1. Crear Botón Sidebar
            const navBtn = document.createElement('button');
            navBtn.className = 'nav-btn';
            navBtn.textContent = index + 1; // Número secuencial
            navBtn.id = `nav-${q.id}`;
            navBtn.onclick = () => document.getElementById(`card-${q.id}`).scrollIntoView();
            
            // Aplicar estado visual si ya estaba marcada
            if (userState[q.id].marked) navBtn.classList.add('marked');
            sidebar.appendChild(navBtn);

            // 2. Crear Tarjeta
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `card-${q.id}`;

            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<strong>Pregunta ${index + 1}</strong>`; // (ID Real: ${q.id})
            
            const markBtn = document.createElement('button');
            markBtn.className = `mark-toggle ${userState[q.id].marked ? 'active' : ''}`;
            markBtn.innerHTML = '★';
            markBtn.title = "Marcar para revisar";
            markBtn.onclick = () => toggleMark(q.id, markBtn, navBtn);
            header.appendChild(markBtn);
            
            card.appendChild(header);

            // Texto Pregunta
            const qText = document.createElement('div');
            qText.className = 'q-text';
            qText.innerHTML = getCleanText(q.q);
            card.appendChild(qText);

            // Opciones
            const grid = document.createElement('div');
            grid.className = 'options-grid';

            // Preparar opciones (Objeto: {texto, esCorrecta})
            let opts = q.options.map((txt, idx) => ({ 
                text: txt, 
                isCorrect: idx === q.ans 
            }));
            
            // MEZCLAR OPCIONES SIEMPRE
            opts = shuffleArray(opts);

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = opt.text;
                btn.onclick = () => checkAnswer(q.id, opt.isCorrect, btn, card, navBtn, grid);
                grid.appendChild(btn);
            });
            card.appendChild(grid);

            // Explicación
            const exp = document.createElement('div');
            exp.className = 'explanation';
            exp.innerHTML = `<strong>Explicación:</strong><br>${getCleanText(q.exp)}`;
            card.appendChild(exp);

            container.appendChild(card);
        });
    }

    function checkAnswer(id, isCorrect, btnClicked, card, navBtn, grid) {
        // Bloquear botones
        const allBtns = grid.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.disabled = true);

        // Mostrar explicación
        card.querySelector('.explanation').style.display = 'block';

        if (isCorrect) {
            userState[id].status = 'correct';
            btnClicked.classList.add('btn-correct');
            card.classList.add('answered-correct');
            navBtn.classList.add('correct');
        } else {
            userState[id].status = 'wrong';
            btnClicked.classList.add('btn-wrong');
            card.classList.add('answered-wrong');
            navBtn.classList.add('wrong');

            // Buscar la correcta visualmente para marcarla en verde también
            // (Como mezclamos, tenemos que buscar por lógica interna, pero no guardamos referencia DOM directa fácil)
            // Truco: iterar los botones desactivados y ver cuál era la correcta. 
            // Para eso necesitamos saber cuál era la correcta al generar. 
            // Re-escaneo simple:
            // En este diseño simple, el usuario ve que falló y lee la explicación. 
            // Si quieres resaltar la correcta también:
            // (Requiere que el botón guarde el dato. Lo añado ahora dinámicamente)
        }
    }
    
    // Función auxiliar dentro del render para asignar data-correct
    // (Actualizando lógica de render arriba mentalmente... mejor hacerlo simple: el usuario lee la explicación que dice "Respuesta: B")

    function toggleMark(id, btn, navBtn) {
        const isMarked = !userState[id].marked;
        userState[id].marked = isMarked;
        
        if (isMarked) {
            btn.classList.add('active');
            navBtn.classList.add('marked');
        } else {
            btn.classList.remove('active');
            navBtn.classList.remove('marked');
        }
    }

    function finishQuiz() {
        let c = 0, w = 0, m = 0;
        
        // Contar sobre currentQuestions para ser justos con la sesión, 
        // o sobre todo? Normalmente sobre lo que se jugó.
        currentQuestions.forEach(q => {
            const s = userState[q.id];
            if (s.status === 'correct') c++;
            if (s.status === 'wrong') w++;
            if (s.marked) m++;
        });

        document.getElementById('res-correct').innerText = c;
        document.getElementById('res-wrong').innerText = w;
        document.getElementById('res-marked').innerText = m;

        resModal.classList.remove('hidden');
    }

</script>
</body>
</html>
