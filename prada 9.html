<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Anatomía - Tema 22: Duodeno</title>
    <style>
        :root {
            --primary-color: #f39c12; /* Ámbar para Duodeno/Intestino */
            --secondary-color: #d35400;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --background-color: #fef9e7;
            --card-background: #ffffff;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #bdc3c7;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            text-align: center;
            background-color: #1a252f;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h2 { margin: 0; font-size: 1.1rem; }
        
        .sidebar-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .sidebar-stats { font-size: 0.9rem; color: #bdc3c7; }

        .finish-btn-side {
            background-color: #e74c3c;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            width: 80%;
            transition: 0.2s;
        }
        .finish-btn-side:hover { background-color: #c0392b; }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px;
            align-content: start;
        }

        .nav-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 4px;
            background-color: #34495e;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: 0.2s;
        }

        .nav-btn:hover { background-color: var(--secondary-color); }
        .nav-btn.correct { background-color: var(--success-color); }
        .nav-btn.incorrect { background-color: var(--error-color); }
        .nav-btn.marked { border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; }

        /* MAIN CONTENT */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; }

        .question-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            scroll-margin-top: 20px;
        }

        .question-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .bookmark-btn {
            background: none;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            color: #95a5a6;
            padding: 2px 8px;
        }
        .bookmark-btn.active { color: #f39c12; border-color: #f39c12; background: #fef9e7; }

        .question-text { font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px; font-weight: 600; line-height: 1.4; }

        .options-grid { display: flex; flex-direction: column; gap: 8px; }

        .option-btn {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover:not(.disabled) { background-color: #fdebd0; border-color: var(--primary-color); }
        
        .option-btn.correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.incorrect { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .option-btn.disabled { cursor: default; opacity: 0.7; }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-size: 0.9rem;
        }
        .feedback.show { display: block; }
        .feedback.success { background-color: #e8f8f5; color: #0e6251; }
        .feedback.error { background-color: #fdedec; color: #78281f; }

        /* RESULT PANEL */
        .results-panel {
            background: #2c3e50;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 40px;
            display: none;
            margin-bottom: 50px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { background: #d35400; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: 160px; border-right: none; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .sidebar-nav { grid-template-columns: repeat(8, 1fr); max-height: 150px; }
            .main-content { overflow: visible; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>Tema 22: Duodeno</h2>
        <div class="sidebar-controls">
            <div class="sidebar-stats"><span id="progress-text">0/45</span> respondidas</div>
            <button class="finish-btn-side" onclick="showResults(true)">Finalizar Test</button>
        </div>
    </div>
    <div id="sidebar-nav" class="sidebar-nav"></div>
</div>

<div class="main-content">
    <div class="container">
        <h1>Anatomía del Duodeno 

[Image of duodenum anatomy]
</h1>
        <div id="questions-list"></div>
        
        <div id="results-panel" class="results-panel">
            <h2>Test Finalizado</h2>
            <p id="score-text" style="font-size: 1.4rem; margin: 15px 0;"></p>
            <div class="action-buttons">
                <button class="action-btn" onclick="resetQuiz('all')">Repetir Todo</button>
                <button class="action-btn" onclick="resetQuiz('wrong')">Repetir Falladas</button>
                <button class="action-btn" onclick="resetQuiz('marked')">Repetir Marcadas</button>
                <button class="action-btn" onclick="resetQuiz('wrong_marked')">Falladas + Marcadas</button>
            </div>
        </div>
    </div>
</div>

<script>
    // BASE DE DATOS - TEMA 22 DUODENO
    const dbQuestions = [
        { id: 1, original: "1", q: "¿Cuál de los siguientes elementos anatómicos pasa inmediatamente anterior a la tercera porción del duodeno?:", options: ["Arteria mesentérica superior", "Aorta", "Vena cava inferior", "Páncreas"], correct: 0, exp: "La AMS cruza por delante de la 3ª porción (horizontal) del duodeno." },
        { id: 2, original: "2", q: "¿Qué estructura anatómica pasa inmediatamente inferior a la arteria mesentérica superior?:", options: ["Vena renal izquierda", "Arteria renal derecha", "Vena cava", "Duodeno (4ª porción)"], correct: 0, exp: "La vena renal izquierda cruza entre la aorta y la AMS (Pinza aórtico-mesentérica)." },
        { id: 3, original: "3", q: "¿Qué estructura anatómica pasa inmediatamente superior a la arteria mesentérica superior?:", options: ["Vena esplénica", "Arteria renal", "Vena cava", "Tronco celíaco"], correct: 0, exp: "La vena esplénica pasa por el borde superior del páncreas y cuerpo, relacionándose superiormente al origen de la AMS." },
        { id: 4, original: "4", q: "En la papila duodenal drenan:", options: ["El conducto hepático principal", "El cística, a través del colédoco", "El colédoco y el conducto pancreático accesorio", "El colédoco y el conducto pancreático principal"], correct: 3, exp: "Papila mayor (Vater): Colédoco + Wirsung." },
        { id: 5, original: "5", q: "La arteria mesentérica superior alcanza la raíz del mesenterio cruzando sobre:", options: ["El borde antimesentérico de yeyuno e íleon", "El borde superior del cuerpo del yeyuno", "La transcavidad de los epiplones", "La tercera porción horizontal del duodeno"], correct: 3, exp: "Relación clásica de la AMS con D3." },
        { id: 6, original: "6", q: "¿Qué porción del duodeno es intraperitoneal?", options: ["Tercera", "Primera (Bulbo)", "Segunda", "Cuarta"], correct: 1, exp: "La primera porción (bulbo) tiene meso en su inicio." },
        { id: 7, original: "7", q: "La arteria mesentérica superior da las siguientes ramas:", options: ["Cólicas derecha, media e izquierda", "Cólica media, izquierda y sigmoideas", "Ileocólica, cólica derecha y media", "Ileocólica, cólica derecha e izquierda"], correct: 2, exp: "Ramas cólicas de la AMS: Ileocólica, Cólica Derecha, Cólica Media." },
        { id: 8, original: "8", q: "Las porciones del duodeno son:", options: ["Cuatro y se ubican todas en el sector supramesocólico", "Cuatro y la unión de la 3º y la 4º está dada por la llegada del colédoco", "Cuatro y en la 2º porción (descendente) desembocan los conductos colédoco y pancreáticos", "Cuatro y se ubican todas en el sector infamesocálico"], correct: 2, exp: "La desembocadura biliar/pancreática ocurre en la 2ª porción." },
        { id: 9, original: "9", q: "Papila duodenal mayor:", options: ["Se relaciona con la cara posterior de la primera porción del duodeno", "Mantiene abierta la luz del colédoco", "Sobreelevación donde drenan colédoco y conducto pancreático principal", "Se forma por fibras lisas..."], correct: 2, exp: "Es la eminencia en la mucosa de la 2ª porción." },
        { id: 10, original: "10", q: "El esfínter de Oddi (c pancreático mayor):", options: ["Se relaciona con la cara posterior de la primera porción", "Mantiene abierta la luz del colédoco", "Sobreelevación donde drenan...", "Se forma por fibras lisas de las paredes del duodeno sobre los conductos de drenaje de las sales biliares"], correct: 3, exp: "Es el complejo esfinteriano muscular." },
        { id: 11, original: "11", q: "Conducto de Santorini (accesorio):", options: ["Se relaciona con la cara posterior de la primera porción", "Mantiene abierta la luz", "Sobreelevación...", "Conducto pancreático accesorio"], correct: 3, exp: "Definición directa." },
        { id: 12, original: "12", q: "Cuál de los siguientes vasos se apoya sobre la tercera porción del duodeno:", options: ["Arteria esplénica", "Arteria mesentérica superior", "Arteria mesentérica inferior", "Arterias gonadales", "Vena cólica media"], correct: 1, exp: "AMS." },
        { id: 13, original: "13", q: "Vasculariza el denominado intestino primitivo medio:", options: ["Arteria esplénica", "Arteria mesentérica superior", "Arteria mesentérica inferior", "Arterias gonadales", "Vena cólica media"], correct: 1, exp: "La AMS irriga el intestino medio embriológico." },
        { id: 14, original: "14", q: "La porción dilatada del duodeno, llamada bulbo, se encuentra en la:", options: ["Segunda", "Tercera", "Cuarta", "Primera"], correct: 3, exp: "El bulbo duodenal es la 1ª porción." },
        { id: 15, original: "15", q: "El plano transpilórico, que pasa por la primera porción del duodeno, está a nivel:", options: ["T11", "L2", "L4", "L1"], correct: 3, exp: "L1 (Plano de Addison)." },
        { id: 16, original: "16", q: "En la papila duodenal mayor no drena:", options: ["El conducto pancreático principal", "El conducto pancreático accesorio (Santorini)", "El cístico, a través del colédoco", "Colédoco"], correct: 1, exp: "El accesorio drena en la papila menor." },
        { id: 17, original: "17", q: "Un paciente con dolor intenso y lacerante a nivel de L1 en la cara anterior del abdomen, epigastrio, a la derecha de la línea media, que nos señala a punta de dedo donde le duele, es sugestivo de:", options: ["Hipertensión portal", "Úlcera péptica gastroduodenal", "Pancreatitis", "Carcinoma de la vía biliar extrahepática"], correct: 1, exp: "Clínica clásica de úlcera (signo del dedo)." },
        { id: 18, original: "18", q: "Cuál de los siguientes vasos se apoya sobre la tercera porción del duodeno: (Repetida)", options: ["Arteria esplénica", "Arteria mesentérica superior", "Arteria mesentérica inferior", "Arterias gonadales", "Vena cólica media"], correct: 1, exp: "Repetida: AMS." },
        { id: 19, original: "19", q: "Vasculariza el denominado intestino primitivo medio: (Repetida)", options: ["Arteria esplénica", "Arteria mesentérica superior", "Arteria mesentérica inferior", "Arterias gonadales", "Vena cólica media"], correct: 1, exp: "Repetida: AMS." },
        { id: 20, original: "20", q: "¿Cuál de los siguientes elementos pasa inmediatamente anterior a la tercera porción del duodeno?", options: ["Proceso unciforme del páncreas", "Cuerpo del estómago", "Arteria mesentérica superior", "Todas son estructuras anteriores", "Todas son estructuras posteriores"], correct: 2, exp: "Repetida: AMS." },
        { id: 21, original: "21", q: "Relacione: Arteria pancreáticoduodenal superior", options: ["Arteria mesentérica inferior", "Arteria mesentérica superior", "Arteria gastroduodenal", "Arteria esplénica", "Arteria pudenda"], correct: 2, exp: "Rama de la Gastroduodenal." },
        { id: 22, original: "22", q: "Relacione: Arteria pancreáticoduodenal inferior", options: ["Arteria mesentérica inferior", "Arteria mesentérica superior", "Arteria gastroduodenal", "Arteria esplénica", "Arteria pudenda"], correct: 1, exp: "Rama de la AMS." },
        { id: 23, original: "23", q: "¿Qué estructura pasa inmediatamente superior a la arteria mesentérica superior? (Repetida)", options: ["Arteria renal izquierda", "Arteria renal derecha", "Arteria esplénica", "Vena esplénica", "Arteria pancreaticoduodenal posterosuperior"], correct: 3, exp: "Repetida: Vena esplénica." },
        { id: 24, original: "24", q: "Relacione: Ligamento de Treitz", options: ["Arteria aorta", "Duodeno - páncreas (Ángulo duodenoyeyunal)", "Venas pulmonares", "Colon ascendente", "Riñón"], correct: 1, exp: "Suspensorio del duodeno." },
        { id: 25, original: "25", q: "Sobre el borde mesentérico del yeyuno e íleon, señale la opción incorrecta:", options: ["Los vasos que alcanzan el tubo se denominan vasos rectos", "Supone el borde contrario al cual el peritoneo alcanza a estas porciones del tubo", "Los vasos crean lazadas anastomóticas", "Es el borde a través del cual alcanzan los vasos rectos al tubo"], correct: 1, exp: "El borde mesentérico es POR DONDE llega el peritoneo (mesenterio), no el contrario." },
        { id: 26, original: "26", q: "A la vena mesentérica inferior drenan las siguientes venas EXCEPTO:", options: ["Apendicular", "Cólica izquierda", "Sigmoideas", "Rectal superior"], correct: 0, exp: "La apendicular drena en la ileocólica -> Mesentérica Superior." },
        { id: 27, original: "27", q: "¿Cuál de los siguientes vasos podría causar una obstrucción de la tercera porción del duodeno?", options: ["Arteria mesentérica superior", "Aorta", "Cava", "Renal"], correct: 0, exp: "Síndrome de la AMS (Pinza aórtico-mesentérica)." },
        { id: 28, original: "28", q: "Sobre el borde antimesentérico del yeyuno e íleon señale la opción correcta:", options: ["Es el borde contramesenterico, donde se enlaza sobre el ángulo duodenoyeyunal", "Es el borde a través del cual alcanzan los vasos rectos del tubo", "Supone el borde diametralmente contrario al cual el peritoneo alcanza a estas porciones del tubo", "Es la base de implantación del mesenterio"], correct: 2, exp: "Definición de borde antimesentérico." },
        { id: 29, original: "29", q: "La arteria mesentérica superior alcanza el mesenterio cruzando sobre:", options: ["La cara superior del mesocolon transverso", "La tercera porción horizontal del duodeno", "La transcavidad de los epsilones", "El borde superior del cuerpo del yeyuno"], correct: 1, exp: "Repetida: D3." },
        { id: 30, original: "30", q: "La arteria mesentérica superior alcanza la raíz del mesenterio cruzando sobre: (Repetida)", options: ["El borde antimesentérico de yeyuno e íleon", "El borde superior del cuerpo del yeyuno", "La transcavidad de los epiplones", "La tercera porción horizontal del duodeno"], correct: 3, exp: "Repetida." },
        { id: 31, original: "31", q: "¿Qué porción del duodeno es intraperitoneal? (Repetida)", options: ["Tercera", "Primera", "Segunda", "Cuarta"], correct: 1, exp: "Repetida." },
        { id: 32, original: "32", q: "¿Cuál de los siguientes elementos anatómicos pasa inmediatamente anterior a la tercera porción del duodeno? (Repetida)", options: ["Proceso unciforme", "Cuerpo del estómago", "Arteria mesentérica superior", "Todas", "Todas posteriores"], correct: 2, exp: "Repetida." },
        { id: 33, original: "40", q: "Al duodeno indique qué afirmación es FALSA:", options: ["La porción horizontal está cruzada por su superficie anterior por la raíz del mesocolon (Falso, es raíz del mesenterio)", "La porción descendente recibe colédoco", "La primera porción es el bulbo", "Rodea la cabeza del páncreas"], correct: 0, exp: "La raíz del mesocolon transverso cruza la 2ª porción, no la 3ª (cruzada por la del mesenterio y vasos MS)." },
        { id: 34, original: "41", q: "La porción dilatada del duodeno, llamada bulbo, se encuentra en la:", options: ["Segunda", "Tercera", "Cuarta", "Primera"], correct: 3, exp: "Repetida." },
        { id: 35, original: "42", q: "La arteria mesentérica superior no tiene una de estas relaciones:", options: ["Vena renal izquierda", "Arteria renal derecha", "El borde inferior del cuello del páncreas", "Tercera porción horizontal del duodeno"], correct: 1, exp: "La arteria renal derecha está más lejos y profunda/lateral." },
        { id: 36, original: "Extra", q: "Acerca de la papila duodenal mayor. Indique la respuesta adecuada:", options: ["Sobrelevación donde drenan colédoco y conducto pancreático principal", "Se encuentra en la cara posterior de la primera porción del duodeno", "Es para el conducto pancreático accesorio", "Mantiene siempre abierta la luz al colédoco"], correct: 0, exp: "Repetida." },
        { id: 37, original: "4", q: "El plano transpilórico, que pasa por la primera porción del duodeno, está a nivel: (Repetida)", options: ["L2", "T11", "L1", "L4"], correct: 2, exp: "Repetida: L1." },
        { id: 38, original: "115", q: "La arteria mesentérica superior alcanza el mesenterio cruzando sobre: (Repetida 3)", options: ["La cara superior del mesocolon transverso", "La tercera porción horizontal del duodeno", "La transcavidad de los epsilones", "El borde superior del cuerpo del yeyuno"], correct: 1, exp: "Repetida." },
        { id: 39, original: "Extra", q: "¿Qué porción del duodeno recibe los conductos biliar y pancreático?", options: ["Primera", "Segunda (Descendente)", "Tercera", "Cuarta"], correct: 1, exp: "La 2ª porción." },
        { id: 40, original: "Extra", q: "La vascularización del duodeno depende de:", options: ["Solo tronco celíaco", "Solo mesentérica superior", "Tronco celíaco y mesentérica superior (Arcos pancreatoduodenales)", "Mesentérica inferior"], correct: 2, exp: "Es una zona de transición vascular." },
        { id: 41, original: "Extra", q: "La pinza aortomesentérica comprime:", options: ["1ª porción duodeno", "2ª porción duodeno", "3ª porción duodeno", "4ª porción duodeno"], correct: 2, exp: "La 3ª porción queda atrapada entre Aorta y AMS." },
        { id: 42, original: "Extra", q: "El ligamento hepatoduodenal conecta el hígado con:", options: ["1ª porción del duodeno", "2ª porción del duodeno", "3ª porción del duodeno", "4ª porción del duodeno"], correct: 0, exp: "Parte del epiplón menor." },
        { id: 43, original: "Extra", q: "El receso duodenal superior e inferior se encuentran típicamente a nivel de:", options: ["Ángulo duodenoyeyunal (Treitz)", "Píloro", "Papila mayor", "Rodilla inferior"], correct: 0, exp: "Fosas duodenales en la unión con el yeyuno." },
        { id: 44, original: "Extra", q: "La cara posterior de la primera porción del duodeno se relaciona con:", options: ["Arteria gastroduodenal", "Arteria esplénica", "Arteria mesentérica inferior", "Arteria renal izquierda"], correct: 0, exp: "Relación crítica (riesgo hemorragia en úlcera posterior)." },
        { id: 45, original: "Extra", q: "El conducto colédoco pasa por detrás de:", options: ["1ª porción del duodeno", "2ª porción del duodeno", "3ª porción del duodeno", "4ª porción del duodeno"], correct: 0, exp: "Desciende retroduodenal (1ª) antes de hacerse intrapancreático." }
    ];

    let currentQuestions = [...dbQuestions];
    let markedIds = new Set();
    let userAnswers = {};

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function renderQuiz() {
        const list = document.getElementById('questions-list');
        const nav = document.getElementById('sidebar-nav');
        const resultsPanel = document.getElementById('results-panel');
        
        list.innerHTML = '';
        nav.innerHTML = '';
        resultsPanel.style.display = 'none';

        if(currentQuestions.length === 0) {
            list.innerHTML = `<div class="question-card"><p>No hay preguntas para los criterios seleccionados.</p></div>`;
            return;
        }

        currentQuestions.forEach((q, index) => {
            const btn = document.createElement('a');
            btn.href = `#q-${q.id}`;
            btn.className = 'nav-btn';
            btn.innerText = index + 1;
            btn.id = `nav-btn-${q.id}`;
            
            if (userAnswers[q.id] === true) btn.classList.add('correct');
            if (userAnswers[q.id] === false) btn.classList.add('incorrect');
            if (markedIds.has(q.id)) btn.classList.add('marked');

            nav.appendChild(btn);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-${q.id}`;

            const originalOptions = q.options.map((text, i) => ({ text: text, isCorrect: i === q.correct }));
            const finalOptions = shuffle(originalOptions);

            let optionsHTML = '';
            finalOptions.forEach(opt => {
                const safeText = opt.text.replace(/'/g, "&#39;"); 
                optionsHTML += `<button class="option-btn" onclick="handleAnswer(${q.id}, ${opt.isCorrect}, this)">${opt.text}</button>`;
            });

            const isMarked = markedIds.has(q.id);

            card.innerHTML = `
                <div class="question-header-row">
                    <span>Pregunta ${index + 1} (Ref: ${q.original})</span>
                    <button class="bookmark-btn ${isMarked ? 'active' : ''}" onclick="toggleMark(${q.id}, this)">
                        ${isMarked ? '★ Marcada' : '☆ Marcar'}
                    </button>
                </div>
                <div class="question-text">${q.q}</div>
                <div class="options-grid" id="opts-${q.id}">
                    ${optionsHTML}
                </div>
                <div class="feedback" id="feed-${q.id}"></div>
            `;
            list.appendChild(card);
        });
        updateProgress();
    }

    function handleAnswer(id, isCorrect, btn) {
        if (userAnswers.hasOwnProperty(id)) return;
        
        userAnswers[id] = isCorrect;
        const navBtn = document.getElementById(`nav-btn-${id}`);
        const feedback = document.getElementById(`feed-${id}`);
        const container = document.getElementById(`opts-${id}`);
        const qData = dbQuestions.find(x => x.id === id);

        const allBtns = container.querySelectorAll('.option-btn');
        allBtns.forEach(b => {
            b.classList.add('disabled');
            b.onclick = null;
            const correctText = qData.options[qData.correct];
            if (b.innerText === correctText) b.classList.add('correct');
        });

        if (isCorrect) {
            feedback.innerHTML = `<strong>¡Correcto!</strong><br>${qData.exp}`;
            feedback.className = 'feedback success show';
            if(navBtn) navBtn.classList.add('correct');
        } else {
            btn.classList.add('incorrect');
            feedback.innerHTML = `<strong>Incorrecto.</strong><br>${qData.exp}`;
            feedback.className = 'feedback error show';
            if(navBtn) navBtn.classList.add('incorrect');
        }
        updateProgress();
    }

    function toggleMark(id, btn) {
        const navBtn = document.getElementById(`nav-btn-${id}`);
        if (markedIds.has(id)) {
            markedIds.delete(id);
            btn.innerHTML = '☆ Marcar';
            btn.classList.remove('active');
            if(navBtn) navBtn.classList.remove('marked');
        } else {
            markedIds.add(id);
            btn.innerHTML = '★ Marcada';
            btn.classList.add('active');
            if(navBtn) navBtn.classList.add('marked');
        }
    }

    function updateProgress() {
        const count = Object.keys(userAnswers).length;
        const total = currentQuestions.length;
        document.getElementById('progress-text').innerText = `${count}/${total} respondidas`;
        
        if (count === total && total > 0) {
            showResults(false);
        }
    }

    function showResults(manualFinish = false) {
        const panel = document.getElementById('results-panel');
        let correct = 0;
        Object.values(userAnswers).forEach(v => { if(v) correct++; });
        
        const total = currentQuestions.length;
        
        document.getElementById('score-text').innerText = `Has acertado ${correct} de ${total}`;
        panel.style.display = 'block';
        
        if(manualFinish) {
            panel.scrollIntoView({ behavior: 'smooth' });
        } else {
            setTimeout(() => panel.scrollIntoView({ behavior: 'smooth' }), 100);
        }
    }

    function resetQuiz(mode) {
        let nextIds = [];

        if (mode === 'all') {
            nextIds = dbQuestions.map(q => q.id);
        } else if (mode === 'wrong') {
            nextIds = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
        } else if (mode === 'marked') {
            nextIds = Array.from(markedIds);
        } else if (mode === 'wrong_marked') {
            const wrong = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
            const marked = Array.from(markedIds);
            nextIds = [...new Set([...wrong, ...marked])];
        }

        if (nextIds.length === 0) {
            alert("No hay preguntas para los criterios seleccionados.");
            return;
        }

        userAnswers = {};
        currentQuestions = dbQuestions.filter(q => nextIds.includes(q.id));
        renderQuiz();
        document.querySelector('.main-content').scrollTop = 0;
    }

    renderQuiz();
</script>
</body>
</html>