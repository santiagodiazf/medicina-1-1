<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen - Bloque 1: Fundamentos de la Biolog√≠a Celular</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        .prof-info {
            text-align: center;
            font-style: italic;
            color: #666;
            margin-bottom: 20px;
        }
        .score-box {
            background-color: #e9f7ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 25px;
            border: 1px solid #cce5ff;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question-card {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        /* ESTILOS PARA EL MARCADOR (PESTA√ëA) */
        .bookmark-wrapper {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: #fff8e1;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #f1c40f;
            cursor: pointer;
            font-size: 0.9em;
            user-select: none;
        }
        .bookmark-wrapper:hover {
            background-color: #fcefdc;
        }
        .bookmark-wrapper input {
            cursor: pointer;
            accent-color: #f1c40f;
            width: 16px;
            height: 16px;
        }

        .question-text {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #495057;
            padding-right: 140px;
        }
        .option {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid #ccc;
        }
        .option:hover:not(.disabled) {
            background-color: #f0f0f0;
            border-color: #007bff;
        }
        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .option.disabled {
            cursor: default;
        }
        .rationale {
            margin-top: 10px;
            padding: 10px;
            border-left: 5px solid #007bff;
            background-color: #eaf6ff;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            font-size: 0.95em;
        }
        .hint {
            margin-top: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        /* ESTILOS PARA EL PANEL FINAL DE BOTONES */
        .results-panel {
            margin-top: 30px;
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .action-btn:disabled { background-color: #ccc !important; cursor: not-allowed; transform: none; filter: none; }
        
        .btn-reset { background-color: #28a745; }
        .btn-failed { background-color: #dc3545; }
        .btn-marked { background-color: #f39c12; color: #333; }
        .btn-mixed { background-color: #6f42c1; }

    </style>
</head>
<body>
    <div class="container">
        <h1>Examen - Bloque 1: Fundamentos</h1>
        <div class="prof-info">Biolog√≠a Celular - Grado en Medicina</div>
        
        <div class="score-box" id="score-box">
            <span id="score-counter">Cargando preguntas...</span>
        </div>
        
        <div id="quiz-container">
        </div>

        <div id="final-results-container" class="results-panel" style="display: none;">
            <h2 id="final-score-title">¬°Examen Completado!</h2>
            <p id="final-score-text" style="font-size: 1.2em;"></p>
            <p id="final-stats" style="color: #666;"></p>
            
            <div class="btn-grid">
                <button class="action-btn btn-reset" onclick="startQuiz('all')">üîÑ Repetir Examen Completo</button>
                <button class="action-btn btn-failed" id="btn-failed" onclick="startQuiz('failed')">‚ùå Repetir Falladas</button>
                <button class="action-btn btn-marked" id="btn-marked" onclick="startQuiz('marked')">‚ö†Ô∏è Repetir Marcadas</button>
                <button class="action-btn btn-mixed" id="btn-mixed" onclick="startQuiz('mixed')">‚ùå + ‚ö†Ô∏è Repetir Falladas y Marcadas</button>
            </div>
        </div>
    </div>

    <script>
        // DATOS DE LAS PREGUNTAS (ACAD√âMICAS - BLOQUE 1)
        const rawQuizData = [
            {
                "questionNumber": 1,
                "question": "¬øCu√°l es el l√≠mite de resoluci√≥n te√≥rico aproximado de un microscopio √≥ptico convencional?",
                "answerOptions": [
                    { "text": "0,2 nm", "rationale": "0,2 nm es el l√≠mite te√≥rico aproximado de un microscopio electr√≥nico de transmisi√≥n, no √≥ptico.", "isCorrect": false },
                    { "text": "200 nm (0,2 ¬µm)", "rationale": "Debido a la longitud de onda de la luz visible, no se pueden distinguir puntos separados por menos de 0,2 ¬µm.", "isCorrect": true },
                    { "text": "10 ¬µm", "rationale": "10 ¬µm es el tama√±o aproximado de una c√©lula animal t√≠pica, el microscopio resuelve mucho m√°s detalle.", "isCorrect": false },
                    { "text": "1 mm", "rationale": "1 mm es visible al ojo humano sin ayuda.", "isCorrect": false }
                ],
                "hint": "Recuerda que est√° limitado por la longitud de onda de la luz visible."
            },
            {
                "questionNumber": 2,
                "question": "¬øQui√©n estableci√≥ el aforismo 'Omnis cellula e cellula' (Toda c√©lula proviene de otra c√©lula)?",
                "answerOptions": [
                    { "text": "Robert Hooke", "rationale": "Hooke acu√±√≥ el t√©rmino 'c√©lula' al observar corcho, pero no propuso la teor√≠a de la biog√©nesis celular.", "isCorrect": false },
                    { "text": "Rudolf Virchow", "rationale": "Virchow complet√≥ la Teor√≠a Celular en 1855 estableciendo que las c√©lulas solo surgen de c√©lulas preexistentes.", "isCorrect": true },
                    { "text": "Theodor Schwann", "rationale": "Schwann propuso que todos los animales est√°n hechos de c√©lulas, pero no el origen celular.", "isCorrect": false },
                    { "text": "Louis Pasteur", "rationale": "Pasteur refut√≥ la generaci√≥n espont√°nea con sus experimentos, confirmando la idea de Virchow.", "isCorrect": false }
                ],
                "hint": "Fue un pat√≥logo alem√°n en el siglo XIX."
            },
            {
                "questionNumber": 3,
                "question": "¬øQu√© caracter√≠stica estructural define a las c√©lulas eucariotas y las distingue de las procariotas?",
                "answerOptions": [
                    { "text": "La presencia de ribosomas.", "rationale": "Los ribosomas est√°n presentes en ambos tipos celulares para la s√≠ntesis de prote√≠nas.", "isCorrect": false },
                    { "text": "La membrana plasm√°tica.", "rationale": "Todas las c√©lulas poseen membrana plasm√°tica.", "isCorrect": false },
                    { "text": "La presencia de n√∫cleo delimitado por envoltura nuclear.", "rationale": "La definici√≥n de eucariota ('n√∫cleo verdadero') se basa en compartimentar el ADN dentro de una doble membrana.", "isCorrect": true },
                    { "text": "La presencia de pared celular.", "rationale": "La pared celular est√° en procariotas y en eucariotas vegetales/f√∫ngicos, pero no es la distinci√≥n definitoria.", "isCorrect": false }
                ],
                "hint": "El t√©rmino 'karyon' en griego significa nuez o n√∫cleo."
            },
            {
                "questionNumber": 4,
                "question": "Seg√∫n el Modelo de Mosaico Fluido de Singer y Nicolson, ¬øc√≥mo se organizan los fosfol√≠pidos en la membrana?",
                "answerOptions": [
                    { "text": "En una monocapa con las cabezas hacia el exterior.", "rationale": "Una monocapa no aislar√≠a el entorno acuoso interno del externo.", "isCorrect": false },
                    { "text": "En una bicapa con las colas hidrof√≥bicas hacia el interior.", "rationale": "Las colas se 'esconden' del agua en el centro, y las cabezas polares contactan con el agua a ambos lados.", "isCorrect": true },
                    { "text": "En una estructura r√≠gida tipo s√°ndwich de prote√≠nas.", "rationale": "El modelo anterior (Davson-Danielli) propon√≠a capas de prote√≠nas; el modelo fluido propone una bicapa din√°mica.", "isCorrect": false },
                    { "text": "Unidos covalentemente entre s√≠ formando una red.", "rationale": "No hay enlaces covalentes entre fosfol√≠pidos, lo que permite la fluidez.", "isCorrect": false }
                ],
                "hint": "La estructura es anfip√°tica."
            },
            {
                "questionNumber": 5,
                "question": "¬øQu√© org√°nulo es el principal responsable de la respiraci√≥n celular aer√≥bica y la producci√≥n de ATP?",
                "answerOptions": [
                    { "text": "El Aparato de Golgi", "rationale": "El Golgi se encarga de la modificaci√≥n y empaquetamiento de prote√≠nas.", "isCorrect": false },
                    { "text": "El Lisosoma", "rationale": "El lisosoma es el centro de digesti√≥n celular.", "isCorrect": false },
                    { "text": "La Mitocondria", "rationale": "La mitocondria realiza la fosforilaci√≥n oxidativa para generar la mayor parte del ATP celular.", "isCorrect": true },
                    { "text": "El Ret√≠culo Endoplasm√°tico", "rationale": "El RE participa en la s√≠ntesis de l√≠pidos y prote√≠nas.", "isCorrect": false }
                ],
                "hint": "Seg√∫n la teor√≠a endosimbi√≥tica, proviene de una bacteria ancestral."
            },
            {
                "questionNumber": 6,
                "question": "¬øCu√°l de las siguientes afirmaciones sobre los VIRUS es correcta en el contexto de la Teor√≠a Celular?",
                "answerOptions": [
                    { "text": "Son las c√©lulas m√°s peque√±as que existen.", "rationale": "Los virus NO son c√©lulas, son par√°sitos intracelulares obligados.", "isCorrect": false },
                    { "text": "Son entidades acelulares que requieren una c√©lula hu√©sped para replicarse.", "rationale": "No poseen maquinaria metab√≥lica propia y dependen de la maquinaria de una c√©lula hospedadora.", "isCorrect": true },
                    { "text": "Poseen ribosomas propios para sintetizar sus c√°psides.", "rationale": "Los virus carecen de ribosomas; usan los de la c√©lula infectada.", "isCorrect": false },
                    { "text": "Todos poseen una envoltura lip√≠dica.", "rationale": "Solo algunos virus (envueltos) tienen membrana lip√≠dica; otros son desnudos.", "isCorrect": false }
                ],
                "hint": "Est√°n en el l√≠mite de lo vivo, pero no cumplen las funciones vitales por s√≠ mismos."
            },
            {
                "questionNumber": 7,
                "question": "¬øQu√© t√©cnica de microscop√≠a utilizar√≠as para observar la superficie tridimensional de una muestra biol√≥gica con gran detalle?",
                "answerOptions": [
                    { "text": "Microscop√≠a √ìptica de Campo Claro", "rationale": "Tiene baja resoluci√≥n y profundidad de campo para detalles 3D finos.", "isCorrect": false },
                    { "text": "Microscop√≠a Electr√≥nica de Transmisi√≥n (TEM)", "rationale": "El TEM observa estructuras internas a trav√©s de cortes ultrafinos, es 2D.", "isCorrect": false },
                    { "text": "Microscop√≠a Electr√≥nica de Barrido (SEM)", "rationale": "El SEM barre la superficie con electrones y genera im√°genes con apariencia 3D.", "isCorrect": true },
                    { "text": "Microscop√≠a de Fluorescencia", "rationale": "Se usa para localizar mol√©culas espec√≠ficas, no necesariamente para topograf√≠a superficial.", "isCorrect": false }
                ],
                "hint": "La palabra clave es 'Barrido' de la superficie."
            },
            {
                "questionNumber": 8,
                "question": "¬øQu√© evidencia principal apoya la Teor√≠a Endosimbi√≥tica sobre el origen de las mitocondrias?",
                "answerOptions": [
                    { "text": "Tienen el mismo tama√±o que el n√∫cleo celular.", "rationale": "Son mucho m√°s peque√±as que el n√∫cleo.", "isCorrect": false },
                    { "text": "Poseen su propio ADN circular y ribosomas tipo bacteriano (70S).", "rationale": "Estas caracter√≠sticas son t√≠picas de procariotas, sugiriendo que fueron bacterias fagocitadas.", "isCorrect": true },
                    { "text": "Pueden vivir fuera de la c√©lula en medios de cultivo.", "rationale": "Han perdido genes necesarios para la vida independiente a lo largo de la evoluci√≥n.", "isCorrect": false },
                    { "text": "Se forman de novo a partir del Ret√≠culo Endoplasm√°tico.", "rationale": "Las mitocondrias solo surgen por fisi√≥n de otras mitocondrias (como las bacterias).", "isCorrect": false }
                ],
                "hint": "Se parecen gen√©ticamente m√°s a las bacterias que a la propia c√©lula eucariota."
            },
            {
                "questionNumber": 9,
                "question": "¬øQu√© tipo de enlace qu√≠mico es principalmente responsable de mantener la estructura primaria de una prote√≠na?",
                "answerOptions": [
                    { "text": "Enlace de hidr√≥geno", "rationale": "Mantiene las estructuras secundaria y terciaria, no la primaria.", "isCorrect": false },
                    { "text": "Enlace pept√≠dico (covalente)", "rationale": "El enlace pept√≠dico une la secuencia lineal de amino√°cidos (estructura primaria).", "isCorrect": true },
                    { "text": "Interacci√≥n hidrof√≥bica", "rationale": "Crucial para el plegamiento (terciaria), pero no para la secuencia.", "isCorrect": false },
                    { "text": "Enlace i√≥nico", "rationale": "Estabiliza la estructura terciaria/cuaternaria.", "isCorrect": false }
                ],
                "hint": "Es un enlace fuerte que une el grupo amino de un amino√°cido con el carboxilo de otro."
            },
            {
                "questionNumber": 10,
                "question": "¬øCu√°l es la funci√≥n principal de los lisosomas?",
                "answerOptions": [
                    { "text": "S√≠ntesis de ATP.", "rationale": "Funci√≥n mitocondrial.", "isCorrect": false },
                    { "text": "Digesti√≥n intracelular de macromol√©culas.", "rationale": "Contienen hidrolasas √°cidas para degradar materiales ingeridos o componentes celulares viejos.", "isCorrect": true },
                    { "text": "Desintoxicaci√≥n de f√°rmacos.", "rationale": "Funci√≥n principal del Ret√≠culo Endoplasm√°tico Liso.", "isCorrect": false },
                    { "text": "Transporte de ves√≠culas.", "rationale": "Funci√≥n del citoesqueleto y prote√≠nas motoras.", "isCorrect": false }
                ],
                "hint": "Act√∫an como el 'est√≥mago' o centro de reciclaje de la c√©lula."
            },
            {
                "questionNumber": 11,
                "question": "¬øQu√© t√©cnica permite localizar una prote√≠na espec√≠fica dentro de la c√©lula utilizando anticuerpos unidos a un fluorocromo?",
                "answerOptions": [
                    { "text": "Tinci√≥n de Hematoxilina-Eosina", "rationale": "Es una tinci√≥n general histol√≥gica, no espec√≠fica para una prote√≠na concreta.", "isCorrect": false },
                    { "text": "Inmunofluorescencia", "rationale": "Usa la especificidad ant√≠geno-anticuerpo y la fluorescencia para ubicar prote√≠nas.", "isCorrect": true },
                    { "text": "Criofractura", "rationale": "T√©cnica f√≠sica para ver el interior de membranas en microscop√≠a electr√≥nica.", "isCorrect": false },
                    { "text": "Contraste de fases", "rationale": "Mejora el contraste de c√©lulas vivas sin tinciones.", "isCorrect": false }
                ],
                "hint": "El nombre combina el sistema inmune y la emisi√≥n de luz."
            },
            {
                "questionNumber": 12,
                "question": "¬øQu√© componente del citoesqueleto tiene el mayor di√°metro (aprox. 25 nm) y est√° formado por tubulina?",
                "answerOptions": [
                    { "text": "Microfilamentos", "rationale": "Son los m√°s finos (actina, ~7 nm).", "isCorrect": false },
                    { "text": "Filamentos intermedios", "rationale": "Tienen un di√°metro medio (~10 nm).", "isCorrect": false },
                    { "text": "Microt√∫bulos", "rationale": "Son cilindros huecos formados por d√≠meros de tubulina y son los componentes m√°s gruesos.", "isCorrect": true },
                    { "text": "Col√°geno", "rationale": "Es una prote√≠na de la matriz extracelular, no del citoesqueleto.", "isCorrect": false }
                ],
                "hint": "Forman el huso mit√≥tico durante la divisi√≥n celular."
            },
            {
                "questionNumber": 13,
                "question": "¬øQu√© significa que la membrana plasm√°tica tenga 'permeabilidad selectiva'?",
                "answerOptions": [
                    { "text": "Que deja pasar todo tipo de mol√©culas libremente.", "rationale": "Eso ser√≠a permeable, no selectiva, y la c√©lula morir√≠a.", "isCorrect": false },
                    { "text": "Que solo permite el paso de agua.", "rationale": "Necesita importar nutrientes y iones, no solo agua.", "isCorrect": false },
                    { "text": "Que regula y controla qu√© sustancias entran y salen.", "rationale": "Permite el paso de ciertas sustancias (ox√≠geno, agua) y restringe otras (iones, glucosa) que requieren transportadores.", "isCorrect": true },
                    { "text": "Que es impermeable a todo.", "rationale": "La c√©lula no podr√≠a nutrirse ni eliminar desechos.", "isCorrect": false }
                ],
                "hint": "Act√∫a como un portero de discoteca, decidiendo qui√©n entra y qui√©n no."
            },
            {
                "questionNumber": 14,
                "question": "En microscop√≠a electr√≥nica, ¬øpor qu√© se realiza la fijaci√≥n con glutaraldeh√≠do y osmio?",
                "answerOptions": [
                    { "text": "Para te√±ir de colores la muestra.", "rationale": "El microscopio electr√≥nico no ve colores (fotones), ve densidades de electrones.", "isCorrect": false },
                    { "text": "Para preservar la estructura celular y evitar su degradaci√≥n post-mortem.", "rationale": "La fijaci√≥n 'congela' qu√≠micamente las estructuras celulares creando enlaces cruzados entre prote√≠nas y l√≠pidos.", "isCorrect": true },
                    { "text": "Para hacer la muestra transparente.", "rationale": "Eso se hace en microscop√≠a √≥ptica (aclarado), no es la funci√≥n principal de la fijaci√≥n.", "isCorrect": false },
                    { "text": "Para aumentar el aumento.", "rationale": "El aumento depende de las lentes electromagn√©ticas, no del fijador.", "isCorrect": false }
                ],
                "hint": "Evita que la c√©lula se 'pudra' o cambie antes de verla."
            },
            {
                "questionNumber": 15,
                "question": "¬øQu√© organismo modelo se utiliza frecuentemente en biolog√≠a celular por ser una eucariota unicelular simple y f√°cil de cultivar?",
                "answerOptions": [
                    { "text": "Escherichia coli", "rationale": "Es el modelo procariota por excelencia, no eucariota.", "isCorrect": false },
                    { "text": "Saccharomyces cerevisiae (Levadura)", "rationale": "Es un hongo unicelular eucariota que comparte los procesos b√°sicos con las c√©lulas humanas.", "isCorrect": true },
                    { "text": "Drosophila melanogaster", "rationale": "Es un modelo animal pluricelular (mosca).", "isCorrect": false },
                    { "text": "Mus musculus", "rationale": "Es un mam√≠fero (rat√≥n), complejo y pluricelular.", "isCorrect": false }
                ],
                "hint": "Se usa tambi√©n para hacer pan y cerveza."
            }
        ];

        // --- VARIABLES DE ESTADO ---
        let currentSessionIndices = []; 
        let sessionScore = 0;
        let sessionAnsweredCount = 0;
        
        // Inicializamos datos extra (persistentes entre sesiones)
        rawQuizData.forEach(q => {
            q.userState = {
                answered: false,
                correct: null, 
                marked: false
            };
        });

        document.addEventListener('DOMContentLoaded', () => {
            startQuiz('all');
        });

        // --- FUNCI√ìN PRINCIPAL DE INICIO/REINICIO ---
        function startQuiz(mode) {
            currentSessionIndices = [];

            if (mode === 'all') {
                rawQuizData.forEach(q => {
                    q.userState.answered = false;
                    q.userState.correct = null;
                });
                currentSessionIndices = rawQuizData.map((_, i) => i);
            } 
            else if (mode === 'failed') {
                currentSessionIndices = rawQuizData
                    .map((q, i) => q.userState.correct === false ? i : -1)
                    .filter(index => index !== -1);
                
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            } 
            else if (mode === 'marked') {
                currentSessionIndices = rawQuizData
                    .map((q, i) => q.userState.marked === true ? i : -1)
                    .filter(index => index !== -1);
                    
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            }
            else if (mode === 'mixed') {
                currentSessionIndices = rawQuizData
                    .map((q, i) => (q.userState.correct === false || q.userState.marked === true) ? i : -1)
                    .filter(index => index !== -1);
                
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            }

            if (currentSessionIndices.length === 0) {
                alert("No hay preguntas seleccionadas para este modo.");
                return;
            }

            sessionScore = 0;
            sessionAnsweredCount = 0;

            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('final-results-container').style.display = 'none';
            document.getElementById('score-box').style.display = 'block';

            renderQuestions();
        }

        function renderQuestions() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            
            currentSessionIndices.forEach((originalIndex, sessionIndex) => {
                const q = rawQuizData[originalIndex];
                
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `card-${originalIndex}`;
                
                const checkedAttr = q.userState.marked ? 'checked' : '';
                
                let html = `
                    <label class="bookmark-wrapper">
                        <input type="checkbox" onchange="toggleBookmark(${originalIndex}, this)" ${checkedAttr}>
                        <span>Marcar</span>
                    </label>
                    <div class="question-text">${sessionIndex + 1}. ${q.question}</div>
                `;
                
                q.answerOptions.forEach((option, oIndex) => {
                    html += `
                        <div class="option" id="opt-${originalIndex}-${oIndex}" onclick="checkAnswer(${originalIndex}, ${oIndex})">
                            ${String.fromCharCode(65 + oIndex)}. ${option.text}
                            <div class="rationale" style="display:none;" id="rationale-${originalIndex}-${oIndex}">${option.rationale}</div>
                        </div>
                    `;
                });
                
                html += `<div class="hint"><strong>Pista:</strong> ${q.hint}</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
            updateScoreDisplay();
        }

        function toggleBookmark(originalIndex, checkbox) {
            rawQuizData[originalIndex].userState.marked = checkbox.checked;
        }

        function checkAnswer(originalIndex, selectedOIndex) {
            const q = rawQuizData[originalIndex];
            
            if (q.userState.answered) return;

            q.userState.answered = true;
            sessionAnsweredCount++;

            const isCorrect = q.answerOptions[selectedOIndex].isCorrect;
            q.userState.correct = isCorrect;

            const card = document.getElementById(`card-${originalIndex}`);
            const optionsDivs = card.querySelectorAll('.option');

            optionsDivs.forEach((div, idx) => {
                div.classList.add('disabled');
                document.getElementById(`rationale-${originalIndex}-${idx}`).style.display = 'block';

                if (q.answerOptions[idx].isCorrect) {
                    div.classList.add('correct');
                }
                if (idx === selectedOIndex && !q.answerOptions[idx].isCorrect) {
                    div.classList.add('incorrect');
                }
            });

            if (isCorrect) sessionScore++;

            updateScoreDisplay();
            checkCompletion();
        }

        function updateScoreDisplay() {
            const counter = document.getElementById('score-counter');
            counter.textContent = `Progreso sesi√≥n: ${sessionAnsweredCount}/${currentSessionIndices.length} (${sessionScore} aciertos)`;
        }

        function checkCompletion() {
            if (sessionAnsweredCount === currentSessionIndices.length) {
                setTimeout(displayFinalScore, 800);
            }
        }

        function displayFinalScore() {
            document.getElementById('quiz-container').style.display = 'none';
            
            const resultsContainer = document.getElementById('final-results-container');
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });

            const percentage = ((sessionScore / currentSessionIndices.length) * 100).toFixed(1);
            
            document.getElementById('final-score-text').innerHTML = 
                `Has acertado <strong>${sessionScore}</strong> de <strong>${currentSessionIndices.length}</strong> preguntas (${percentage}%) en esta sesi√≥n.`;

            const totalFailed = rawQuizData.filter(q => q.userState.correct === false).length;
            const totalMarked = rawQuizData.filter(q => q.userState.marked === true).length;
            const totalMixed = rawQuizData.filter(q => q.userState.correct === false || q.userState.marked === true).length;

            document.getElementById('final-stats').innerHTML = `
                <strong>Resumen Global:</strong><br>
                Preguntas Falladas (acumulado): ${totalFailed}<br>
                Preguntas Marcadas: ${totalMarked}
            `;

            document.getElementById('btn-failed').disabled = (totalFailed === 0);
            document.getElementById('btn-marked').disabled = (totalMarked === 0);
            document.getElementById('btn-mixed').disabled = (totalMixed === 0);
            
            document.getElementById('btn-failed').innerHTML = `‚ùå Repetir Falladas (${totalFailed})`;
            document.getElementById('btn-marked').innerHTML = `‚ö†Ô∏è Repetir Marcadas (${totalMarked})`;
        }
    </script>
</body>
</html>
