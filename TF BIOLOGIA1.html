<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen - Bloque 1: Fundamentos de la Biolog√≠a Celular</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        .score-box {
            background-color: #e9f7ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 25px;
            border: 1px solid #cce5ff;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question-card {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative; /* Para posicionar el marcador */
        }
        
        /* ESTILOS PARA EL MARCADOR (PESTA√ëA) */
        .bookmark-wrapper {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: #fff8e1;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #f1c40f;
            cursor: pointer;
            font-size: 0.9em;
            user-select: none;
        }
        .bookmark-wrapper:hover {
            background-color: #fcefdc;
        }
        .bookmark-wrapper input {
            cursor: pointer;
            accent-color: #f1c40f;
            width: 16px;
            height: 16px;
        }

        .question-text {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #495057;
            padding-right: 140px; /* Espacio para que el texto no se monte sobre el marcador */
        }
        .option {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid #ccc;
        }
        .option:hover:not(.disabled) {
            background-color: #f0f0f0;
            border-color: #007bff;
        }
        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .option.disabled {
            cursor: default;
        }
        .rationale {
            margin-top: 10px;
            padding: 10px;
            border-left: 5px solid #007bff;
            background-color: #eaf6ff;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            font-size: 0.95em;
        }
        .hint {
            margin-top: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        /* ESTILOS PARA EL PANEL FINAL DE BOTONES */
        .results-panel {
            margin-top: 30px;
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .action-btn:disabled { background-color: #ccc !important; cursor: not-allowed; transform: none; filter: none; }
        
        .btn-reset { background-color: #28a745; } /* Verde */
        .btn-failed { background-color: #dc3545; } /* Rojo */
        .btn-marked { background-color: #f39c12; color: #333; } /* Amarillo/Naranja */
        .btn-mixed { background-color: #6f42c1; } /* Morado */

    </style>
</head>
<body>
    <div class="container">
        <h1>Examen - Bloque 1: Fundamentos de la Biolog√≠a Celular</h1>
        <p>Profesora: Dra. Meritxell Llorca Torralba</p>
        
        <div class="score-box">
            <span id="score-counter">Cargando preguntas...</span>
        </div>
        
        <div id="quiz-container">
        </div>

        <div id="final-results-container" class="results-panel" style="display: none;">
            <h2 id="final-score-title">¬°Examen Completado!</h2>
            <p id="final-score-text" style="font-size: 1.2em;"></p>
            <p id="final-stats" style="color: #666;"></p>
            
            <div class="btn-grid">
                <button class="action-btn btn-reset" onclick="startQuiz('all')">üîÑ Repetir Examen Completo</button>
                <button class="action-btn btn-failed" id="btn-failed" onclick="startQuiz('failed')">‚ùå Repetir Falladas</button>
                <button class="action-btn btn-marked" id="btn-marked" onclick="startQuiz('marked')">‚ö†Ô∏è Repetir Marcadas</button>
                <button class="action-btn btn-mixed" id="btn-mixed" onclick="startQuiz('mixed')">‚ùå + ‚ö†Ô∏è Repetir Falladas y Marcadas</button>
            </div>
        </div>
    </div>

    <script>
        // DATOS DE LAS PREGUNTAS
        const rawQuizData = [
            // START OF QUESTION DATA (75 Questions)
            {
                "questionNumber": 1,
                "question": "¬øCu√°l es la disciplina fundamental en el Grado en Medicina, descrita como un pilar sobre el que se construyen conocimientos m√°s complejos sobre fisiolog√≠a y patolog√≠a?",
                "answerOptions": [
                    { "text": "Anatom√≠a Humana", "rationale": "La Anatom√≠a es estructural, pero la Biolog√≠a Celular es la base de los procesos funcionales y patol√≥gicos, seg√∫n el temario.", "isCorrect": false },
                    { "text": "Farmacolog√≠a", "rationale": "La Farmacolog√≠a se construye sobre conocimientos celulares, no es la disciplina fundamental b√°sica descrita.", "isCorrect": false },
                    { "text": "Histolog√≠a", "rationale": "La Histolog√≠a estudia tejidos (agrupaciones de c√©lulas), pero la Biolog√≠a Celular es el pilar m√°s b√°sico, seg√∫n el texto.", "isCorrect": false },
                    { "text": "Biolog√≠a Celular", "rationale": "El temario la describe expl√≠citamente como una 'disciplina fundamental' y 'un pilar' en el Grado de Medicina.", "isCorrect": true }
                ],
                "hint": "Recuerde el lema principal del curso que se encuentra en la introducci√≥n del Bloque 1."
            },
            {
                "questionNumber": 2,
                "question": "Seg√∫n el sistema de evaluaci√≥n mixto, ¬øcu√°l es la calificaci√≥n m√≠nima que se debe obtener en la parte de Teor√≠a del examen para superar la asignatura?",
                "answerOptions": [
                    { "text": "Cualquier nota, siempre que el promedio total sea $50\\%$.", "rationale": "Es imprescindible obtener una nota m√≠nima en ambas partes del examen, no solo en el promedio total.", "isCorrect": false },
                    { "text": "Un $60\\%$ de la nota.", "rationale": "El m√≠nimo es el $50\\%$ tanto en Teor√≠a como en Pr√°cticas/Seminarios del examen, no el $60\\%$.", "isCorrect": false },
                    { "text": "Un $50\\%$ de la nota.", "rationale": "Es imprescindible obtener una calificaci√≥n m√≠nima del $50\\%$ tanto en la parte de Teor√≠a como en la parte de Pr√°cticas y Seminarios del examen.", "isCorrect": true },
                    { "text": "No hay nota m√≠nima requerida en la Teor√≠a, solo en la Evaluaci√≥n Continua.", "rationale": "La nota m√≠nima se exige tanto en la Teor√≠a como en la parte de Pr√°cticas/Seminarios del examen final.", "isCorrect": false }
                ],
                "hint": "El requisito de nota m√≠nima aplica a las dos grandes secciones del examen final."
            },
            {
                "questionNumber": 3,
                "question": "En el sistema de evaluaci√≥n mixto, ¬øqu√© parte de la asignatura est√° cubierta por el $20\\%$ de la Evaluaci√≥n Continua?",
                "answerOptions": [
                    { "text": "Todo el contenido de Teor√≠a y Pr√°cticas 1-6.", "rationale": "El contenido de Teor√≠a se eval√∫a en el examen final ($80\\%$), no en la Evaluaci√≥n Continua.", "isCorrect": false },
                    { "text": "Solo las Pr√°cticas y Seminarios 7-12.", "rationale": "Las Pr√°cticas 7-12 se eval√∫an en la parte de Pr√°cticas y Seminarios del examen final.", "isCorrect": false },
                    { "text": "Todas las Pr√°cticas y Seminarios (1-12).", "rationale": "Todas las pr√°cticas y seminarios se eval√∫an √∫nicamente en el sistema de Evaluaci√≥n Global ($100\\%$).", "isCorrect": false },
                    { "text": "Pr√°cticas y Seminarios 1-6.", "rationale": "La Evaluaci√≥n Continua del $20\\%$ cubre las Pr√°cticas 1-6, que se centran en t√©cnicas de microscop√≠a y an√°lisis de imagen.", "isCorrect": true }
                ],
                "hint": "La Evaluaci√≥n Continua se centra en las sesiones iniciales de laboratorio y t√©cnicas."
            },
            {
                "questionNumber": 4,
                "question": "Si un estudiante opta por la EVALUACI√ìN GLOBAL de la asignatura, ¬øqu√© porcentaje de la nota final constituye el examen?",
                "answerOptions": [
                    { "text": "El $80\\%$ de la nota.", "rationale": "El $80\\%$ es el peso del examen en la Evaluaci√≥n Mixta, no en la Global.", "isCorrect": false },
                    { "text": "El $50\\%$ de la nota.", "rationale": "El $50\\%$ es el m√≠nimo requerido en cada parte, no el peso total del examen en la Evaluaci√≥n Global.", "isCorrect": false },
                    { "text": "El $100\\%$ de la nota.", "rationale": "En la Evaluaci√≥n Global, el examen final constituye el $100\\%$ de la nota, abarcando todo el temario.", "isCorrect": true },
                    { "text": "El $20\\%$ de la nota.", "rationale": "El $20\\%$ corresponde a la Evaluaci√≥n Continua, que se anula en el sistema Global.", "isCorrect": false }
                ],
                "hint": "La Evaluaci√≥n Global elimina la Evaluaci√≥n Continua, poniendo todo el peso en el examen."
            },
             // ... [AQU√ç IR√çAN EL RESTO DE TUS PREGUNTAS]
             // Para que el ejemplo funcione bien, a√±adir√© un par m√°s de relleno para simular el comportamiento
        ];

        // --- Generaci√≥n de placeholders para simular 75 preguntas si el array es corto ---
        // Esto es solo para que el c√≥digo funcione visualmente con el array corto proporcionado
        if (rawQuizData.length < 75) {
            for (let i = rawQuizData.length; i < 75; i++) {
                rawQuizData.push({
                    "questionNumber": i + 1,
                    "question": `(PREGUNTA ${i + 1} DE 75) Pregunta de relleno generada para demostraci√≥n.`,
                    "answerOptions": [
                        { "text": "Opci√≥n Incorrecta", "rationale": "Incorrecto.", "isCorrect": false },
                        { "text": "Opci√≥n Correcta", "rationale": "Correcto.", "isCorrect": true },
                        { "text": "Opci√≥n Incorrecta", "rationale": "Incorrecto.", "isCorrect": false },
                        { "text": "Opci√≥n Incorrecta", "rationale": "Incorrecto.", "isCorrect": false }
                    ],
                    "hint": "Esta es una pregunta autom√°tica."
                });
            }
        }

        // --- VARIABLES DE ESTADO ---
        let currentSessionIndices = []; // √çndices de las preguntas que se est√°n jugando AHORA
        let sessionScore = 0;
        let sessionAnsweredCount = 0;
        
        // Inicializamos datos extra en el objeto de preguntas (persistentes entre sesiones)
        rawQuizData.forEach(q => {
            q.userState = {
                answered: false,
                correct: null, // null, true, false
                marked: false
            };
        });

        document.addEventListener('DOMContentLoaded', () => {
            startQuiz('all');
        });

        // --- FUNCI√ìN PRINCIPAL DE INICIO/REINICIO ---
        function startQuiz(mode) {
            // 1. Definir qu√© preguntas entran en esta sesi√≥n
            currentSessionIndices = [];

            if (mode === 'all') {
                // Resetear todo (borrar respuestas previas) pero opcionalmente mantener marcas? 
                // Generalmente 'repetir test completo' implica reset total.
                rawQuizData.forEach(q => {
                    q.userState.answered = false;
                    q.userState.correct = null;
                    // q.userState.marked = false; // ¬øDesmarcar al reiniciar todo? Dej√©moslo marcado por si acaso.
                });
                currentSessionIndices = rawQuizData.map((_, i) => i);
            } 
            else if (mode === 'failed') {
                // Solo las que se respondieron mal
                currentSessionIndices = rawQuizData
                    .map((q, i) => q.userState.correct === false ? i : -1)
                    .filter(index => index !== -1);
                
                // Reseteamos el estado de respuesta SOLO para estas preguntas para poder reintentarlas
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            } 
            else if (mode === 'marked') {
                // Solo las marcadas
                currentSessionIndices = rawQuizData
                    .map((q, i) => q.userState.marked === true ? i : -1)
                    .filter(index => index !== -1);
                    
                // Reseteamos respuesta para poder jugar de nuevo
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            }
            else if (mode === 'mixed') {
                // Falladas O Marcadas
                currentSessionIndices = rawQuizData
                    .map((q, i) => (q.userState.correct === false || q.userState.marked === true) ? i : -1)
                    .filter(index => index !== -1);
                
                currentSessionIndices.forEach(i => {
                    rawQuizData[i].userState.answered = false;
                    rawQuizData[i].userState.correct = null;
                });
            }

            // 2. Validar si hay preguntas
            if (currentSessionIndices.length === 0) {
                alert("No hay preguntas seleccionadas para este modo.");
                return;
            }

            // 3. Resetear contadores de sesi√≥n
            sessionScore = 0;
            sessionAnsweredCount = 0;

            // 4. Mostrar interfaz de quiz y ocultar resultados
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('final-results-container').style.display = 'none';
            document.getElementById('score-box').style.display = 'block'; // Asegurar que se ve

            renderQuestions();
        }

        function renderQuestions() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            
            // Iteramos sobre los √≠ndices de la sesi√≥n actual
            currentSessionIndices.forEach((originalIndex, sessionIndex) => {
                const q = rawQuizData[originalIndex];
                
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `card-${originalIndex}`; // ID √∫nico basado en el √≠ndice original
                
                // Checkbox de "Marcar"
                const checkedAttr = q.userState.marked ? 'checked' : '';
                
                let html = `
                    <label class="bookmark-wrapper">
                        <input type="checkbox" onchange="toggleBookmark(${originalIndex}, this)" ${checkedAttr}>
                        <span>Marcar para revisar</span>
                    </label>
                    <div class="question-text">${q.questionNumber}. ${q.question}</div>
                `;
                
                q.answerOptions.forEach((option, oIndex) => {
                    html += `
                        <div class="option" id="opt-${originalIndex}-${oIndex}" onclick="checkAnswer(${originalIndex}, ${oIndex})">
                            ${String.fromCharCode(65 + oIndex)}. ${option.text}
                            <div class="rationale" style="display:none;" id="rationale-${originalIndex}-${oIndex}">${option.rationale}</div>
                        </div>
                    `;
                });
                
                html += `<div class="hint"><strong>Pista:</strong> ${q.hint}</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
            updateScoreDisplay();
        }

        // Funci√≥n para manejar el marcado/desmarcado
        function toggleBookmark(originalIndex, checkbox) {
            rawQuizData[originalIndex].userState.marked = checkbox.checked;
        }

        function checkAnswer(originalIndex, selectedOIndex) {
            const q = rawQuizData[originalIndex];
            
            // Si ya se respondi√≥, salir
            if (q.userState.answered) return;

            // Marcar como respondida
            q.userState.answered = true;
            sessionAnsweredCount++;

            const isCorrect = q.answerOptions[selectedOIndex].isCorrect;
            q.userState.correct = isCorrect; // Guardar estado de acierto/fallo

            // Actualizar UI de esta tarjeta
            const card = document.getElementById(`card-${originalIndex}`);
            const optionsDivs = card.querySelectorAll('.option');

            optionsDivs.forEach((div, idx) => {
                div.classList.add('disabled'); // Deshabilitar clicks
                
                // Mostrar justificaci√≥n
                document.getElementById(`rationale-${originalIndex}-${idx}`).style.display = 'block';

                // Colorear
                if (q.answerOptions[idx].isCorrect) {
                    div.classList.add('correct');
                }
                if (idx === selectedOIndex && !q.answerOptions[idx].isCorrect) {
                    div.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                sessionScore++;
            }

            updateScoreDisplay();
            checkCompletion();
        }

        function updateScoreDisplay() {
            const counter = document.getElementById('score-counter');
            counter.textContent = `Progreso sesi√≥n: ${sessionAnsweredCount}/${currentSessionIndices.length} (${sessionScore} aciertos)`;
        }

        function checkCompletion() {
            // Si se han respondido todas las de la sesi√≥n actual
            if (sessionAnsweredCount === currentSessionIndices.length) {
                setTimeout(displayFinalScore, 800); // Peque√±o delay para UX
            }
        }

        function displayFinalScore() {
            document.getElementById('quiz-container').style.display = 'none';
            // document.getElementById('score-box').style.display = 'none'; // Opcional ocultar la barra superior
            
            const resultsContainer = document.getElementById('final-results-container');
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });

            // Calcular porcentajes de la sesi√≥n
            const percentage = ((sessionScore / currentSessionIndices.length) * 100).toFixed(1);
            
            document.getElementById('final-score-text').innerHTML = 
                `Has acertado <strong>${sessionScore}</strong> de <strong>${currentSessionIndices.length}</strong> preguntas (${percentage}%) en esta sesi√≥n.`;

            // Calcular estad√≠sticas GLOBALES para habilitar/deshabilitar botones
            const totalFailed = rawQuizData.filter(q => q.userState.correct === false).length;
            const totalMarked = rawQuizData.filter(q => q.userState.marked === true).length;
            const totalMixed = rawQuizData.filter(q => q.userState.correct === false || q.userState.marked === true).length;

            document.getElementById('final-stats').innerHTML = `
                <strong>Resumen Global:</strong><br>
                Preguntas Falladas (acumulado): ${totalFailed}<br>
                Preguntas Marcadas: ${totalMarked}
            `;

            // Configurar botones
            document.getElementById('btn-failed').disabled = (totalFailed === 0);
            document.getElementById('btn-marked').disabled = (totalMarked === 0);
            document.getElementById('btn-mixed').disabled = (totalMixed === 0);
            
            // Textos din√°micos en botones
            document.getElementById('btn-failed').innerHTML = `‚ùå Repetir Falladas (${totalFailed})`;
            document.getElementById('btn-marked').innerHTML = `‚ö†Ô∏è Repetir Marcadas (${totalMarked})`;
        }
    </script>
</body>
</html>
