<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Anatomía - Sistema Urinario Bajo</title>
    <style>
        :root {
            --primary-color: #3f51b5; /* Índigo para Urinario */
            --secondary-color: #5c6bc0;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --background-color: #e8eaf6;
            --card-background: #ffffff;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #283593;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3949ab;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            text-align: center;
            background-color: #1a237e;
            border-bottom: 1px solid #3949ab;
        }

        .sidebar-header h2 { margin: 0; font-size: 1.1rem; }
        
        .sidebar-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .sidebar-stats { font-size: 0.9rem; color: #c5cae9; }

        .finish-btn-side {
            background-color: #f1c40f;
            border: none;
            border-radius: 4px;
            color: #283593;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            width: 80%;
            transition: 0.2s;
        }
        .finish-btn-side:hover { background-color: #f39c12; }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px;
            align-content: start;
        }

        .nav-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 4px;
            background-color: #3949ab;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: 0.2s;
        }

        .nav-btn:hover { background-color: var(--secondary-color); }
        .nav-btn.correct { background-color: var(--success-color); }
        .nav-btn.incorrect { background-color: var(--error-color); }
        .nav-btn.marked { border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; }

        /* MAIN CONTENT */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; }
        
        .topic-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 30px 0 15px 0;
            font-size: 1.2rem;
        }

        .question-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            scroll-margin-top: 20px;
        }

        .question-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .bookmark-btn {
            background: none;
            border: 1px solid #9fa8da;
            border-radius: 4px;
            cursor: pointer;
            color: #5c6bc0;
            padding: 2px 8px;
        }
        .bookmark-btn.active { color: #f39c12; border-color: #f39c12; background: #fff9c4; }

        .question-text { font-size: 1.1rem; color: #1a237e; margin-bottom: 15px; font-weight: 600; line-height: 1.4; }

        .options-grid { display: flex; flex-direction: column; gap: 8px; }

        .option-btn {
            padding: 10px 15px;
            border: 1px solid #c5cae9;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover:not(.disabled) { background-color: #e8eaf6; border-color: var(--primary-color); }
        
        .option-btn.correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.incorrect { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .option-btn.disabled { cursor: default; opacity: 0.7; }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-size: 0.9rem;
        }
        .feedback.show { display: block; }
        .feedback.success { background-color: #e8f8f5; color: #0e6251; }
        .feedback.error { background-color: #fdedec; color: #78281f; }

        /* RESULT PANEL */
        .results-panel {
            background: #283593;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 40px;
            display: none;
            margin-bottom: 50px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { background: #3f51b5; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: 160px; border-right: none; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .sidebar-nav { grid-template-columns: repeat(8, 1fr); max-height: 150px; }
            .main-content { overflow: visible; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>Urinario Bajo</h2>
        <div class="sidebar-controls">
            <div class="sidebar-stats"><span id="progress-text">0/61</span> respondidas</div>
            <button class="finish-btn-side" onclick="showResults(true)">Finalizar Test</button>
        </div>
    </div>
    <div id="sidebar-nav" class="sidebar-nav"></div>
</div>

<div class="main-content">
    <div class="container">
        <h1>Anatomía Urinaria: Uréter, Vejiga y Uretra</h1>
        <div id="questions-list"></div>
        
        <div id="results-panel" class="results-panel">
            <h2>Test Finalizado</h2>
            <p id="score-text" style="font-size: 1.4rem; margin: 15px 0;"></p>
            <div class="action-buttons">
                <button class="action-btn" onclick="resetQuiz('all')">Repetir Todo</button>
                <button class="action-btn" onclick="resetQuiz('wrong')">Repetir Falladas</button>
                <button class="action-btn" onclick="resetQuiz('marked')">Repetir Marcadas</button>
                <button class="action-btn" onclick="resetQuiz('wrong_marked')">Falladas + Marcadas</button>
            </div>
        </div>
    </div>
</div>

<script>
    // BASE DE DATOS - TEMAS 30, 31, 32
    const dbQuestions = [
        // --- TEMA 30: URÉTERES ---
        { id: 1, topic: "Tema 30. Uréteres", original: "1", q: "Como se denomina el estrechamiento fisiológico en la porción inicial de los uréteres:", options: ["Esfínter pélvico del uréter", "Unión pieloureteral", "Trígono vesical", "Unión calicoureteral"], correct: 1, exp: "Unión de la pelvis renal con el uréter." },
        { id: 2, topic: "Tema 30. Uréteres", original: "2", q: "Cuál de las siguientes no es rama de la arteria ilíaca interna:", options: ["Rectal media", "Epigástrica inferior", "Uterina", "Pudenda interna"], correct: 1, exp: "La epigástrica inferior es rama de la ilíaca externa." },
        { id: 3, topic: "Tema 30. Uréteres", original: "3", q: "El reflujo de la orina es impedido por... excepto una respuesta:", options: ["Porción intraparietal en la vejiga", "Unión pieloureteral", "Las fibras musculares lisas circulares del uréter", "Los vasos iliacos"], correct: 3, exp: "Los vasos ilíacos no tienen función esfinteriana antirreflujo." },
        { id: 4, topic: "Tema 30. Uréteres", original: "3 (Texto)", q: "En su trayecto abdominal, los uréteres no presentan una de las siguiente relaciones:", options: ["Se relacionan con los nervios iliohipogástricos", "Descienden junto a las arterias gonadales", "Es retroperitoneal", "Se adhieren a la fascia del musculo psoas", "Es intraperitoneal (Opción implícita incorrecta en contexto)"], correct: 4, exp: "Los uréteres son retroperitoneales." },
        { id: 5, topic: "Tema 30. Uréteres", original: "4", q: "Sobre la porción intrínseca del uréter, una de las propiedades es falsa:", options: ["Las fibras circulares del uréter crean un mecanismo esfinteriano antes de penetrar en la vejiga", "Su orificio de salida es oval", "Las fibras musculares lisas del músculo detrusor crean lazadas sobre esta porción", "Los forámenes de salida se encuentran en los vértices del trígono vesical"], correct: 1, exp: "El orificio ureteral suele ser una hendidura, no un óvalo abierto (salvo patología)." },
        { id: 6, topic: "Tema 30. Uréteres", original: "5", q: "Los uréteres son:", options: ["Anteriores a las arterias espermáticas", "Posteriores a las arterias espermáticas", "Posteriores a las arterias ilíacas externas", "Posteriores a las arterias ilíacas internas"], correct: 1, exp: "Los vasos gonadales (espermáticos) cruzan por delante del uréter." },
        { id: 7, topic: "Tema 30. Uréteres", original: "6", q: "¿Cómo se denomina el estrechamiento fisiológico en la porción inicial de los uréteres? (Repetida)", options: ["Trígono vesical", "Esfínter pélvico del uréter", "Unión pieloureteral", "Unión calicoureteral"], correct: 2, exp: "Repetida." },
        { id: 8, topic: "Tema 30. Uréteres", original: "7", q: "En la mujer, ¿qué elemento cruza por encima de los uréteres en el trayecto que estos desarrollan en la pelvis?", options: ["Uretra", "Ligamentos uterosacros", "Ligamento redondo del útero", "Arteria uterina"], correct: 3, exp: "Agua (orina) bajo el puente (arteria uterina)." },
        { id: 9, topic: "Tema 30. Uréteres", original: "8.1", q: "El reflujo de la orina no es impedido por: (Repetida)", options: ["Las fibras musculares lisas longitudinales del uréter", "Unión pieloureteral", "Los vasos iliacos", "Porción intraparietal en la vejiga"], correct: 2, exp: "Repetida." },
        { id: 10, topic: "Tema 30. Uréteres", original: "9", q: "Cuál de los siguientes vasos cruza anteriormente a los uréteres", options: ["Arteria esplénica", "Arteria mesentérica superior", "Arteria mesentérica inferior", "Arterias gonadales", "Vena cólica media"], correct: 3, exp: "Vasos gonadales." },
        { id: 11, topic: "Tema 30. Uréteres", original: "10", q: "Qué elemento cruza por encima de los uréteres en el trayecto que estos desarrollan en la pelvis (Repetida)", options: ["Arteria uterina", "Uréter", "Ligamento propio del ovario", "Ligamento redondo del útero"], correct: 0, exp: "Repetida." },
        { id: 12, topic: "Tema 30. Uréteres", original: "11", q: "¿Cómo se denomina el estrechamiento fisiológico en la porción inicial de los uréteres? (Repetida 3)", options: ["Unión pieloureteral", "Esfínter interno de la uretra", "Trígono vesical", "Esfínter externo de la uretra"], correct: 0, exp: "Repetida." },
        { id: 13, topic: "Tema 30. Uréteres", original: "12", q: "¿Qué propiedades extrínsecas o intrínsecas a los uréteres impiden el retorno de la orina desde la vejiga urinaria a los riñones?", options: ["Porción intraparietal en la vejiga (Trayecto oblicuo)", "Relación con los vasos ilíacos", "Constitución intrínseca pared", "Unión pieloureteral", "A y C"], correct: 4, exp: "El trayecto oblicuo y el tono muscular (mecanismo de Waldeyer) evitan el reflujo." },
        { id: 14, topic: "Tema 30. Uréteres", original: "13", q: "En su trayecto abdominal, los uréteres no mantienen la siguiente relación: (Repetida)", options: ["Se sitúan retroperitonealmente", "Se apoyan sobre la cara anterior del músculo psoas", "Se sitúan intraperitonealmente", "Descienden de forma conjunta con las arterias gonadales (cruce)"], correct: 2, exp: "Falso: No son intraperitoneales." },
        { id: 15, topic: "Tema 30. Uréteres", original: "14", q: "El origen del uréter derecho se relaciona con:", options: ["Segunda porción duodeno", "Tercera porción", "Estómago", "Bazo"], correct: 0, exp: "Relación anterior." },
        { id: 16, topic: "Tema 30. Uréteres", original: "15", q: "El segmento iliaco del uréter derecho se relaciona con:", options: ["Vasos iliacos primitivos (o externos)", "Aorta", "Cava", "Renales"], correct: 0, exp: "Cruza los vasos ilíacos (Derecho: Iliaca externa; Izquierdo: Iliaca común)." },
        { id: 17, topic: "Tema 30. Uréteres", original: "56 (Extra)", q: "La estenosis ureteral más caudal está situada:", options: ["En la porción yuxtaintramural (Intramural)", "Unión pieloureteral", "Cruce iliaco", "Salida pelvis"], correct: 0, exp: "La entrada a la vejiga es el punto más estrecho." },
        { id: 18, topic: "Tema 30. Uréteres", original: "Extra", q: "El uréter izquierdo cruza a la altura de la bifurcación de:", options: ["Arteria iliaca común (primitiva)", "Arteria iliaca externa", "Arteria femoral", "Aorta"], correct: 0, exp: "El izquierdo cruza la común, el derecho la externa." },
        { id: 19, topic: "Tema 30. Uréteres", original: "Extra", q: "En la base del ligamento ancho el uréter cruza a: (Repetida)", options: ["La arteria uterina", "La trompa", "El conducto deferente", "El plexo hipogástrico"], correct: 0, exp: "Repetida." },
        { id: 20, topic: "Tema 30. Uréteres", original: "Extra", q: "Los uréteres se apoyan en su descenso abdominal sobre:", options: ["Músculo psoas mayor", "Músculo cuadrado lumbar", "Músculo transverso", "Peritoneo parietal anterior"], correct: 0, exp: "Descienden sobre el psoas." },

        // --- TEMA 31: VEJIGA ---
        { id: 21, topic: "Tema 31. Vejiga", original: "1", q: "El trígono vesical deriva de:", options: ["Mesodermo intermedio (Conductos mesonéfricos)", "Mesodermo paraxial", "Endodermo", "Ectodermo"], correct: 0, exp: "Absorción de los conductos de Wolff." },
        { id: 22, topic: "Tema 31. Vejiga", original: "Extra", q: "Cuál de las siguientes estructuras se tapizan en el pliegue umbilical medio:", options: ["Uraco", "Art Epigástricas externa", "Arteria Iliaca externa", "Venas epigástricas inferiores"], correct: 0, exp: "El uraco obliterado forma el ligamento umbilical medio." },
        { id: 23, topic: "Tema 31. Vejiga", original: "2", q: "La cara posterior de la vejiga se relaciona fundamentalmente en la mujer con:", options: ["La vagina (y cérvix)", "El recto", "Los ovarios", "Hueso pubis"], correct: 0, exp: "Tabique vesicovaginal." },
        { id: 24, topic: "Tema 31. Vejiga", original: "3", q: "La zona de la vejiga que determinan los orificios ureterales y uretral se denomina:", options: ["Úvula de la vejiga", "Trígono", "Vértice", "Fondo"], correct: 1, exp: "Trígono vesical de Lieutaud." },
        { id: 25, topic: "Tema 31. Vejiga", original: "4", q: "Los uréteres desembocan en la vejiga a nivel de:", options: ["El vértice del trígono (Cuello)", "El cuello", "La cara superior", "Los ángulos postero externos del trígono"], correct: 3, exp: "Base del trígono." },
        { id: 26, topic: "Tema 31. Vejiga", original: "5", q: "En la mujer, la vejiga por su cara posterior se relaciona con el: (Repetida)", options: ["Útero (y vagina)", "Recto", "Colon sigmoideo", "Ileon"], correct: 0, exp: "Repetida." },
        { id: 27, topic: "Tema 31. Vejiga", original: "6", q: "Región de la cara posterior de la vejiga urinaria, en cuyos vértices asoman la luz de ambos uréteres:", options: ["Esfínter interno de la uretra", "Trígono vesical", "Unión pieloureteral", "Esfínter externo"], correct: 1, exp: "Repetida." },
        { id: 28, topic: "Tema 31. Vejiga", original: "7", q: "En la base del ligamento ancho el uréter cruza a: (Repetida)", options: ["La arteria uterina", "La trompa", "El conducto deferente", "El plexo hipogástrico"], correct: 0, exp: "Repetida." },
        { id: 29, topic: "Tema 31. Vejiga", original: "8", q: "Qué porción del aparato genitourinario no procede mayoritariamente del mesodermo intermedio:", options: ["Vejiga (Endodermo)", "Uréteres", "Riñones", "Glándulas seminales"], correct: 0, exp: "Repetida." },
        { id: 30, topic: "Tema 31. Vejiga", original: "9", q: "¿Cuál de las siguientes arterias se encuentra atrofiada en el adulto?", options: ["Uterina", "Ovárica", "Pudenda", "Testicular", "Umbilical"], correct: 4, exp: "Repetida." },
        { id: 31, topic: "Tema 31. Vejiga", original: "10", q: "Indique qué afirmación ES CIERTA con respecto a la micción:", options: ["El deseo de eliminar la orina se produce cuando se alcanzan los 150 ml...", "Nunca es urgente", "Es voluntaria siempre", "No depende de reflejos"], correct: 0, exp: "Reflejo de micción a partir de 150-300ml." },
        { id: 32, topic: "Tema 31. Vejiga", original: "16", q: "La cara inferior vesical se apoya sobre:", options: ["Músculo transverso perineal profundo (y suelo pélvico)", "Recto", "Útero", "Sacro"], correct: 0, exp: "Diafragma urogenital/pélvico." },
        { id: 33, topic: "Tema 31. Vejiga", original: "17", q: "EI vértice de la vejiga se encuentra orientado:", options: ["Cranealmente (y anterior)", "Caudalmente", "Medialmente", "Lateralmente"], correct: 0, exp: "Hacia el uraco." },
        { id: 34, topic: "Tema 31. Vejiga", original: "18", q: "¿La arteria vesical superior es rama directa de la arteria?", options: ["Umbilical", "Uterina", "Pudenda", "Rectal"], correct: 0, exp: "Porción permeable de la umbilical." },
        { id: 35, topic: "Tema 31. Vejiga", original: "19", q: "Mantiene un tono que evita la salida no voluntaria de la orina:", options: ["Esfínter interno de la uretra", "Trígono vesical", "Unión pieloureteral", "Esfínter externo"], correct: 0, exp: "Mecanismo de continencia involuntario." },
        { id: 36, topic: "Tema 31. Vejiga", original: "19 (Extra)", q: "De los espacios virtuales que rodean la vejiga urinaria, cuál es mayor y con más significancia clínica:", options: ["Retropúbico (Retzius)", "Preperitoneal", "Perivesical", "Retrovesical"], correct: 0, exp: "Espacio prevesical de Retzius." },
        { id: 37, topic: "Tema 31. Vejiga", original: "Extra", q: "La inervación parasimpática motora del músculo detrusor procede de:", options: ["Nervios esplácnicos pélvicos (S2-S4)", "Nervio hipogástrico", "Nervio pudendo", "Nervio genitofemoral"], correct: 0, exp: "Parasimpático sacro." },
        { id: 38, topic: "Tema 31. Vejiga", original: "Extra", q: "La capacidad fisiológica media de la vejiga es de:", options: ["100 ml", "300-500 ml", "1 litro", "2 litros"], correct: 1, exp: "Aprox medio litro antes de dolor intenso." },
        { id: 39, topic: "Tema 31. Vejiga", original: "Extra", q: "El músculo que forma la pared de la vejiga se llama:", options: ["Cremáster", "Detrusor", "Dartos", "Psoas"], correct: 1, exp: "Músculo Detrusor." },
        { id: 40, topic: "Tema 31. Vejiga", original: "Extra", q: "La úvula vesical se encuentra en:", options: ["El vértice", "El orificio uretral interno (cuello)", "El fondo", "Los uréteres"], correct: 1, exp: "Prominencia en el cuello vesical (lóbulo medio próstata)." },

        // --- TEMA 32: URETRA ---
        { id: 41, topic: "Tema 32. Uretra", original: "1", q: "El trígono vesical deriva de: (Repetida)", options: ["Ectodermo", "Endodermo", "Mesodermo (Conductos Wolff)", "Cresta neural"], correct: 2, exp: "Repetida." },
        { id: 42, topic: "Tema 32. Uretra", original: "2", q: "El seno frontal desemboca en: (Pregunta textual extraña en este tema)", options: ["El meato superior", "Las celdillas etmoidales posteriores", "El meato medio", "El meato inferior"], correct: 2, exp: "Literal del texto (Meato medio). Anatomía nasal." },
        { id: 43, topic: "Tema 32. Uretra", original: "3", q: "Durante la eyaculación, ¿qué estructura gracias a su tono impide el retorno de líquido seminal a la luz vesical?", options: ["Unión pieloureteral", "Esfínter interno de la uretra", "Esfínter externo de la uretra", "Trígono vesical"], correct: 1, exp: "Evita la eyaculación retrógrada." },
        { id: 44, topic: "Tema 32. Uretra", original: "4", q: "La uretra masculina:", options: ["Tiene 2 porciones", "Tiene 3 porciones (o 4)", "No se divide", "Es corta"], correct: 1, exp: "Clásicamente 3: Prostática, Membranosa, Esponjosa. (A veces 4 con la preprostática)." },
        { id: 45, topic: "Tema 32. Uretra", original: "5", q: "Cómo se denomina el estrechamiento en la porción inicial de la uretra masculina:", options: ["Esfínter externo de la uretra", "Fosa navicular", "Porción membranosa", "Esfínter interno de la uretra (Cuello)"], correct: 2, exp: "Nota: El texto suele considerar la membranosa como la porción más estrecha y fija (istmo), aunque el esfínter interno está al inicio. En preguntas tipo test, 'estrechamiento' suele referir a la membranosa o meato." },
        { id: 46, topic: "Tema 32. Uretra", original: "6", q: "Como se denomina la sobreelevación en la cara posterior del seno prostático:", options: ["Colículo seminal (Veru montanum)", "Conductos eyaculadores", "Utrículo", "Conductillos"], correct: 0, exp: "Veru montanum." },
        { id: 47, topic: "Tema 32. Uretra", original: "7", q: "Durante la eyaculación de líquido seminal, un elemento impide la eyaculación retrógrada: (Repetida)", options: ["Esfínter uretral interno", "Músculo detrusor", "Utrículo prostático", "Uréter intramural"], correct: 0, exp: "Repetida." },
        { id: 48, topic: "Tema 32. Uretra", original: "8", q: "Mantiene un tono que evita la salida no voluntaria de la orina (Repetida)", options: ["Esfínter interno de la uretra", "Trígono vesical", "Unión pieloureteral", "Esfínter externo de la uretra"], correct: 0, exp: "Repetida." },
        { id: 49, topic: "Tema 32. Uretra", original: "9", q: "Qué estructura atraviesa la membrana del seno urogenital tanto en el hombre como en la mujer:", options: ["Uretra", "Meato uretral", "Vestíbulo vaginal", "Vagina"], correct: 0, exp: "Uretra membranosa." },
        { id: 50, topic: "Tema 32. Uretra", original: "10", q: "Dilatación de la luz uretral a su paso por la próstata:", options: ["Músculo isquiocavernoso", "Músculo bulboesponjoso", "Glándula bulbouretral", "Seno prostático"], correct: 3, exp: "El seno prostático es la zona dilatada." },
        { id: 51, topic: "Tema 32. Uretra", original: "11", q: "El seno urogenital es de origen:", options: ["Ectodérmico", "Mesodérmico paraxial", "Endodérmico", "Mesodérmico intermedio"], correct: 2, exp: "Endodermo (parte de la cloaca)." },
        { id: 52, topic: "Tema 32. Uretra", original: "12", q: "El aparato urogenital deriva de:", options: ["Intestino primitivo medio", "Túbulos de Wolf y Müller (Mesodermo Intermedio)", "Mesonefros", "Cresta neural"], correct: 1, exp: "Mesodermo intermedio." },
        { id: 53, topic: "Tema 32. Uretra", original: "13", q: "La uretra en el hombre se divide en las porciones:", options: ["Próstatica, membranosa y esponjosa", "Prostática, vesical y esponjosa", "Prostática, uretral y esponjosa", "Prostática, seminal y esponjosa"], correct: 0, exp: "División anatómica clásica." },
        { id: 54, topic: "Tema 32. Uretra", original: "14", q: "La cara posterior de la uretra femenina se relaciona con:", options: ["La pared anterior del recto", "La pared anterior de la vagina", "La pared anterior de la vejiga", "La pared posterior del útero"], correct: 1, exp: "Tabique uretrovaginal." },
        { id: 55, topic: "Tema 32. Uretra", original: "15", q: "Estructura de musculatura estriada, controlada por el nervio pudendo:", options: ["Esfínter externo de la uretra", "Detrusor", "Esfínter interno de la uretra", "Conducto deferente"], correct: 0, exp: "Voluntario." },
        { id: 56, topic: "Tema 32. Uretra", original: "16", q: "La porción más débil de la uretra masculina es:", options: ["Perineal o membranosa", "Prostática", "Esponjosa", "Navicular"], correct: 0, exp: "La membranosa es la más fija y susceptible a trauma." },
        { id: 57, topic: "Tema 32. Uretra", original: "17", q: "Qué estructura tiene una forma tubular, aplanada anteriormente:", options: ["La uretra", "El meato uretral", "El vestíbulo vaginal", "La vagina"], correct: 3, exp: "La vagina es tubular aplanada (H)." },
        { id: 58, topic: "Tema 32. Uretra", original: "Extra", q: "¿Dónde desembocan los conductos eyaculadores?", options: ["Uretra membranosa", "Uretra prostática (Colículo)", "Uretra esponjosa", "Vejiga"], correct: 1, exp: "En el veru montanum." },
        { id: 59, topic: "Tema 32. Uretra", original: "Extra", q: "Las glándulas de Cowper (bulbouretrales) desembocan en:", options: ["Uretra prostática", "Uretra membranosa", "Uretra esponjosa (bulbar)", "Vejiga"], correct: 2, exp: "En el inicio de la esponjosa." },
        { id: 60, topic: "Tema 32. Uretra", original: "Extra", q: "La uretra femenina mide aproximadamente:", options: ["4 cm", "10 cm", "15 cm", "20 cm"], correct: 0, exp: "Es corta (3-4 cm)." },
        { id: 61, topic: "Tema 32. Uretra", original: "Extra", q: "¿Qué estructura se encuentra en el centro del colículo seminal?", options: ["Utrículo prostático", "Conducto eyaculador", "Conductillos prostáticos", "Esfínter"], correct: 0, exp: "El utrículo (vagina masculina)." }
    ];

    let currentQuestions = [...dbQuestions];
    let markedIds = new Set();
    let userAnswers = {};

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function renderQuiz() {
        const list = document.getElementById('questions-list');
        const nav = document.getElementById('sidebar-nav');
        const resultsPanel = document.getElementById('results-panel');
        
        list.innerHTML = '';
        nav.innerHTML = '';
        resultsPanel.style.display = 'none';

        if(currentQuestions.length === 0) {
            list.innerHTML = `<div class="question-card"><p>No hay preguntas para los criterios seleccionados.</p></div>`;
            return;
        }

        let lastTopic = "";

        currentQuestions.forEach((q, index) => {
            if (q.topic !== lastTopic) {
                const header = document.createElement('div');
                header.className = 'topic-header';
                header.innerText = q.topic;
                list.appendChild(header);
                lastTopic = q.topic;
            }

            const btn = document.createElement('a');
            btn.href = `#q-${q.id}`;
            btn.className = 'nav-btn';
            btn.innerText = index + 1;
            btn.id = `nav-btn-${q.id}`;
            
            if (userAnswers[q.id] === true) btn.classList.add('correct');
            if (userAnswers[q.id] === false) btn.classList.add('incorrect');
            if (markedIds.has(q.id)) btn.classList.add('marked');

            nav.appendChild(btn);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-${q.id}`;

            const originalOptions = q.options.map((text, i) => ({ text: text, isCorrect: i === q.correct }));
            const finalOptions = shuffle(originalOptions);

            let optionsHTML = '';
            finalOptions.forEach(opt => {
                const safeText = opt.text.replace(/'/g, "&#39;"); 
                optionsHTML += `<button class="option-btn" onclick="handleAnswer(${q.id}, ${opt.isCorrect}, this)">${opt.text}</button>`;
            });

            const isMarked = markedIds.has(q.id);

            card.innerHTML = `
                <div class="question-header-row">
                    <span>Pregunta ${index + 1} (Ref: ${q.original})</span>
                    <button class="bookmark-btn ${isMarked ? 'active' : ''}" onclick="toggleMark(${q.id}, this)">
                        ${isMarked ? '★ Marcada' : '☆ Marcar'}
                    </button>
                </div>
                <div class="question-text">${q.q}</div>
                <div class="options-grid" id="opts-${q.id}">
                    ${optionsHTML}
                </div>
                <div class="feedback" id="feed-${q.id}"></div>
            `;
            list.appendChild(card);
        });
        updateProgress();
    }

    function handleAnswer(id, isCorrect, btn) {
        if (userAnswers.hasOwnProperty(id)) return;
        
        userAnswers[id] = isCorrect;
        const navBtn = document.getElementById(`nav-btn-${id}`);
        const feedback = document.getElementById(`feed-${id}`);
        const container = document.getElementById(`opts-${id}`);
        const qData = dbQuestions.find(x => x.id === id);

        // CORRECCIÓN APLICADA AQUÍ: Usar el índice numérico
        const correctText = qData.options[qData.correct];

        const allBtns = container.querySelectorAll('.option-btn');
        allBtns.forEach(b => {
            b.classList.add('disabled');
            b.onclick = null;
            if (b.innerText === correctText) b.classList.add('correct');
        });

        if (isCorrect) {
            feedback.innerHTML = `<strong>¡Correcto!</strong><br>${qData.exp}`;
            feedback.className = 'feedback success show';
            if(navBtn) navBtn.classList.add('correct');
        } else {
            btn.classList.add('incorrect');
            feedback.innerHTML = `<strong>Incorrecto.</strong><br>${qData.exp}`;
            feedback.className = 'feedback error show';
            if(navBtn) navBtn.classList.add('incorrect');
        }
        updateProgress();
    }

    function toggleMark(id, btn) {
        const navBtn = document.getElementById(`nav-btn-${id}`);
        if (markedIds.has(id)) {
            markedIds.delete(id);
            btn.innerHTML = '☆ Marcar';
            btn.classList.remove('active');
            if(navBtn) navBtn.classList.remove('marked');
        } else {
            markedIds.add(id);
            btn.innerHTML = '★ Marcada';
            btn.classList.add('active');
            if(navBtn) navBtn.classList.add('marked');
        }
    }

    function updateProgress() {
        const count = Object.keys(userAnswers).length;
        const total = currentQuestions.length;
        document.getElementById('progress-text').innerText = `${count}/${total} respondidas`;
        
        if (count === total && total > 0) {
            showResults(false);
        }
    }

    function showResults(manualFinish = false) {
        const panel = document.getElementById('results-panel');
        let correct = 0;
        Object.values(userAnswers).forEach(v => { if(v) correct++; });
        
        const total = currentQuestions.length;
        
        document.getElementById('score-text').innerText = `Has acertado ${correct} de ${total}`;
        panel.style.display = 'block';
        
        if(manualFinish) {
            panel.scrollIntoView({ behavior: 'smooth' });
        } else {
            setTimeout(() => panel.scrollIntoView({ behavior: 'smooth' }), 100);
        }
    }

    function resetQuiz(mode) {
        let nextIds = [];

        if (mode === 'all') {
            nextIds = dbQuestions.map(q => q.id);
        } else if (mode === 'wrong') {
            nextIds = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
        } else if (mode === 'marked') {
            nextIds = Array.from(markedIds);
        } else if (mode === 'wrong_marked') {
            const wrong = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
            const marked = Array.from(markedIds);
            nextIds = [...new Set([...wrong, ...marked])];
        }

        if (nextIds.length === 0) {
            alert("No hay preguntas para los criterios seleccionados.");
            return;
        }

        userAnswers = {};
        currentQuestions = dbQuestions.filter(q => nextIds.includes(q.id));
        renderQuiz();
        document.querySelector('.main-content').scrollTop = 0;
    }

    renderQuiz();
</script>
</body>
</html>