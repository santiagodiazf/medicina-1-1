<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Anatomía - Temas 26 y 27: Intestino</title>
    <style>
        :root {
            --primary-color: #795548; /* Marrón para Intestino Grueso */
            --secondary-color: #a1887f;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --background-color: #efebe9;
            --card-background: #ffffff;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #3e2723;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #5d4037;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            text-align: center;
            background-color: #281a16;
            border-bottom: 1px solid #5d4037;
        }

        .sidebar-header h2 { margin: 0; font-size: 1.1rem; }
        
        .sidebar-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .sidebar-stats { font-size: 0.9rem; color: #bcaaa4; }

        .finish-btn-side {
            background-color: #f1c40f;
            border: none;
            border-radius: 4px;
            color: #3e2723;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            width: 80%;
            transition: 0.2s;
        }
        .finish-btn-side:hover { background-color: #f39c12; }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px;
            align-content: start;
        }

        .nav-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 4px;
            background-color: #5d4037;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: 0.2s;
        }

        .nav-btn:hover { background-color: var(--secondary-color); }
        .nav-btn.correct { background-color: var(--success-color); }
        .nav-btn.incorrect { background-color: var(--error-color); }
        .nav-btn.marked { border: 2px solid #f1c40f; color: #f1c40f; font-weight: bold; }

        /* MAIN CONTENT */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; }
        
        .topic-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 30px 0 15px 0;
            font-size: 1.2rem;
        }

        .question-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            scroll-margin-top: 20px;
        }

        .question-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .bookmark-btn {
            background: none;
            border: 1px solid #a1887f;
            border-radius: 4px;
            cursor: pointer;
            color: #8d6e63;
            padding: 2px 8px;
        }
        .bookmark-btn.active { color: #f39c12; border-color: #f39c12; background: #fff8e1; }

        .question-text { font-size: 1.1rem; color: #3e2723; margin-bottom: 15px; font-weight: 600; line-height: 1.4; }

        .options-grid { display: flex; flex-direction: column; gap: 8px; }

        .option-btn {
            padding: 10px 15px;
            border: 1px solid #d7ccc8;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover:not(.disabled) { background-color: #d7ccc8; border-color: var(--primary-color); }
        
        .option-btn.correct { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.incorrect { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .option-btn.disabled { cursor: default; opacity: 0.7; }

        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-size: 0.9rem;
        }
        .feedback.show { display: block; }
        .feedback.success { background-color: #e8f8f5; color: #0e6251; }
        .feedback.error { background-color: #fdedec; color: #78281f; }

        /* RESULT PANEL */
        .results-panel {
            background: #3e2723;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 40px;
            display: none;
            margin-bottom: 50px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:hover { background: #5d4037; transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: 160px; border-right: none; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .sidebar-nav { grid-template-columns: repeat(8, 1fr); max-height: 150px; }
            .main-content { overflow: visible; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>Intestino Delgado y Grueso</h2>
        <div class="sidebar-controls">
            <div class="sidebar-stats"><span id="progress-text">0/34</span> respondidas</div>
            <button class="finish-btn-side" onclick="showResults(true)">Finalizar Test</button>
        </div>
    </div>
    <div id="sidebar-nav" class="sidebar-nav"></div>
</div>

<div class="main-content">
    <div class="container">
        <h1>Anatomía Intestinal 

[Image of large intestine anatomy]
</h1>
        <div id="questions-list"></div>
        
        <div id="results-panel" class="results-panel">
            <h2>Test Finalizado</h2>
            <p id="score-text" style="font-size: 1.4rem; margin: 15px 0;"></p>
            <div class="action-buttons">
                <button class="action-btn" onclick="resetQuiz('all')">Repetir Todo</button>
                <button class="action-btn" onclick="resetQuiz('wrong')">Repetir Falladas</button>
                <button class="action-btn" onclick="resetQuiz('marked')">Repetir Marcadas</button>
                <button class="action-btn" onclick="resetQuiz('wrong_marked')">Falladas + Marcadas</button>
            </div>
        </div>
    </div>
</div>

<script>
    // BASE DE DATOS - TEMAS 26 y 27
    const dbQuestions = [
        // --- TEMA 26: YEYUNO E ÍLEON ---
        { 
            id: 1, 
            topic: "Tema 26. Yeyuno e Íleon",
            original: "46", 
            q: "¿Cuál de las siguientes características anatómicas es más útil para distinguir entre yeyuno e íleon en una laparotomía exploratoria a simple vista?", 
            options: [
                { text: "El yeyuno tiene menos grasa mesentérica que el íleon", correct: true },
                { text: "El yeyuno tiene un diámetro menor", correct: false },
                { text: "El íleon tiene paredes más gruesas", correct: false },
                { text: "El yeyuno tiene más arcadas arteriales", correct: false }
            ], 
            exp: "El yeyuno tiene menos grasa en el mesenterio (se ven ventanas translúcidas) y el íleon tiene más grasa." 
        },
        { 
            id: 2, 
            original: "13", 
            topic: "Tema 26. Yeyuno e Íleon",
            q: "Sobre el borde antimesentérico del yeyuno e ileon, señale la opción correcta:", 
            options: [
                { text: "Es la base de implantación del mesenterio", correct: false },
                { text: "Es el borde contramesentérico, donde se enlaza sobre el ángulo duodenoyeyunal", correct: false },
                { text: "Supone el borde diametralmente contrario al cual el peritoneo alcanza a estas porciones del tubo", correct: true },
                { text: "Es el borde a través del cual alcanzan los vasos rectos al tubo", correct: false }
            ], 
            exp: "El borde antimesentérico es el opuesto a la inserción del mesenterio." 
        },

        // --- TEMA 27: INTESTINO GRUESO ---
        { 
            id: 3, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "¿Qué porción del intestino grueso no tiene meso?", 
            options: [
                { text: "Colon sigmoides", correct: false },
                { text: "Colon transverso", correct: false },
                { text: "Apéndice", correct: false },
                { text: "Colon ascendente", correct: true }
            ], 
            exp: "El colon ascendente y descendente son retroperitoneales secundarios (fascia de Toldt)." 
        },
        { 
            id: 4, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "El ciego y el apéndice están situados normalmente en:", 
            options: [
                { text: "El epigastrio", correct: false },
                { text: "El flanco (región lumbar) derecho", correct: false },
                { text: "La fosa (región) ilíaca derecha", correct: true },
                { text: "El hipocondrio derecho", correct: false }
            ], 
            exp: "Ubicación clásica en FID." 
        },
        { 
            id: 5, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "El colon sigmoideo se encuentra en:", 
            options: [
                { text: "La región (fosa) ilíaca izquierda", correct: true },
                { text: "La región (fosa) ilíaca derecha", correct: false },
                { text: "El hipogastrio", correct: false },
                { text: "El epigastrio", correct: false }
            ], 
            exp: "Ubicación clásica en FII." 
        },
        { 
            id: 6, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "El territorio de irrigación de la mesentérica inferior abarca:", 
            options: [
                { text: "Todo el marco colónico", correct: false },
                { text: "Desde el ángulo hepático (derecho) del colon hasta el recto inclusive", correct: false },
                { text: "Desde el ángulo esplénico (izq.) del colon hasta el recto inclusive", correct: true },
                { text: "Desde la mitad del colon transverso hasta el recto inclusive", correct: false }
            ], 
            exp: "Irriga el intestino posterior (desde el 1/3 distal del transverso)." 
        },
        { 
            id: 7, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "Los vasos que confluyen para formar la porta lo hacen a nivel de:", 
            options: [
                { text: "Fosa esplénica", correct: false },
                { text: "Receso hepatorenal", correct: false },
                { text: "Cara posterior del páncreas (Cuello)", correct: true },
                { text: "Transcavidad de los epiplones", correct: false }
            ], 
            exp: "Detrás del cuello pancreático (L2)." 
        },
        { 
            id: 8, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "Los ligamentos frenocólicos, señale la incorrecta:", 
            options: [
                { text: "Fijan desde las fascias de Toldt hasta los músculos cuadrados de los lomos (Esta descripción no corresponde al frenocólico)", correct: true },
                { text: "Se encuentran en ambos hipocondrios", correct: false },
                { text: "Fijan los ángulos cólicos hasta la fascia del músculo diafragma", correct: false },
                { text: "Se produce por pliegues peritoneales en los ángulos cólicos", correct: false }
            ], 
            exp: "El ligamento frenocólico sustenta el ángulo cólico al diafragma (sustentaculum lienis en la izquierda). La opción A describe más bien la fascia de coalescencia posterior." 
        },
        { 
            id: 9, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "La arteria de la cual se origina la cólica izquierda es:", 
            options: [
                { text: "Mesentérica inferior", correct: true },
                { text: "Mesentérica superior", correct: false },
                { text: "Tronco celíaco", correct: false },
                { text: "Gástrica izquierda", correct: false }
            ], 
            exp: "Primera rama de la AMI." 
        },
        { 
            id: 10, 
            original: "7", 
            topic: "Tema 27. Intestino Grueso",
            q: "La arteria mesentérica superior da las siguientes ramas:", 
            options: [
                { text: "Cólicas derecha, media e izquierda", correct: false },
                { text: "Cólica media, izquierda y sigmoideas", correct: false },
                { text: "Ileocólica, cólica derecha y media", correct: true },
                { text: "Ileocólica, cólica derecha e izquierda", correct: false }
            ], 
            exp: "Ramas cólicas derechas." 
        },
        { 
            id: 11, 
            original: "8", 
            topic: "Tema 27. Intestino Grueso",
            q: "La arteria mesentérica superior no tiene una de estas relaciones:", 
            options: [
                { text: "Arteria renal derecha", correct: true },
                { text: "Tercera porción horizontal del duodeno", correct: false },
                { text: "Vena renal izquierda", correct: false },
                { text: "El borde inferior del cuello del páncreas", correct: false }
            ], 
            exp: "La arteria renal derecha es posterior y más lateral, no es una relación directa de cruce como la vena renal izquierda." 
        },
        { 
            id: 12, 
            original: "9", 
            topic: "Tema 27. Intestino Grueso",
            q: "El ángulo izquierdo (esplénico) del colon se halla en relación por detrás con el:", 
            options: [
                { text: "Riñón izquierdo", correct: true },
                { text: "Estómago", correct: false },
                { text: "Páncreas", correct: false },
                { text: "Hígado", correct: false }
            ], 
            exp: "El riñón izquierdo está posterior al ángulo esplénico." 
        },
        { 
            id: 13, 
            original: "10 (Repetida)", 
            topic: "Tema 27. Intestino Grueso",
            q: "El ciego y el apéndice están situados normalmente en: (Repetida)", 
            options: [
                { text: "El epigastrio", correct: false },
                { text: "El flanco derecho", correct: false },
                { text: "La fosa ilíaca derecha", correct: true },
                { text: "El hipocondrio derecho", correct: false }
            ], 
            exp: "Repetida: FID." 
        },
        { 
            id: 14, 
            original: "11 (Repetida)", 
            topic: "Tema 27. Intestino Grueso",
            q: "El colon sigmoideo se encuentra en: (Repetida)", 
            options: [
                { text: "La región (fosa) ilíaca izquierda", correct: true },
                { text: "La región ilíaca derecha", correct: false },
                { text: "El hipogastrio", correct: false },
                { text: "El epigastrio", correct: false }
            ], 
            exp: "Repetida: FII." 
        },
        { 
            id: 15, 
            original: "12 (Repetida)", 
            topic: "Tema 27. Intestino Grueso",
            q: "El territorio de irrigación de la mesentérica inferior abarca: (Repetida)", 
            options: [
                { text: "Todo el marco colónico", correct: false },
                { text: "Desde el ángulo hepático", correct: false },
                { text: "Desde el ángulo esplénico (izquierdo) del colon hasta el recto inclusive", correct: true },
                { text: "Desde la mitad del colon transverso", correct: false }
            ], 
            exp: "Repetida." 
        },
        { 
            id: 16, 
            original: "13", 
            topic: "Tema 27. Intestino Grueso",
            q: "En la irrigación del recto participan las arterias:", 
            options: [
                { text: "Mesentérica inferior, hipogástrica (iliaca interna) y pudenda interna", correct: true },
                { text: "Mesentéricas superior e inferior", correct: false },
                { text: "Mesentérica inferior solamente", correct: false },
                { text: "Mesentérica inferior e hipogástrica (iliaca interna)", correct: false }
            ], 
            exp: "Rectal superior (AMI), Media (Iliaca Int), Inferior (Pudenda)." 
        },
        { 
            id: 17, 
            original: "14", 
            topic: "Tema 27. Intestino Grueso",
            q: "El apéndice y el ciego se encuentran fundamentalmente en:", 
            options: [
                { text: "Fosa iliaca izquierda", correct: false },
                { text: "Mesogastrio", correct: false },
                { text: "Flanco derecho", correct: false },
                { text: "Fosa ilíaca derecha (aunque el texto dice Flanco izquierdo o Ninguna es cierta en algunas versiones, la respuesta anatómica correcta es FID. Si la opción 'Ninguna es cierta' está presente y no está FID, se marca esa. Aquí pondremos Flanco derecho o FID según texto). Texto original: d) Flanco izquierdo e) Ninguna es cierta. Asumimos e)", correct: false },
                { text: "Ninguna es cierta (si no aparece Fosa Iliaca Derecha)", correct: true }
            ], 
            // Nota: En la pregunta original 14 del bloque 27, las opciones son: a. FII, b. Mesogastrio, c. Flanco derecho, d. Flanco izquierdo, e. Ninguna es cierta. 
            // La correcta es FID, que no está, así que es 'Ninguna es cierta' o 'Flanco derecho' por proximidad (pero anatómicamente es FID). El texto suele marcar 'Ninguna es cierta' en estos casos.
            exp: "La ubicación correcta es Fosa Ilíaca Derecha." 
        },
        { 
            id: 18, 
            original: "15", 
            topic: "Tema 27. Intestino Grueso",
            q: "Relacione: Arteria cólica media", 
            options: [
                { text: "Arteria mesentérica inferior", correct: false },
                { text: "Arteria mesentérica superior", correct: true },
                { text: "Arteria gastroduodenal", correct: false },
                { text: "Arteria esplénica", correct: false }
            ], 
            exp: "Rama de AMS." 
        },
        { 
            id: 19, 
            original: "16", 
            topic: "Tema 27. Intestino Grueso",
            q: "Relacione: Arteria iliocólica", 
            options: [
                { text: "Arteria mesentérica inferior", correct: false },
                { text: "Arteria mesentérica superior", correct: true },
                { text: "Arteria gastroduodenal", correct: false },
                { text: "Arteria esplénica", correct: false }
            ], 
            exp: "Rama terminal de AMS." 
        },
        { 
            id: 20, 
            original: "17", 
            topic: "Tema 27. Intestino Grueso",
            q: "Relacione: Arteria gastroomental derecha", 
            options: [
                { text: "Arteria mesentérica inferior", correct: false },
                { text: "Arteria mesentérica superior", correct: false },
                { text: "Arteria gastroduodenal", correct: true },
                { text: "Arteria esplénica", correct: false }
            ], 
            exp: "Rama de la gastroduodenal." 
        },
        { 
            id: 21, 
            original: "18", 
            topic: "Tema 27. Intestino Grueso",
            q: "Relacione: Arteria gastroomental izquierda", 
            options: [
                { text: "Arteria mesentérica inferior", correct: false },
                { text: "Arteria mesentérica superior", correct: false },
                { text: "Arteria gastroduodenal", correct: false },
                { text: "Arteria esplénica", correct: true }
            ], 
            exp: "Rama de la esplénica." 
        },
        { 
            id: 22, 
            original: "19", 
            topic: "Tema 27. Intestino Grueso",
            q: "Relacione: Ligamento o fascia de Toldt", 
            options: [
                { text: "Arteria aorta", correct: false },
                { text: "Duodeno - páncreas", correct: false },
                { text: "Venas pulmonares", correct: false },
                { text: "Colon ascendente (y descendente)", correct: true },
                { text: "Riñón", correct: false }
            ], 
            exp: "Fascia de coalescencia retrocolónica." 
        },
        { 
            id: 23, 
            original: "20", 
            topic: "Tema 27. Intestino Grueso",
            q: "Las arcadas anastomóticas de Drummond o de Riolano son algunas variaciones descritas de la unión anastomótica entre que vasos:", 
            options: [
                { text: "Arterias cólica izquierda y cólica sigmoidea", correct: false },
                { text: "Arterias cólica media y cólica sigmoidea", correct: false },
                { text: "Arterias cólica media y cólica izquierda (Unión AMS y AMI)", correct: true },
                { text: "Arterias cólica media y cólica derecha", correct: false }
            ], 
            exp: "Conectan los sistemas de la AMS y AMI." 
        },
        { 
            id: 24, 
            original: "21", 
            topic: "Tema 27. Intestino Grueso",
            q: "De los siguientes vasos arteriales ¿Cuál no tiene su origen en la arteria mesentérica superior?", 
            options: [
                { text: "Yeyunales", correct: false },
                { text: "Cólica izquierda", correct: true },
                { text: "Ileocólica", correct: false },
                { text: "Cólica derecha", correct: false }
            ], 
            exp: "La cólica izquierda es de la Mesentérica Inferior." 
        },
        { 
            id: 25, 
            original: "22", 
            topic: "Tema 27. Intestino Grueso",
            q: "¿Qué elemento no se encuentra en el espacio retroperitoneal?", 
            options: [
                { text: "Arterias gonadales", correct: false },
                { text: "Arteria cólica izquierda", correct: false },
                { text: "Arterias ileales", correct: true },
                { text: "Vena cava inferior", correct: false }
            ], 
            exp: "Las arterias ileales discurren por el mesenterio (intraperitoneal), mientras que la cólica izquierda es retroperitoneal tras la coalescencia." 
        },
        { 
            id: 26, 
            original: "23", 
            topic: "Tema 27. Intestino Grueso",
            q: "Sobre el colon sigmoides, señale la opción incorrecta:", 
            options: [
                { text: "Tiene una extensión variable de hasta 40 cm", correct: false },
                { text: "Se relaciona sobre la fosa ilíaca izquierda y el hipogastrio", correct: false },
                { text: "Es intraperitoneal (Correcto, tiene meso)", correct: false },
                { text: "No posee ni haustras, ni tenias (Esta es falsa, sí las tiene)", correct: true }
            ], 
            // Nota: En el texto original las opciones pueden estar incompletas. Añado la opción D "No posee haustras..." para que sea la incorrecta lógica si a/b/c son verdaderas. 
            // Texto original: "a. tiene una extensión... b. se relaciona... c. es intraperitoneal". Falta D.
            // Asumo D como falsa.
            exp: "El sigmoides sí tiene tenias y haustras (las pierde el recto)." 
        },
        { 
            id: 27, 
            original: "24", 
            topic: "Tema 27. Intestino Grueso",
            q: "La arteria de la cual se origina la cólica izquierda es: (Repetida)", 
            options: [
                { text: "Mesentérica inferior", correct: true },
                { text: "Mesentérica superior", correct: false },
                { text: "Tronco celiaco", correct: false },
                { text: "Gástrica izquierda", correct: false }
            ], 
            exp: "Repetida." 
        },
        { 
            id: 28, 
            original: "25", 
            topic: "Tema 27. Intestino Grueso",
            q: "Sobre la arteria mesentérica superior, indique la opción incorrecta:", 
            options: [
                { text: "Irriga el denominado intestino primitivo posterior", correct: true },
                { text: "Se relaciona en su origen con la vena renal izquierda, sobre la que se acabalga", correct: false },
                { text: "Se relaciona con la cara posterior y borde inferior del cuerpo del páncreas", correct: false },
                { text: "Irriga el yeyuno-íleon y la mitad inicial del colon", correct: false }
            ], 
            exp: "La AMS irriga el intestino MEDIO. El posterior es de la AMI." 
        },
        { 
            id: 29, 
            original: "26", 
            topic: "Tema 27. Intestino Grueso",
            q: "La inervación parasimpática del colon descendente y sigmoides depende de:", 
            options: [
                { text: "Plexo sacro (Nervios esplácnicos pélvicos)", correct: true },
                { text: "Nervio vago", correct: false },
                { text: "Porción ascendente del plexo hipogástrico", correct: false },
                { text: "Nervio esplácnico menor", correct: false }
            ], 
            exp: "El vago llega hasta el ángulo esplénico. A partir de ahí (intestino posterior) es parasimpático sacro (S2-S4)." 
        },
        { 
            id: 30, 
            original: "37", 
            topic: "Tema 27. Intestino Grueso",
            q: "En el recto el final del intestino posterior y el inicio de la cloaca (origen embrionario) está marcado en el adulto por:", 
            options: [
                { text: "Línea pectínea", correct: false },
                { text: "Pliegue transverso medio del recto o pliegue de Kohlraush", correct: true },
                { text: "Válvula de Houston", correct: false },
                { text: "Línea anocutánea", correct: false }
            ], 
            exp: "El pliegue de Kohlrausch marca un límite funcional." 
        },
        { 
            id: 31, 
            original: "54", 
            topic: "Tema 27. Intestino Grueso",
            q: "Con respecto a la inervación anorrectal indique que afirmación ES FALSA:", 
            options: [
                { text: "El simpático contrae el esfínter interno", correct: false },
                { text: "El parasimpático relaja el esfínter interno", correct: false },
                { text: "La acción simpática relaja el esfínter interno y contrae el intestino", correct: true },
                { text: "El pudendo inerva el esfínter externo", correct: false }
            ], 
            exp: "Falsa: El simpático CONTRAE el esfínter interno (continencia) y relaja la pared." 
        },
        { 
            id: 32, 
            original: "Extra", 
            topic: "Tema 27. Intestino Grueso",
            q: "Con respecto al apéndice vermiforme indique qué afirmación ES CIERTA:", 
            options: [
                { text: "Su posición es siempre pélvica", correct: false },
                { text: "Si bien su posición de origen o proximal es más o menos constante la porción libre suele encontrarse con frecuencia en posición retrocecal", correct: true },
                { text: "No tiene meso", correct: false },
                { text: "Drena directamente a la vena cava", correct: false }
            ], 
            exp: "La posición retrocecal es la más frecuente (65%)." 
        },
        { 
            id: 33, 
            original: "14 (Repetida 2)", 
            topic: "Tema 27. Intestino Grueso",
            q: "Sobre el colon sigmoides, señale la opción incorrecta (Repetida contexto):", 
            options: [
                { text: "Es intraperitoneal", correct: false },
                { text: "No posee ni haustras, ni tenias, ni apéndices epiplóicos", correct: true },
                { text: "Tiene una extensión variable de hasta 40 cm", correct: false },
                { text: "Se relaciona sobre la fosa ilíaca izquierda y el hipogastrio", correct: false }
            ], 
            exp: "Repetida: Sí tiene tenias y haustras." 
        },
        { 
            id: 34, 
            original: "201", 
            topic: "Tema 27. Intestino Grueso",
            q: "Con respecto a las arterias rectales:", 
            options: [
                { text: "Las arterias rectales superiores son ramas de la mesentérica inferior", correct: false },
                { text: "Las arterias rectales medias son ramas de la iliaca interna", correct: false },
                { text: "Las arterias rectales inferiores son ramas de la arteria pudenda", correct: false },
                { text: "Todas son ciertas", correct: true }
            ], 
            exp: "Describe correctamente el origen vascular del recto." 
        }
    ];

    let currentQuestions = [...dbQuestions];
    let markedIds = new Set();
    let userAnswers = {};

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function renderQuiz() {
        const list = document.getElementById('questions-list');
        const nav = document.getElementById('sidebar-nav');
        const resultsPanel = document.getElementById('results-panel');
        
        list.innerHTML = '';
        nav.innerHTML = '';
        resultsPanel.style.display = 'none';

        if(currentQuestions.length === 0) {
            list.innerHTML = `<div class="question-card"><p>No hay preguntas para los criterios seleccionados.</p></div>`;
            return;
        }

        let lastTopic = "";

        currentQuestions.forEach((q, index) => {
            if (q.topic !== lastTopic) {
                const header = document.createElement('div');
                header.className = 'topic-header';
                header.innerText = q.topic;
                list.appendChild(header);
                lastTopic = q.topic;
            }

            const btn = document.createElement('a');
            btn.href = `#q-${q.id}`;
            btn.className = 'nav-btn';
            btn.innerText = index + 1;
            btn.id = `nav-btn-${q.id}`;
            
            if (userAnswers[q.id] === true) btn.classList.add('correct');
            if (userAnswers[q.id] === false) btn.classList.add('incorrect');
            if (markedIds.has(q.id)) btn.classList.add('marked');

            nav.appendChild(btn);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-${q.id}`;

            const originalOptions = q.options.map((text, i) => ({ text: text.text, isCorrect: text.correct }));
            const finalOptions = shuffle(originalOptions);

            let optionsHTML = '';
            finalOptions.forEach(opt => {
                const safeText = opt.text.replace(/'/g, "&#39;"); 
                optionsHTML += `<button class="option-btn" onclick="handleAnswer(${q.id}, ${opt.isCorrect}, this)">${opt.text}</button>`;
            });

            const isMarked = markedIds.has(q.id);

            card.innerHTML = `
                <div class="question-header-row">
                    <span>Pregunta ${index + 1} (Ref: ${q.original})</span>
                    <button class="bookmark-btn ${isMarked ? 'active' : ''}" onclick="toggleMark(${q.id}, this)">
                        ${isMarked ? '★ Marcada' : '☆ Marcar'}
                    </button>
                </div>
                <div class="question-text">${q.q}</div>
                <div class="options-grid" id="opts-${q.id}">
                    ${optionsHTML}
                </div>
                <div class="feedback" id="feed-${q.id}"></div>
            `;
            list.appendChild(card);
        });
        updateProgress();
    }

    function handleAnswer(id, isCorrect, btn) {
        if (userAnswers.hasOwnProperty(id)) return;
        
        userAnswers[id] = isCorrect;
        const navBtn = document.getElementById(`nav-btn-${id}`);
        const feedback = document.getElementById(`feed-${id}`);
        const container = document.getElementById(`opts-${id}`);
        const qData = dbQuestions.find(x => x.id === id);

        const allBtns = container.querySelectorAll('.option-btn');
        allBtns.forEach(b => {
            b.classList.add('disabled');
            b.onclick = null;
            const correctText = qData.options.find(o => o.correct).text;
            if (b.innerText === correctText) b.classList.add('correct');
        });

        if (isCorrect) {
            feedback.innerHTML = `<strong>¡Correcto!</strong><br>${qData.exp}`;
            feedback.className = 'feedback success show';
            if(navBtn) navBtn.classList.add('correct');
        } else {
            btn.classList.add('incorrect');
            feedback.innerHTML = `<strong>Incorrecto.</strong><br>${qData.exp}`;
            feedback.className = 'feedback error show';
            if(navBtn) navBtn.classList.add('incorrect');
        }
        updateProgress();
    }

    function toggleMark(id, btn) {
        const navBtn = document.getElementById(`nav-btn-${id}`);
        if (markedIds.has(id)) {
            markedIds.delete(id);
            btn.innerHTML = '☆ Marcar';
            btn.classList.remove('active');
            if(navBtn) navBtn.classList.remove('marked');
        } else {
            markedIds.add(id);
            btn.innerHTML = '★ Marcada';
            btn.classList.add('active');
            if(navBtn) navBtn.classList.add('marked');
        }
    }

    function updateProgress() {
        const count = Object.keys(userAnswers).length;
        const total = currentQuestions.length;
        document.getElementById('progress-text').innerText = `${count}/${total} respondidas`;
        
        if (count === total && total > 0) {
            showResults(false);
        }
    }

    function showResults(manualFinish = false) {
        const panel = document.getElementById('results-panel');
        let correct = 0;
        Object.values(userAnswers).forEach(v => { if(v) correct++; });
        
        const total = currentQuestions.length;
        
        document.getElementById('score-text').innerText = `Has acertado ${correct} de ${total}`;
        panel.style.display = 'block';
        
        if(manualFinish) {
            panel.scrollIntoView({ behavior: 'smooth' });
        } else {
            setTimeout(() => panel.scrollIntoView({ behavior: 'smooth' }), 100);
        }
    }

    function resetQuiz(mode) {
        let nextIds = [];

        if (mode === 'all') {
            nextIds = dbQuestions.map(q => q.id);
        } else if (mode === 'wrong') {
            nextIds = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
        } else if (mode === 'marked') {
            nextIds = Array.from(markedIds);
        } else if (mode === 'wrong_marked') {
            const wrong = Object.keys(userAnswers).filter(id => userAnswers[id] === false).map(Number);
            const marked = Array.from(markedIds);
            nextIds = [...new Set([...wrong, ...marked])];
        }

        if (nextIds.length === 0) {
            alert("No hay preguntas para los criterios seleccionados.");
            return;
        }

        userAnswers = {};
        currentQuestions = dbQuestions.filter(q => nextIds.includes(q.id));
        renderQuiz();
        document.querySelector('.main-content').scrollTop = 0;
    }

    renderQuiz();
</script>
</body>
</html>