<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Completo: Física de la Visión</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --correct: #27ae60;
            --correct-bg: #d4edda;
            --wrong: #c0392b;
            --wrong-bg: #f8d7da;
            --light: #ecf0f1;
            --text: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header flotante con puntuación */
        header {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 10px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .score-board { font-weight: bold; color: var(--accent); }

        /* Tarjetas de Preguntas */
        .question-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            border-left: 5px solid transparent;
        }

        .question-card.answered-correct { border-left-color: var(--correct); }
        .question-card.answered-wrong { border-left-color: var(--wrong); }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .q-text { font-size: 1.1em; font-weight: 600; width: 90%; }
        
        /* Botón de Marcar */
        .mark-btn {
            background: none;
            border: 2px solid #ddd;
            color: #ddd;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .mark-btn.active {
            border-color: #f1c40f;
            color: #f1c40f;
            background: #fff9db;
        }

        /* Opciones */
        .options-grid { display: flex; flex-direction: column; gap: 10px; }
        
        .option-btn {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .option-btn:hover:not(:disabled) {
            background-color: var(--light);
            border-color: #cbd5e1;
        }

        .option-btn:disabled { cursor: default; opacity: 0.9; }

        /* Estados de respuesta */
        .option-btn.correct {
            background-color: var(--correct-bg);
            border-color: var(--correct);
            color: #155724;
            font-weight: bold;
        }

        .option-btn.wrong {
            background-color: var(--wrong-bg);
            border-color: var(--wrong);
            color: #721c24;
        }

        /* Explicación */
        .explanation {
            margin-top: 15px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            color: #0c5460;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Panel Final */
        #results-panel {
            display: none;
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            color: white;
            transition: opacity 0.2s;
        }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); }
        .btn-accent { background-color: var(--accent); }
        .btn-retry { background-color: var(--correct); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Quiz Física de la Visión</h1>
        <div class="score-board" id="score-display">Aciertos: 0 / 0</div>
    </header>

    <div id="quiz-container">
        </div>

    <div id="results-panel">
        <h2 style="color: var(--primary);">Resultados del Test</h2>
        <p id="final-stats" style="font-size: 1.2rem; margin-bottom: 20px;"></p>
        
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
            <button class="btn-action btn-primary" onclick="initQuiz('all')">Repetir Todo</button>
            <button class="btn-action btn-accent" id="btn-missed" onclick="initQuiz('missed')">Repetir Falladas</button>
            <button class="btn-action btn-accent" id="btn-marked" onclick="initQuiz('marked')">Repetir Marcadas</button>
            <button class="btn-action btn-retry" id="btn-both" onclick="initQuiz('both')">Falladas + Marcadas</button>
        </div>
    </div>
</div>

<script>
    // --- BASE DE DATOS DE PREGUNTAS ---
    // Mapeo de respuestas: a=0, b=1, c=2, d=3
    const dbQuestions = [
        // --- Preguntas Añadidas Recientemente (Bloque Nuevo) ---
        {
            id: 201,
            q: "En un diagrama de cromaticidad, el color blanco está situado en:",
            opts: ["El centro del diagrama", "Los vértices del diagrama", "El eje de las 'x'", "Dependerá de los primarios elegidos"],
            a: 0,
            exp: "El punto acromático (blanco de igual energía) se encuentra teóricamente en el centro del diagrama cromático (x=0.33, y=0.33)."
        },
        {
            id: 202,
            q: "Las aberraciones cromáticas se deben a:",
            opts: ["Las impurezas del aire", "A que todo los rayos no son paraxiales", "A que los distintos colores viajan a distinta velocidad en las lentes", "A que los distintos colores viajan a la misma velocidad en las lentes"],
            a: 2,
            exp: "El índice de refracción depende de la longitud de onda (dispersión), lo que significa que cada color viaja a distinta velocidad y se enfoca en un punto distinto."
        },
        {
            id: 203,
            q: "Con el término acromatopsia, definimos:",
            opts: ["La ceguera de los colores, sólo se distingue claridad y oscuridad.", "Confusión de unos colores con otros.", "El término equivale a visión escotópica", "El término equivale a daltonismo."],
            a: 0,
            exp: "Es la ausencia total de percepción del color (monocromatismo de bastones o conos), viendo solo en escala de grises."
        },
        {
            id: 204,
            q: "Las Tricromatopías se producen:",
            opts: ["Por falta de funcionamiento de los conos", "Cuando falta alguno de los tres pigmentos de los conos", "Cuando se utiliza la mezcla de los primarios en condiciones diferentes al resto de las personas", "Por falta de funcionamiento de los bastones"],
            a: 2,
            exp: "Los tricrómatas anómalos poseen los tres tipos de conos, pero uno de ellos tiene una respuesta espectral desplazada, requiriendo mezclas de primarios distintas a las normales."
        },
        {
            id: 205,
            q: "Los responsables de la visión escotópica son:",
            opts: ["Los conos", "Los bastones", "El músculo ciliar", "La a) y b) conjuntamente"],
            a: 1,
            exp: "Los bastones son los fotorreceptores de alta sensibilidad que funcionan en niveles bajos de iluminación (visión nocturna o escotópica)."
        },
        {
            id: 206,
            q: "El punto remoto en un ojo emétrope tendrá su conjugado en:",
            opts: ["En el cristalino", "En el infinito", "En la retina", "A 17 mm por delante del ojo"],
            a: 2,
            exp: "El punto remoto es el punto del espacio objeto que se forma nítidamente en la retina. Son planos conjugados entre sí."
        },
        {
            id: 207,
            q: "¿Qué atributo de la luz NO es posible observar en el diagrama de cromaticidad?",
            opts: ["El brillo", "La tonalidad", "La saturación", "El matiz"],
            a: 0,
            exp: "El diagrama CIE 1931 es bidimensional (x, y) y representa solo la calidad cromática (tono y saturación), pero no la luminancia o brillo (Y)."
        },
        {
            id: 208,
            q: "El punto remoto en un ojo emétrope está en:",
            opts: ["En el cristalino", "En el infinito", "En la retina", "A 17 mm por delante del ojo"],
            a: 1,
            exp: "Un ojo emétrope (normal) relajado enfoca los rayos paralelos en la retina. Los rayos paralelos provienen del infinito."
        },
        {
            id: 209,
            q: "La presbicia está producida por:",
            opts: ["Ser la potencia de ojo mayor que la potencia del ojo emétrope", "Ser la potencia de ojo menor que la potencia del ojo emétrope", "Falta de acomodación del ojo", "Falta de simetría de revolución de la córnea"],
            a: 2,
            exp: "Es la pérdida fisiológica de la capacidad del cristalino para acomodar (enfocar de cerca) debida a la edad."
        },
        {
            id: 210,
            q: "El ojo miope tiene el punto remoto:",
            opts: ["Más lejano que el ojo normal", "Igual que el ojo normal", "Más cercano que el ojo normal", "El ojo miope no tiene punto remoto"],
            a: 2,
            exp: "Al tener demasiada potencia, el ojo miope solo puede enfocar en la retina objetos que están cerca (punto remoto a distancia finita)."
        },

        // --- Preguntas Anteriores ---
        {
            id: 1000,
            q: "El ojo miope tiene el punto remoto (versión alt):",
            opts: ["Más lejano que el ojo normal", "Igual que el ojo normal", "Más cercano que el ojo normal", "El ojo miope no tiene punto remoto"],
            a: 2, 
            exp: "En la miopía, el exceso de potencia hace que el punto remoto se acerque desde el infinito."
        },
        {
            id: 1,
            q: "¿Cuál es el rango aproximado de longitudes de onda (λ) que detecta el ojo humano?",
            opts: ["100 nm a 400 nm", "400 nm a 700 nm", "700 nm a 1000 nm", "10 nm a 100 nm"],
            a: 1,
            exp: "El espectro visible abarca desde el violeta (aprox 400nm) hasta el rojo (aprox 700nm)."
        },
        {
            id: 2,
            q: "La velocidad de la luz en el vacío (c) es aproximadamente:",
            opts: ["300.000 km/s", "300.000 m/s", "3·10^8 km/s", "150.000 km/s"],
            a: 0,
            exp: "La velocidad es 300.000 km/s (o 3·10^8 m/s)."
        },
        {
            id: 3,
            q: "El índice de refracción (n) se define como:",
            opts: ["n = v/c", "n = c·v", "n = c/v", "n = λ/f"],
            a: 2,
            exp: "Es la relación entre la velocidad en el vacío (c) y la velocidad en el medio (v)."
        },
        {
            id: 4,
            q: "Según la Ley de Snell de la refracción:",
            opts: ["n1 cos(θ1) = n2 cos(θ2)", "n1 / sin(θ1) = n2 / sin(θ2)", "n1 sin(θ1) = n2 sin(θ2)", "θ1 = θ1'"],
            a: 2,
            exp: "El producto del índice de refracción por el seno del ángulo es constante."
        },
        {
            id: 5,
            q: "Un dioptrio se considera convergente cuando su potencia (D) es:",
            opts: ["D < 0", "D = 0", "D > 0", "D = infinito"],
            a: 2,
            exp: "Potencia positiva indica convergencia; negativa indica divergencia."
        },
        {
            id: 6,
            q: "¿Qué ocurre con la potencia (D) si el radio de curvatura (R) de un dioptrio disminuye?",
            opts: ["La potencia disminuye", "La potencia aumenta", "La potencia permanece constante", "El dioptrio se vuelve divergente"],
            a: 1,
            exp: "La potencia es inversamente proporcional al radio. Menor radio significa mayor curvatura y mayor potencia."
        },
        {
            id: 7,
            q: "La aproximación de Gauss en óptica geométrica se aplica a:",
            opts: ["Haces muy inclinados respecto al eje", "Haces paraxiales (estrechos y poco inclinados)", "Lentes muy gruesas", "Luz policromática únicamente"],
            a: 1,
            exp: "Gauss asume ángulos pequeños (paraxiales) donde sin(x) ≈ x."
        },
        {
            id: 8,
            q: "Las aberraciones cromáticas son causadas por:",
            opts: ["Alejarse de la aproximación paraxial", "La dispersión de la luz (el índice n depende de la frecuencia)", "Defectos en la construcción de la lente", "El uso de luz monocromática"],
            a: 1,
            exp: "La dispersión hace que cada color (frecuencia) tenga un índice de refracción distinto y enfoque en un punto diferente."
        },
        {
            id: 9,
            q: "El ojo humano se comporta como un sistema óptico centrado compuesto por:",
            opts: ["2 dioptrios", "6 dioptrios", "4 dioptrios", "Una sola lente delgada"],
            a: 2,
            exp: "Los 4 dioptrios son: cara anterior y posterior de la córnea, y cara anterior y posterior del cristalino."
        },
        {
            id: 10,
            q: "La potencia total del ojo humano en reposo es aproximadamente de:",
            opts: ["20 dioptrías", "42 dioptrías", "60 dioptrías", "100 dioptrías"],
            a: 2,
            exp: "Aproximadamente 40-42D de la córnea más 18-20D del cristalino suman unas 60D."
        },
        {
            id: 11,
            q: "¿Cuál es el elemento del ojo con mayor potencia refractiva individual (unas 42 dioptrías)?",
            opts: ["El cristalino", "La córnea", "El humor vítreo", "La retina"],
            a: 1,
            exp: "La córnea tiene la mayor diferencia de índice de refracción con el aire, aportando la mayor parte de la potencia."
        },
        {
            id: 12,
            q: "La potencia del cristalino en estado de reposo es de aproximadamente:",
            opts: ["60 dioptrías", "42 dioptrías", "20 dioptrías", "8 dioptrías"],
            a: 2,
            exp: "El cristalino aporta unas 20D, pudiendo aumentar mediante la acomodación."
        },
        {
            id: 13,
            q: "El iris actúa como un diafragma con una abertura central llamada:",
            opts: ["Córnea", "Fóvea", "Pupila", "Cristalino"],
            a: 2,
            exp: "La pupila es la abertura que regula la cantidad de luz que entra."
        },
        {
            id: 14,
            q: "Los focos del sistema óptico ocular se sitúan a una distancia de los planos principales de:",
            opts: ["f1 = -17 mm y f2 = 23 mm", "f1 = 17 mm y f2 = -23 mm", "f1 = -8 mm y f2 = 8 mm", "f1 = 0 mm y f2 = 60 mm"],
            a: 0,
            exp: "Distancia focal objeto ~17mm, distancia focal imagen ~23mm."
        },
        {
            id: 15,
            q: "Un ojo emétrope es aquel que:",
            opts: ["Tiene el foco imagen (F2) delante de la retina", "Tiene el punto remoto en el infinito y el foco imagen en la retina", "No puede enfocar de cerca", "Tiene una córnea asimétrica"],
            a: 1,
            exp: "Emétrope significa ojo normal, donde los rayos paralelos del infinito enfocan en la retina."
        },
        {
            id: 16,
            q: "En la miopía, la imagen de un objeto lejano se forma:",
            opts: ["Detrás de la retina", "Exactamente sobre la retina", "Delante de la retina", "En el punto ciego"],
            a: 2,
            exp: "Al tener exceso de potencia, los rayos convergen antes de llegar a la retina."
        },
        {
            id: 17,
            q: "La miopía se corrige mediante el uso de:",
            opts: ["Lentes convergentes", "Lentes cilíndricas", "Lentes divergentes", "Lentes bifocales únicamente"],
            a: 2,
            exp: "Se usan lentes divergentes (negativas) para llevar el foco hacia atrás, a la retina."
        },
        {
            id: 18,
            q: "La hipermetropía ocurre porque:",
            opts: ["El ojo es muy largo o tiene demasiada potencia", "El ojo es muy corto o tiene poca potencia", "La córnea no tiene simetría de revolución", "El cristalino ha perdido elasticidad"],
            a: 1,
            exp: "El ojo es corto o débil, por lo que la imagen se formaría virtualmente detrás de la retina."
        },
        {
            id: 19,
            q: "Un ojo hipermétrope forma la imagen de un objeto lejano:",
            opts: ["Delante de la retina", "Detrás de la retina", "En la pupila", "En el humor acuoso"],
            a: 1,
            exp: "Teóricamente detrás de la retina."
        },
        {
            id: 20,
            q: "El astigmatismo se debe principalmente a:",
            opts: ["Una falta de simetría de revolución en la córnea", "Un exceso de potencia en el cristalino", "El envejecimiento del músculo ciliar", "La falta de bastones en la periferia"],
            a: 0,
            exp: "La córnea tiene diferentes curvaturas en distintos meridianos."
        },
        {
            id: 21,
            q: "¿Qué tipo de lentes se utilizan para corregir el astigmatismo?",
            opts: ["Esféricas convergentes", "Esféricas divergentes", "Cilíndricas o toroidales", "Prismáticas"],
            a: 2,
            exp: "Lentes que tienen potencias distintas en ejes perpendiculares."
        },
        {
            id: 22,
            q: "El proceso por el cual el cristalino aumenta su curvatura para enfocar objetos cercanos se llama:",
            opts: ["Refracción", "Acomodación", "Dispersión", "Reflexión"],
            a: 1,
            exp: "Es la capacidad dinámica del ojo para cambiar su potencia focal."
        },
        {
            id: 23,
            q: "Cuando el músculo ciliar se contrae (empuja), el cristalino:",
            opts: ["Se tensa y disminuye su potencia", "Se abomba, disminuye su radio y aumenta su potencia", "Se vuelve plano", "Se desplaza hacia la retina"],
            a: 1,
            exp: "La contracción del ciliar relaja la zónula, permitiendo que el cristalino se abombe por su propia elasticidad."
        },
        {
            id: 24,
            q: "La presbicia o vista cansada es causada por:",
            opts: ["Una deformación de la esclerótica", "La pérdida de la capacidad de acomodación del cristalino", "Un aumento de la sensibilidad de los bastones", "Una infección en la cámara anterior"],
            a: 1,
            exp: "Con la edad, el cristalino pierde elasticidad y no puede acomodar para ver de cerca."
        },
        {
            id: 25,
            q: "El punto próximo (Pp) en un ojo joven con visión normal suele estar a unos:",
            opts: ["25-35 cm", "5 metros", "2 cm", "El infinito"],
            a: 0,
            exp: "Se toma como referencia estándar 25 cm para la visión cercana."
        },
        {
            id: 26,
            q: "¿Cuál es el fotorreceptor responsable de la visión en condiciones de penumbra (escotópica)?",
            opts: ["Los conos", "Los bastones", "El epitelio pigmentario", "El iris"],
            a: 1,
            exp: "Los bastones son muy sensibles a la luz pero no distinguen color."
        },
        {
            id: 27,
            q: "Los bastones son aproximadamente:",
            opts: ["3 veces más sensibles que los conos", "100 veces más sensibles que los conos", "Menos numerosos que los conos", "Sensibles a la percepción de colores vivos"],
            a: 1,
            exp: "Tienen una sensibilidad mucho mayor que los conos, permitiendo la visión nocturna."
        },
        {
            id: 28,
            q: "La mayor concentración de conos se encuentra en:",
            opts: ["El punto ciego", "La periferia de la retina", "La fóvea", "La córnea"],
            a: 2,
            exp: "La fóvea es la zona de máxima agudeza visual, repleta de conos."
        },
        {
            id: 29,
            q: "La visión fotópica (con buena iluminación) se caracteriza por:",
            opts: ["Una visión aguda y sensación de color bien definida", "Poca agudeza visual y ausencia de colores", "El uso exclusivo de los bastones", "Ocurrir solo en la periferia del ojo"],
            a: 0,
            exp: "Es la visión diurna mediada por conos."
        },
        {
            id: 30,
            q: "El ojo humano normal consta de tres tipos de sensores de color (conos), por lo que su visión es:",
            opts: ["Monocromática", "Dicromática", "Tricromática", "Acromática"],
            a: 2,
            exp: "Tenemos conos para Rojo, Verde y Azul (RGB)."
        },
        {
            id: 31,
            q: "Los tres atributos de la luz que percibe el ojo humano según la 1ª Ley de Grassmann son:",
            opts: ["Tonalidad, brillo y saturación", "Rojo, verde y azul", "Frecuencia, longitud de onda y velocidad", "Reflexión, refracción y difracción"],
            a: 0,
            exp: "Tonalidad (hue), Brillo (luminancia) y Saturación (pureza)."
        },
        {
            id: 32,
            q: "El sistema de colores primarios aditivos (luces) utilizado en monitores y proyectores es:",
            opts: ["CMY (Cian, Magenta, Amarillo)", "RGB (Rojo, Verde, Azul)", "RYB (Rojo, Amarillo, Azul)", "Blanco y Negro"],
            a: 1,
            exp: "La suma de luces RGB crea blanco."
        },
        {
            id: 33,
            q: "La mezcla de colores pigmento (como en impresoras) se denomina:",
            opts: ["Mezcla aditiva", "Mezcla sustractiva", "Mezcla difractiva", "Mezcla paraxial"],
            a: 1,
            exp: "Los pigmentos restan (sustraen) luz reflejada. CMY es sustractivo."
        },
        {
            id: 34,
            q: "El atributo de la luz relacionado con la pureza del color y la cantidad de luz blanca que contiene es:",
            opts: ["El brillo", "La tonalidad", "La saturación", "El índice de refracción"],
            a: 2,
            exp: "Un color saturado es puro; al desaturarlo (añadir blanco) se vuelve pastel o gris."
        },
        {
            id: 35,
            q: "La protanopía es una anomalía de la visión del color donde:",
            opts: ["Falta el pigmento verde (conos M)", "Falta el pigmento rojo (conos L)", "Falta el pigmento azul (conos S)", "El ojo no tiene conos en absoluto"],
            a: 1,
            exp: "Protan = Primero (Rojo). Ausencia de fotorreceptores de onda larga."
        },
        {
            id: 36,
            q: "El daltonismo (protanopía y deuteranopía) es un defecto genético ligado al:",
            opts: ["Cromosoma 7", "Cromosoma X (recesivo)", "Cromosoma Y", "Par 21"],
            a: 1,
            exp: "Se transmite en el cromosoma X, afectando más a hombres."
        },
        {
            id: 37,
            q: "La deuteranopía consiste en la falta del pigmento:",
            opts: ["Rojo", "Verde", "Azul", "Amarillo"],
            a: 1,
            exp: "Deuteros = Segundo (Verde). Ausencia de fotorreceptores de onda media."
        },
        {
            id: 38,
            q: "La tritanopía (falta de pigmento azul) es muy rara y afecta aproximadamente a:",
            opts: ["1 de cada 100 hombres", "1 de cada 100 mujeres", "1 de cada millón de sujetos", "8% de la población mundial"],
            a: 2,
            exp: "Es una anomalía extremadamente rara."
        },
        {
            id: 39,
            q: "¿Qué es la acromatopsia o monocromatopía?",
            opts: ["Una visión perfecta de todos los colores", "La falta de funcionamiento de los conos, viendo solo en blanco y negro (visión escotópica)", "Ver solo el color rojo", "La necesidad de usar lentes cilíndricas"],
            a: 1,
            exp: "Ceguera total al color, visión solo con bastones."
        },
        {
            id: 40,
            q: "En el Test Duocromo, si un paciente ve más nítidas las letras sobre fondo rojo, es probable que sea:",
            opts: ["Hipermétrope", "Miope", "Emétrope", "Daltónico"],
            a: 1,
            exp: "El rojo enfoca más atrás. Si el miope (que enfoca delante) lo ve mejor, es porque su retina 'alcanza' mejor ese foco rojo."
        }
    ];

    // --- VARIABLES DE ESTADO ---
    let currentQuestions = [];
    let stats = {
        score: 0,
        missed: new Set(),
        marked: new Set()
    };
    let answeredCount = 0;

    // --- FUNCIONES LÓGICAS ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initQuiz(mode = 'all') {
        const container = document.getElementById('quiz-container');
        const resultsPanel = document.getElementById('results-panel');
        
        // Reset UI
        container.innerHTML = '';
        resultsPanel.style.display = 'none';
        window.scrollTo(0,0);
        
        // Configurar preguntas según modo
        if (mode === 'all') {
            currentQuestions = [...dbQuestions];
            stats.score = 0;
            stats.missed.clear();
            stats.marked.clear();
        } else if (mode === 'missed') {
            currentQuestions = dbQuestions.filter(q => stats.missed.has(q.id));
        } else if (mode === 'marked') {
            currentQuestions = dbQuestions.filter(q => stats.marked.has(q.id));
        } else if (mode === 'both') {
            currentQuestions = dbQuestions.filter(q => stats.marked.has(q.id) || stats.missed.has(q.id));
        }

        if (currentQuestions.length === 0) {
            alert("No hay preguntas en esta categoría.");
            resultsPanel.style.display = 'block';
            return;
        }

        answeredCount = 0;
        updateScoreDisplay();

        // Renderizar preguntas
        currentQuestions.forEach((q, index) => {
            renderQuestionCard(q, index + 1);
        });
    }

    function renderQuestionCard(q, displayNum) {
        const container = document.getElementById('quiz-container');
        
        const card = document.createElement('div');
        card.className = 'question-card';
        card.id = `card-${q.id}`;

        // Header
        const header = document.createElement('div');
        header.className = 'header-row';
        
        const text = document.createElement('div');
        text.className = 'q-text';
        text.innerHTML = `<strong>${displayNum}.</strong> ${q.q}`;

        const markBtn = document.createElement('button');
        markBtn.className = 'mark-btn';
        markBtn.innerHTML = '★';
        markBtn.title = 'Marcar para repasar';
        if (stats.marked.has(q.id)) markBtn.classList.add('active');
        markBtn.onclick = () => toggleMark(q.id, markBtn);

        header.append(text, markBtn);

        // Options (Randomized)
        const optsDiv = document.createElement('div');
        optsDiv.className = 'options-grid';
        
        // Crear objetos de opción con índice original para rastrear respuesta correcta
        let options = q.opts.map((optText, i) => ({ text: optText, originalIndex: i }));
        shuffleArray(options); // Aleatorizar orden visual

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt.text;
            btn.onclick = () => checkAnswer(q, opt.originalIndex, btn, card);
            optsDiv.appendChild(btn);
        });

        // Explanation 

[Image of X]
 placeholder handling - though this version uses text.
        // If I were to insert images I would add <img src='...' > here, but I'll stick to text as requested.
        const expDiv = document.createElement('div');
        expDiv.className = 'explanation';
        expDiv.innerHTML = `<strong>Explicación:</strong> ${q.exp}`;

        card.append(header, optsDiv, expDiv);
        container.appendChild(card);
    }

    function checkAnswer(qData, selectedIdx, btn, card) {
        const buttons = card.querySelectorAll('.option-btn');
        const expDiv = card.querySelector('.explanation');

        // Deshabilitar botones para que no cambie la respuesta
        buttons.forEach(b => b.disabled = true);

        if (selectedIdx === qData.a) {
            // Correcto
            btn.classList.add('correct');
            card.classList.add('answered-correct');
            stats.score++;
        } else {
            // Incorrecto
            btn.classList.add('wrong');
            card.classList.add('answered-wrong');
            stats.missed.add(qData.id);
            
            // Buscar y resaltar la correcta
            const correctText = qData.opts[qData.a];
            buttons.forEach(b => {
                if (b.textContent === correctText) b.classList.add('correct');
            });
        }

        expDiv.style.display = 'block';
        answeredCount++;
        updateScoreDisplay();

        // Verificar si terminó
        if (answeredCount === currentQuestions.length) {
            showResults();
        }
    }

    function toggleMark(id, btn) {
        if (stats.marked.has(id)) {
            stats.marked.delete(id);
            btn.classList.remove('active');
        } else {
            stats.marked.add(id);
            btn.classList.add('active');
        }
        updateButtonsState();
    }

    function updateScoreDisplay() {
        document.getElementById('score-display').textContent = `Aciertos: ${stats.score} / ${currentQuestions.length}`;
    }

    function showResults() {
        const panel = document.getElementById('results-panel');
        const text = document.getElementById('final-stats');
        
        panel.style.display = 'block';
        text.innerHTML = `
            Has completado el test.<br>
            <strong>Puntuación Final:</strong> ${stats.score} / ${currentQuestions.length}<br>
            <span style="font-size:0.9em; color: #666;">
                Falladas totales acumuladas: ${stats.missed.size} | Marcadas: ${stats.marked.size}
            </span>
        `;
        
        updateButtonsState();
        
        // Scroll suave al final
        setTimeout(() => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
    }

    function updateButtonsState() {
        document.getElementById('btn-missed').disabled = stats.missed.size === 0;
        document.getElementById('btn-marked').disabled = stats.marked.size === 0;
        document.getElementById('btn-both').disabled = (stats.marked.size === 0 && stats.missed.size === 0);
        
        document.getElementById('btn-missed').textContent = `Repetir Falladas (${stats.missed.size})`;
        document.getElementById('btn-marked').textContent = `Repetir Marcadas (${stats.marked.size})`;
    }

    // Iniciar
    initQuiz('all');

</script>

</body>
</html>
