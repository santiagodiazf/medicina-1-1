<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Completo: Tronco y Cuello - Prada</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #8e44ad;
            --success: #27ae60;
            --error: #e74c3c;
            --bg: #f5f0f6;
            --sidebar-w: 130px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
        }

        /* √çndice lateral en 3 columnas */
        #sidebar {
            width: var(--sidebar-w);
            background: var(--primary);
            height: 100vh;
            position: fixed;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-header {
            color: white;
            text-align: center;
            padding: 10px 5px;
            font-size: 0.75em;
            font-weight: bold;
            border-bottom: 1px solid #34495e;
        }

        .nav-container {
            flex-grow: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 10px;
            align-content: start;
        }

        .nav-dot {
            aspect-ratio: 1;
            background: #34495e;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75em;
            transition: 0.2s;
        }

        .nav-dot:hover { background: var(--accent); }
        .nav-dot.answered { background: var(--success); }
        .nav-dot.marked { border: 2px solid #f1c40f; color: #f1c40f; }

        .restart-tab {
            padding: 15px 0;
            background: #1a252f;
            color: #f1c40f;
            text-align: center;
            cursor: pointer;
            font-size: 1.2em;
            border-top: 1px solid #34495e;
        }

        #main-content {
            margin-left: calc(var(--sidebar-w) + 20px);
            padding: 30px;
            width: 100%;
            max-width: 850px;
        }

        .question-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            border-left: 5px solid var(--accent);
        }

        .mark-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            color: #ccc;
        }
        .mark-btn.active { color: #f1c40f; }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .option {
            padding: 12px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            background: #fff;
        }

        .option:hover:not(.disabled) { border-color: var(--accent); background: #fdfaff; }
        .option.correct { background: #d4edda; border-color: var(--success); color: #155724; }
        .option.incorrect { background: #f8d7da; border-color: var(--error); color: #721c24; }
        .option.disabled { cursor: not-allowed; }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-size: 0.95em;
            background: #f8f9fa;
            border-left: 4px solid var(--accent);
        }

        #results-area {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-finish { background: var(--primary); margin-bottom: 30px; width: 100%; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="nav-header">PREGUNTAS</div>
    <div class="nav-container" id="nav-dots"></div>
    <div class="restart-tab" onclick="showResults()" title="Finalizar y Reiniciar">üîÑ</div>
</div>

<div id="main-content">
    <h1>Tronco y Cuello - Examen Final Completo</h1>
    <button class="btn-finish" onclick="showResults()">Finalizar Cuestionario</button>
    
    <div id="results-area">
        <h2>Resultados</h2>
        <p id="score-text" style="font-size: 1.4rem;"></p>
        <div class="btn-group">
            <button onclick="restartQuiz('all')">Repetir Todo</button>
            <button onclick="restartQuiz('failed')">Repetir Falladas</button>
            <button onclick="restartQuiz('marked')">Repetir Marcadas</button>
            <button onclick="restartQuiz('failed-marked')">Falladas + Marcadas</button>
        </div>
    </div>

    <div id="quiz-container"></div>
</div>

<script>
    const rawQuestions = [
        { id: 1, q: "Es cierto que:", options: ["en la rotaci√≥n del tronco participan los m√∫sculos oblicuos del abdomen y aut√≥ctonos del dorso", "todos los m√∫sculos anchos del abdomen son rotadores", "en la rotaci√≥n del tronco intervienen principalmente el oblicuo mayor y transverso", "todos los m√∫sculos de la pared anterolateral del abdomen son rotadores"], correct: 0, r: "La rotaci√≥n implica la musculatura oblicua abdominal y los sistemas profundos del dorso." },
        { id: 2, q: "Respecto a los m√∫sculos del dorso es cierto que:", options: ["el m√∫sculo dorsal ancho es un m√∫sculo emigrado", "el m√∫sculo serrato posterior es un m√∫sculo aut√≥ctono", "el m√∫sculo esplenio es un m√∫sculo emigrado", "el m√∫sculo erector de la columna es un m√∫sculo emigrado"], correct: 0, r: "El dorsal ancho es un m√∫sculo emigrado inervado por el plexo braquial." },
        { id: 3, q: "Sobre los m√∫sculos de la pared anterolateral del abdomen es falso que:", options: ["el m√∫sculo oblicuo menor se inserta en las 4 √∫ltimas costillas", "el m√∫sculo transverso del abdomen termina en una aponeurosis que forma la l√≠nea alba", "las fibras del m√∫sculo oblicuo mayor tienen una direcci√≥n caudal y ventral", "el m√∫sculo recto del abdomen se inserta en el cuerpo del pubis"], correct: 3, r: "El oblicuo menor se inserta normalmente en las 3 √∫ltimas costillas." },
        { id: 4, q: "Indique la respuesta falsa sobre los m√∫sculos aut√≥ctonos del dorso:", options: ["los m√∫sculos interespinosos e intertransversos forman parte del sistema transversoespinoso", "los m√∫sculos del sistema transversoespinoso se sit√∫an profundos al erector de la columna", "el m√∫sculo dorsal largo e iliocostal forman parte del m√∫sculo erector de la columna", "los m√∫sculos aut√≥ctonos est√°n inervados por ramos posteriores de los nervios espinales"], correct: 0, r: "Los interespinosos e intertransversos son sistemas cortos independientes del transversoespinoso." },
        { id: 5, q: "Cu√°l de los siguientes m√∫sculos de la nuca no delimita el tri√°ngulo de Tillaux (suboccipital):", options: ["m√∫sculo oblicuo menor de la cabeza", "m√∫sculo oblicuo mayor de la cabeza", "m√∫sculo recto posterior mayor de la cabeza", "m√∫sculo recto posterior menor de la cabeza"], correct: 3, r: "El recto posterior menor no forma parte de los l√≠mites del tri√°ngulo." },
        { id: 6, q: "El plano muscular m√°s profundo de la regi√≥n de la nuca est√° formado por:", options: ["rectos posteriores y oblicuos de la cabeza", "m√∫sculo semiespinoso de la cabeza", "m√∫sculo esplenio", "m√∫sculo trapecio"], correct: 0, r: "Los rectos y oblicuos forman el plano profundo suboccipital." },
        { id: 7, q: "Qu√© m√∫sculo de la nuca se inserta en la ap√≥fisis transversa del atlas:", options: ["m√∫sculo oblicuo mayor de la cabeza", "m√∫sculo recto posterior mayor de la cabeza", "m√∫sculo esplenio de la cabeza", "m√∫sculo recto posterior menor de la cabeza"], correct: 0, r: "El oblicuo mayor va de la espinosa del axis a la transversa del atlas." },
        { id: 8, q: "La inervaci√≥n de la pared anterolateral del abdomen procede de:", options: ["nervios intercostales (7-12) y nervios iliohipog√°strico e ilioinguinal", "nervios intercostales (1-6)", "nervio fr√©nico", "plexo sacro"], correct: 0, r: "La inervaci√≥n segmentaria depende de los √∫ltimos intercostales y ramas del plexo lumbar." },
        { id: 9, q: "El conducto inguinal:", options: ["contiene el ligamento redondo en la mujer", "se sit√∫a por encima del ligamento ancho", "su pared posterior est√° formada por la aponeurosis del oblicuo mayor", "el orificio inguinal profundo es una hendidura de la aponeurosis del oblicuo mayor"], correct: 0, r: "El ligamento redondo es el contenido hom√≥logo al cord√≥n esperm√°tico en la mujer." },
        { id: 10, q: "Sobre la fascia de los m√∫sculos del dorso:", options: ["la fascia toracolumbar consta de tres l√°minas en la regi√≥n lumbar", "la l√°mina posterior envuelve al m√∫sculo dorsal ancho", "la l√°mina media se sit√∫a por delante del m√∫sculo cuadrado lumbar", "todas son falsas"], correct: 0, r: "En la regi√≥n lumbar, la fascia toracolumbar se divide en l√°minas posterior, media y anterior." },
        { id: 11, q: "El m√∫sculo cuadrado lumbar:", options: ["se inserta en la 12¬™ costilla y ap√≥fisis transversas lumbares", "es inervado por el nervio fr√©nico", "est√° situado superficial a la fascia toracolumbar", "es un m√∫sculo del grupo anterior del abdomen"], correct: 0, r: "Se inserta en la cresta il√≠aca, 12¬™ costilla y transversas lumbares." },
        { id: 12, q: "La l√≠nea blanca (alba):", options: ["se extiende desde el ap√©ndice xifoides hasta la s√≠nfisis del pubis", "es un m√∫sculo largo del abdomen", "est√° formada solo por la aponeurosis del oblicuo mayor", "se sit√∫a lateral al m√∫sculo recto del abdomen"], correct: 0, r: "Es el rafe tendinoso medio de la pared abdominal anterior." },
        { id: 13, q: "El ligamento inguinal:", options: ["se extiende desde la espina il√≠aca anterosuperior hasta la espina del pubis", "es parte de la aponeurosis del m√∫sculo transverso", "forma la pared posterior del conducto inguinal", "se sit√∫a medial a la l√≠nea alba"], correct: 0, r: "Representa el borde inferior engrosado de la aponeurosis del oblicuo mayor." },
        { id: 14, q: "Cu√°l de estos m√∫sculos es un m√∫sculo suprahioideo:", options: ["geniohioideo", "esternotiroideo", "omohioideo", "tirohioideo"], correct: 0, r: "El geniohioideo se sit√∫a por encima del hueso hioides." },
        { id: 15, q: "El m√∫sculo esternocleidomastoideo:", options: ["est√° inervado por el nervio accesorio (XI)", "pertenece al grupo de m√∫sculos prevertebrales", "es flexor de la columna si act√∫a unilateralmente", "se inserta en el hueso hioides"], correct: 0, r: "Recibe inervaci√≥n motora del XI par craneal." },
        { id: 16, q: "Los m√∫sculos escalenos:", options: ["se insertan en las dos primeras costillas", "son flexores puros de la cabeza", "est√°n situados en la regi√≥n anterior del cuello", "son inervados por el nervio hipogloso"], correct: 0, r: "Se originan en transversas cervicales y terminan en 1¬™ (anterior/medio) y 2¬™ (posterior) costilla." },
        { id: 17, q: "Qu√© estructura atraviesa el espacio hiatal entre los escalenos anterior y medio:", options: ["arteria subclavia y plexo braquial", "vena subclavia", "nervio fr√©nico", "arteria car√≥tida com√∫n"], correct: 0, r: "El tri√°ngulo de los escalenos contiene la arteria subclavia y troncos del plexo braquial." },
        { id: 18, q: "La fascia cervical pretraqueal envuelve a:", options: ["los m√∫sculos infrahioideos", "la gl√°ndula tiroides √∫nicamente", "el m√∫sculo platisma", "los m√∫sculos de la nuca"], correct: 0, r: "La l√°mina pretraqueal envuelve a los infrahioideos y v√≠sceras cervicales." },
        { id: 19, q: "El nervio recurrente (lar√≠ngeo inferior):", options: ["es rama del nervio vago (X)", "inerva al m√∫sculo cricotiroideo", "es puramente sensitivo", "pasa por delante del arco a√≥rtico en el lado izquierdo"], correct: 0, r: "Es rama del vago; inerva la mayor√≠a de los m√∫sculos intr√≠nsecos de la laringe." },
        { id: 20, q: "La arteria car√≥tida interna:", options: ["no da ramas en el cuello", "se bifurca a nivel de C6", "da la arteria tiroidea superior", "pasa por el agujero transverso"], correct: 0, r: "A diferencia de la externa, la interna asciende sin ramificarse hasta el cr√°neo." },
        { id: 21, q: "El cart√≠lago cricoides se sit√∫a a nivel de:", options: ["C6", "C3", "C4", "T2"], correct: 0, r: "Marca el l√≠mite entre laringe/faringe y tr√°quea/es√≥fago a nivel de C6." },
        { id: 22, q: "El m√∫sculo platisma:", options: ["est√° inervado por el nervio facial (VII)", "es un m√∫sculo profundo del cuello", "se inserta en la base del cr√°neo", "ayuda a la degluci√≥n"], correct: 0, r: "Es un m√∫sculo m√≠mico del cuello inervado por la rama cervical del facial." },
        { id: 23, q: "La vena yugular interna se une a la vena subclavia para formar:", options: ["vena braquiocef√°lica", "vena cava superior", "vena yugular externa", "vena √°cigos"], correct: 0, r: "La uni√≥n forma el √°ngulo venoso de Pirogoff." },
        { id: 24, q: "El plexo cervical procede de los ramos anteriores de:", options: ["C1-C4", "C5-T1", "C1-C8", "C3-C5"], correct: 0, r: "Inerva piel y m√∫sculos del cuello y da el nervio fr√©nico." },
        { id: 25, q: "El m√∫sculo trapecio est√° inervado por:", options: ["nervio accesorio (XI) y plexo cervical", "nervio vago", "nervios intercostales", "nervio fr√©nico"], correct: 0, r: "Inervaci√≥n dual: motora por el XI y propioceptiva por C3-C4." },
        { id: 26, q: "La gl√°ndula tiroides se relaciona anteriormente con:", options: ["m√∫sculos infrahioideos", "es√≥fago", "columna vertebral", "nervio recurrente"], correct: 0, r: "Los infrahioideos (esternohioideo y esternotiroideo) la cubren." },
        { id: 27, q: "El itsmo de la gl√°ndula tiroides suele cruzar los cart√≠lagos traqueales:", options: ["2¬∫ a 4¬∫", "1¬∫", "5¬∫ a 6¬∫", "7¬∫"], correct: 0, r: "Es su posici√≥n anat√≥mica habitual." },
        { id: 28, q: "El m√∫sculo largo del cuello pertenece al grupo:", options: ["prevertebral", "infrahioideo", "escaleno", "de la nuca"], correct: 0, r: "Se sit√∫a inmediatamente por delante de los cuerpos vertebrales cervicales." },
        { id: 29, q: "La vaina carot√≠dea contiene:", options: ["car√≥tida com√∫n, yugular interna y nervio vago", "car√≥tida com√∫n y arteria vertebral", "yugular externa y nervio fr√©nico", "es√≥fago y tr√°quea"], correct: 0, r: "Es un estuche de la fascia cervical profunda para el paquete vasculonervioso." },
        { id: 30, q: "Qu√© m√∫sculo forma el l√≠mite anterior del tri√°ngulo posterior del cuello:", options: ["esternocleidomastoideo", "trapecio", "escaleno medio", "omohioideo"], correct: 0, r: "El borde posterior del ECM es el l√≠mite anterior." },
        { id: 31, q: "Cu√°l de estos no es un contenido del tri√°ngulo carot√≠deo:", options: ["gl√°ndula submandibular", "bifurcaci√≥n carot√≠dea", "nervio hipogloso", "vena yugular interna"], correct: 0, r: "La gl√°ndula submandibular se sit√∫a en el tri√°ngulo dig√°strico." },
        { id: 32, q: "La arteria tiroidea inferior es rama de:", options: ["tronco tirocervical", "arteria car√≥tida externa", "arteria subclavia directamente", "arco a√≥rtico"], correct: 0, r: "El tronco tirocervical nace de la subclavia." },
        { id: 33, q: "El nervio hipogloso (XII) inerva a:", options: ["m√∫sculos de la lengua", "m√∫sculo platisma", "m√∫sculos escalenos", "m√∫sculo trapecio"], correct: 0, r: "Es el nervio motor de la lengua." },
        { id: 34, q: "El drenaje linf√°tico de la lengua termina principalmente en:", options: ["ganglios cervicales profundos", "ganglios axilares", "ganglios parot√≠deos", "ganglios submentales √∫nicamente"], correct: 0, r: "Siguen la cadena yugular interna." },
        { id: 35, q: "La membrana tirohioidea es atravesada por:", options: ["nervio lar√≠ngeo interno y arteria lar√≠ngea superior", "nervio recurrente", "nervio lar√≠ngeo externo", "arteria tiroidea inferior"], correct: 0, r: "Permite la entrada de la sensibilidad a la laringe." },
        { id: 36, q: "El espacio retrofar√≠ngeo se sit√∫a entre:", options: ["fascia bucofar√≠ngea y fascia prevertebral", "es√≥fago y tr√°quea", "ECM y escalenos", "laringe y faringe"], correct: 0, r: "Espacio virtual de gran importancia cl√≠nica para la propagaci√≥n de infecciones." },
        { id: 37, q: "Cu√°l de los siguientes no es un cart√≠lago lar√≠ngeo:", options: ["hioides", "epiglotis", "tiroides", "cricoides"], correct: 0, r: "El hioides es un hueso, no un cart√≠lago de la laringe." },
        { id: 38, q: "El m√∫sculo cricoaritenoideo posterior es el √∫nico:", options: ["dilatador de la glotis", "constrictor de la glotis", "tensor de las cuerdas vocales", "elevador de la laringe"], correct: 0, r: "Abre la hendidura gl√≥tica (abductor)." },
        { id: 39, q: "La tr√°quea se bifurca a nivel de:", options: ["T4-T5 (√°ngulo de Louis)", "C6", "T1", "T12"], correct: 0, r: "Localizaci√≥n del espol√≥n traqueal o carina." },
        { id: 40, q: "El es√≥fago cervical se sit√∫a:", options: ["posterior a la tr√°quea", "anterior a la tr√°quea", "lateral a la car√≥tida", "anterior a la gl√°ndula tiroides"], correct: 0, r: "Sigue la cara posterior traqueal." },
        { id: 41, q: "La inervaci√≥n motora del diafragma depende de:", options: ["nervio fr√©nico", "nervios intercostales", "nervio vago", "nervio simp√°tico"], correct: 0, r: "Procede de C3-C5." },
        { id: 42, q: "El hiato a√≥rtico del diafragma se sit√∫a a nivel de:", options: ["T12", "T8", "T10", "L2"], correct: 0, r: "Es el m√°s posterior e inferior de los grandes orificios." },
        { id: 43, q: "Qu√© estructura atraviesa el hiato esof√°gico del diafragma adem√°s del es√≥fago:", options: ["troncos vagales", "vena cava inferior", "arteria aorta", "conducto tor√°cico"], correct: 0, r: "Los nervios vagos acompa√±an al es√≥fago." },
        { id: 44, q: "El m√∫sculo serrato anterior est√° inervado por:", options: ["nervio tor√°cico largo", "nervio accesorio", "nervios intercostales", "nervio fr√©nico"], correct: 0, r: "Tambi√©n llamado nervio de Charles Bell." },
        { id: 45, q: "La mama drena linf√°ticamente mayoritariamente a:", options: ["nodos axilares", "nodos paraesternales", "nodos supraclaviculares", "nodos inguinales"], correct: 0, r: "Aproximadamente el 75% del drenaje." },
        { id: 46, q: "Los m√∫sculos intercostales externos:", options: ["son inspiratorios", "son espiratorios", "est√°n inervados por el nervio fr√©nico", "se sit√∫an profundos a los intercostales internos"], correct: 0, r: "Elevan las costillas durante la inspiraci√≥n." },
        { id: 47, q: "La arteria mamaria interna (tor√°cica interna) es rama de:", options: ["arteria subclavia", "arco a√≥rtico", "arteria axilar", "arteria car√≥tida"], correct: 0, r: "Nace de la primera porci√≥n de la subclavia." },
        { id: 48, q: "Respecto a la vaina de los rectos es cierto que:", options: ["la aponeurosis del transverso en sus dos tercios superiores se incorpora a la hoja posterior de la vaina", "la aponeurosis del oblicuo menor forma parte de la hoja anterior en toda su extensi√≥n", "la aponeurosis del oblicuo mayor se desdobla en 2 hojas para envolver al musculo recto", "en el tercio inferior todas las aponeurosis pasan por detr√°s"], correct: 0, r: "Cambio estructural clave a nivel de la l√≠nea arqueada." },
        { id: 49, q: "Es cierto que:", options: ["el nervio laringeo externo lleva fibras motoras para el m√∫sculo cricotiroideo", "la inervaci√≥n sensitiva supragl√≥tica depende de los nervios laringeos recurrentes", "la inervaci√≥n sensitiva de la regi√≥n infragl√≥tica procede del nervio laringeo interno", "la inervaci√≥n motora de los m√∫sculos laringeos depende del nervio laringeo interno"], correct: 0, r: "Diferenciaci√≥n funcional de las ramas del vago en la laringe." },
        { id: 50, q: "De las siguientes afirmaciones de la regi√≥n inguinal es cierto que:", options: ["el nervio femoral es lateral respecto a la arteria femoral", "los vasos femorales son laterales respecto a la cintilla iliopectinea", "la vena femoral es lateral respecto al psoas", "la arteria femoral es medial respecto a la vena hom√≥nima"], correct: 0, r: "Disposici√≥n en la laguna vascular y muscular." }
    ];

    let userAnswers = {};
    let markedQuestions = new Set();
    let currentPool = [];

    function preparePool(questions) {
        return questions.map(q => {
            const options = q.options.map((text, i) => ({ text, isCorrect: i === q.correct }));
            return { ...q, options };
        });
    }

    const fullPool = preparePool(rawQuestions);

    function initQuiz(questions) {
        const container = document.getElementById('quiz-container');
        const nav = document.getElementById('nav-dots');
        container.innerHTML = '';
        nav.innerHTML = '';

        questions.forEach((q, index) => {
            const dot = document.createElement('div');
            dot.className = `nav-dot ${markedQuestions.has(q.id) ? 'marked' : ''}`;
            dot.id = `dot-${q.id}`;
            dot.innerHTML = index + 1;
            dot.onclick = () => document.getElementById(`q-card-${q.id}`).scrollIntoView({behavior: 'smooth'});
            nav.appendChild(dot);

            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-card-${q.id}`;
            
            const markBtn = document.createElement('span');
            markBtn.className = `mark-btn ${markedQuestions.has(q.id) ? 'active' : ''}`;
            markBtn.innerHTML = '‚òÖ';
            markBtn.onclick = () => toggleMark(q.id, markBtn);
            
            const qText = document.createElement('h3');
            qText.innerHTML = `${index + 1}. ${q.q}`;
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            const shuffled = [...q.options].sort(() => Math.random() - 0.5);
            
            shuffled.forEach(opt => {
                const optDiv = document.createElement('div');
                optDiv.className = 'option';
                optDiv.innerHTML = opt.text;
                optDiv.onclick = () => handleAnswer(q.id, opt, optDiv, card);
                optionsDiv.appendChild(optDiv);
            });

            const feedback = document.createElement('div');
            feedback.className = 'feedback';
            card.appendChild(markBtn);
            card.appendChild(qText);
            card.appendChild(optionsDiv);
            card.appendChild(feedback);
            container.appendChild(card);
        });
    }

    function toggleMark(id, btn) {
        if (markedQuestions.has(id)) {
            markedQuestions.delete(id);
            btn.classList.remove('active');
            document.getElementById(`dot-${id}`).classList.remove('marked');
        } else {
            markedQuestions.add(id);
            btn.classList.add('active');
            document.getElementById(`dot-${id}`).classList.add('marked');
        }
    }

    function handleAnswer(qId, option, el, card) {
        if (userAnswers[qId]) return;
        userAnswers[qId] = { correct: option.isCorrect, id: qId };
        const allOpts = card.querySelectorAll('.option');
        allOpts.forEach(o => o.classList.add('disabled'));
        const fb = card.querySelector('.feedback');
        fb.style.display = 'block';
        const qData = fullPool.find(f => f.id === qId);
        fb.innerHTML = `<strong>${option.isCorrect ? 'Correcto' : 'Incorrecto'}</strong>: ${qData.r}`;
        el.classList.add(option.isCorrect ? 'correct' : 'incorrect');
        if (!option.isCorrect) {
            const correctText = qData.options.find(o => o.isCorrect).text;
            allOpts.forEach(o => { if (o.innerHTML === correctText) o.classList.add('correct'); });
        }
        document.getElementById(`dot-${qId}`).classList.add('answered');
    }

    function showResults() {
        const total = currentPool.length;
        const correctas = Object.values(userAnswers).filter(a => a.correct).length;
        document.getElementById('quiz-container').style.display = 'none';
        document.querySelector('.btn-finish').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        document.getElementById('score-text').innerHTML = `Has acertado <strong>${correctas}</strong> de <strong>${total}</strong> preguntas.`;
        window.scrollTo(0,0);
    }

    function restartQuiz(mode) {
        let next = [];
        if (mode === 'all') next = [...fullPool];
        else if (mode === 'failed') next = fullPool.filter(q => userAnswers[q.id] && !userAnswers[q.id].correct);
        else if (mode === 'marked') next = fullPool.filter(q => markedQuestions.has(q.id));
        else if (mode === 'failed-marked') next = fullPool.filter(q => (userAnswers[q.id] && !userAnswers[q.id].correct) || markedQuestions.has(q.id));

        if (next.length === 0) { alert("No hay preguntas en esta selecci√≥n."); return; }
        userAnswers = {};
        currentPool = next;
        document.getElementById('quiz-container').style.display = 'block';
        document.querySelector('.btn-finish').style.display = 'block';
        document.getElementById('results-area').style.display = 'none';
        initQuiz(next);
        window.scrollTo(0,0);
    }

    currentPool = [...fullPool];
    initQuiz(currentPool);
</script>
</body>
</html>
