<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Fisiología Optimizado</title>
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #2ecc71;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            color: #333;
            background-color: #f4f6f7;
        }
        
        #sidebar {
            width: 350px;
            background-color: var(--dark);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 15px;
            flex-shrink: 0;
            border-right: 1px solid #1a252f;
        }

        #sidebar h3 {
            margin-top: 0;
            text-align: center;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        #nav-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            overflow-y: auto;
            padding-right: 5px;
            flex-grow: 1;
            align-content: start;
        }

        #nav-grid::-webkit-scrollbar { width: 6px; }
        #nav-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        .nav-btn {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            border: none;
            background-color: rgba(255,255,255,0.1);
            color: #ecf0f1;
            cursor: pointer;
            font-weight: 600;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.1s;
        }

        .nav-btn:hover { background-color: var(--secondary); transform: scale(1.1); z-index: 2; }
        .nav-btn.active { background-color: var(--secondary); border: 2px solid white; }
        .nav-btn.correct { background-color: var(--success); color: white; }
        .nav-btn.incorrect { background-color: var(--danger); color: white; }
        .nav-btn.marked { box-shadow: inset 0 0 0 2px var(--warning); }

        .legend {
            font-size: 0.8rem;
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }

        #main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .screen { display: none; max-width: 900px; margin: 0 auto; }
        .screen.active { display: block; }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: center;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .battery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.2s;
            width: 100%;
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .btn-blue { background-color: #3498db; color: white; }
        .btn-green { background-color: var(--success); color: white; }
        .btn-red { background-color: var(--danger); color: white; }
        .btn-dark { background-color: var(--dark); color: white; }
        .btn-yellow { background-color: var(--warning); color: #2c3e50; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        .question-container {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .question-text { font-size: 1.15em; font-weight: 600; color: #2c3e50; line-height: 1.4; text-align: left; }
        
        .mark-check {
            cursor: pointer;
            color: #bdc3c7;
            font-size: 26px;
            transition: color 0.2s;
            user-select: none;
            margin-left: 15px;
        }
        .mark-check.marked { color: #f1c40f; }
        
        .options-grid { display: grid; gap: 8px; }
        .option {
            padding: 12px 18px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
            text-align: left;
        }
        .option:hover:not(.disabled) { background-color: #e2e6ea; border-color: #adb5bd; }
        .option.correct { background-color: #d4edda; border-color: var(--success); color: #155724; }
        .option.incorrect { background-color: #f8d7da; border-color: var(--danger); color: #721c24; }
        .option.disabled { cursor: default; pointer-events: none; opacity: 0.7; }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            background-color: #e8f6f3;
            border-radius: 8px;
            display: none;
            border-left: 5px solid var(--success);
            text-align: left;
        }
        .feedback.error { background-color: #fdeaea; border-color: var(--danger); }

        #controls {
            position: fixed;
            bottom: 30px;
            right: 40px;
            z-index: 100;
        }

        .badge {
            background: #95a5a6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            vertical-align: middle;
            margin-left: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3 id="sidebar-title">Índice</h3>
        <div id="nav-grid"></div>
        <div class="legend">
            <span><div class="dot" style="background:var(--success)"></div> Bien</span>
            <span><div class="dot" style="background:var(--danger)"></div> Mal</span>
            <span><div class="dot" style="background:var(--warning)"></div> Ojo</span>
        </div>
    </div>

    <div id="main">
        <div id="start-screen" class="screen active">
            <div class="card">
                <h1 style="color:var(--primary); margin-bottom: 5px;">Fisiología Celular Optimizado</h1>
                <p style="color:#7f8c8d; margin-top:0;">Base de Datos Mejorada (4 Opciones)</p>
                
                <hr style="margin: 25px 0; opacity: 0.2">
                
                <h3 style="margin-bottom: 10px;">Selecciona Modo:</h3>
                
                <div class="battery-grid">
                    <button class="btn btn-blue" onclick="selectBattery('b3_opt')">Batería 3 <br><small>OPTIMIZADA (+100 Pregs)</small></button>
                    </div>

                <div class="mode-grid">
                    <button class="btn btn-red" onclick="selectBattery('exam')">EXAMEN RÁPIDO <br><small>(20 Aleatorias)</small></button>
                </div>

                <div id="order-options" style="display:none; margin-top:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                    <h3 style="margin-top:0;">Orden de preguntas:</h3>
                    <div class="mode-grid" style="max-width: 400px; margin: 0 auto;">
                        <button class="btn btn-outline" onclick="startQuiz('ordered')">Orden Numérico</button>
                        <button class="btn btn-outline" onclick="startQuiz('random')">Aleatorio</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <div id="questions-list"></div>
            <div id="controls">
                <button class="btn btn-red" style="box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="finishQuiz()">Finalizar Revisión</button>
            </div>
        </div>

        <div id="results-screen" class="screen">
            <div class="card">
                <h2 style="color:var(--primary)">Resultados</h2>
                <div id="score-display" style="font-size: 3em; font-weight:bold; color:var(--secondary); margin: 20px 0;"></div>
                <div id="stats-display" style="color:#7f8c8d; font-size: 1.2em;"></div>
                
                <hr style="margin: 30px 0; opacity: 0.2">
                <h3>Opciones de Repaso</h3>
                <div class="mode-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                    <button class="btn btn-danger" onclick="resetQuiz('failed')">Repetir Falladas</button>
                    <button class="btn btn-yellow" onclick="resetQuiz('marked')">Repetir Marcadas</button>
                    <button class="btn btn-dark" onclick="resetQuiz('failed_marked')">Falladas + Marcadas</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="resetQuiz('all')">Repetir Mismo Test</button>
                    <br><br>
                    <button class="btn btn-outline" onclick="location.reload()">Volver al Menú Principal</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // BATERÍA 3 OPTIMIZADA (4 Opciones + Desdobles)
    // ==========================================
    const battery3_optimized = [
        // Q1 Desdoblada (A)
        { id: 'b3_1a', text: "La velocidad de propagación de los potenciales de acción se incrementa:", options: ["Al aumentar el diámetro del axón", "Al aumentar la capacitancia de membrana (Cm)", "Al reducir la resistencia de membrana (Rm)", "Al aumentar la resistencia interna (ri)"], correct: 0, explanation: "A mayor diámetro, menor resistencia interna, mayor velocidad." },
        // Q1 Desdoblada (B)
        { id: 'b3_1b', text: "La velocidad de propagación de los potenciales de acción aumenta drásticamente:", options: ["Al aumentar la capacitancia", "Al reducir la resistencia de membrana", "Al aumentar la resistencia interna", "Al mielinizar el axón"], correct: 3, explanation: "La mielinización permite la conducción saltatoria." },
        // Q1 Derivada (C - Concepto Resistencia Interna)
        { id: 'b3_1c', text: "¿Qué factor disminuiría la velocidad de propagación del potencial de acción?", options: ["Aumentar el diámetro", "Mielinizar el axón", "Aumentar la resistencia interna (ri)", "Aumentar la resistencia de membrana (Rm)"], correct: 2, explanation: "Una mayor resistencia interna dificulta el flujo de corriente y reduce la velocidad." },

        // Q2 Desdoblada (A)
        { id: 'b3_2a', text: "Característica estructural de la sinapsis química:", options: ["Están formadas por conexones", "Las proteínas SNARE son necesarias para la fusión vesicular", "Hay continuidad citoplasmática", "La transmisión es bidireccional"], correct: 1, explanation: "Las SNARE median la exocitosis." },
        // Q2 Desdoblada (B)
        { id: 'b3_2b', text: "Mecanismo de liberación en la sinapsis química:", options: ["El aumento de calcio presináptico induce la liberación", "El sodio induce la fusión vesicular", "Es más rápida que la eléctrica", "Facilita el acoplamiento metabólico"], correct: 0, explanation: "El calcio es el ion clave para la liberación del NT." },

        // Q3 (Reducida)
        { id: 'b3_3', text: "Sobre los receptores colinérgicos (señale la incorrecta):", options: ["La acción de los nicotínicos es más rápida", "Los muscarínicos están en la placa motora esquelética", "Nicotínicos son ionotrópicos", "Muscarínicos usan proteína G"], correct: 1, explanation: "INCORRECTA: En el músculo esquelético solo hay nicotínicos." },

        // Q4 (Reducida)
        { id: 'b3_4', text: "Respecto a la noradrenalina (señale la incorrecta):", options: ["Es un derivado del triptófano", "Se sintetiza a partir de dopamina", "Activa receptores beta-adrenérgicos", "Su acción termina por recaptación"], correct: 0, explanation: "INCORRECTA: Deriva de la tirosina." },

        // Q5 (Reducida)
        { id: 'b3_5', text: "Receptores NMDA (señale la incorrecta):", options: ["Son canales activados por ligando", "Son catiónicos", "Su activación induce un potencial inhibidor (IPSP)", "Se inactivan por glicina"], correct: 2, explanation: "INCORRECTA: El glutamato es excitador (EPSP)." },

        // Q6 Desdoblada (A - Distancia)
        { id: 'b3_6a', text: "Característica de la acción de los neuropéptidos:", options: ["Actúan exclusivamente en el sitio de liberación", "Pueden ejercer su acción lejos del sitio de liberación", "Tienen muy baja afinidad por receptores", "Su liberación es independiente de calcio"], correct: 1, explanation: "Suelen actuar de forma paracrina o a distancia." },
        // Q6 Desdoblada (B - Coexistencia)
        { id: 'b3_6b', text: "Sobre la liberación de neuropéptidos:", options: ["Nunca coexisten con otros neurotransmisores", "Pueden coexistir en la neurona con otros NT", "Se eliminan por recaptación rápida", "No requieren calcio"], correct: 1, explanation: "La cotransmisión es frecuente." },

        // Q7 (Reducida)
        { id: 'b3_7', text: "La inhibición lateral en sistemas sensoriales:", options: ["Reduce el umbral de activación", "Aumenta el umbral perceptivo", "Reduce la adaptación", "Aumenta la capacidad de discriminación espacial"], correct: 3, explanation: "Mejora el contraste." },

        // Q8 (Reducida)
        { id: 'b3_8', text: "El aprendizaje y la memoria se relacionan con:", options: ["Cambios en propiedades pasivas", "Muerte de neuronas", "Modificaciones en la eficacia sináptica", "Aumento velocidad conducción"], correct: 2, explanation: "Plasticidad sináptica." },

        // Q9 Desdoblada (A - Iones)
        { id: 'b3_9a', text: "El transporte pasivo de iones se caracteriza por:", options: ["Mover iones en contra de gradiente", "Mover iones a favor de gradiente", "Requerir ATP directo", "Utilizar bombas"], correct: 1 },
        // Q9 Desdoblada (B - Moléculas)
        { id: 'b3_9b', text: "El transporte pasivo de moléculas no iónicas:", options: ["Ocurre a favor de gradiente", "Ocurre en contra de gradiente", "Requiere hidrólisis de ATP", "Es independiente de la concentración"], correct: 0 },

        // Q10 (Reducida)
        { id: 'b3_10', text: "Transporte mediado por proteínas a favor de gradiente:", options: ["Difusión simple", "Difusión facilitada", "Difusión pasiva pura", "Transporte activo"], correct: 1, explanation: "Usa transportadores y satura." },

        // Q11 (Reducida)
        { id: 'b3_11', text: "Canales iónicos (señale la incorrecta):", options: ["A favor de gradiente electroquímico", "Formados por subunidades proteicas", "Solamente mueven iones de carga positiva", "Contribuyen al potencial de membrana"], correct: 2, explanation: "INCORRECTA: Existen canales aniónicos (ej. Cloro)." },

        // Q12 (Reducida)
        { id: 'b3_12', text: "Dos citoquinas actúan de forma sinérgica cuando:", options: ["Son producidas por células diferentes", "El efecto combinado es mayor que la suma individual", "Tienen efectos contrarios", "Actúan sobre dianas diferentes"], correct: 1 },

        // Q13 (Reducida)
        { id: 'b3_13', text: "Si Eq K+ = -58mV y Vm = +58mV, el flujo neto de K+:", options: ["Irá del interior al exterior", "Irá del exterior al interior", "No habrá flujo neto", "Será nulo"], correct: 0, explanation: "Fuerte fuerza electromotriz de salida." },

        // Q14 (Reducida)
        { id: 'b3_14', text: "Un estímulo positivo subumbral en una neurona:", options: ["Genera un potencial de acción", "No varía el potencial", "Despolariza la membrana (potencial local)", "Hiperpolariza la membrana"], correct: 2 },

        // Q15 (Reducida)
        { id: 'b3_15', text: "Respecto al potencial de acción (señale la incorrecta):", options: ["Tiene siempre la misma duración", "Se propaga en todas direcciones", "Despolarización por entrada de Na+", "Se invierte/repolariza por entrada de K+"], correct: 3, explanation: "INCORRECTA: Se repolariza por SALIDA de K+." },

        // Q16 (Reducida)
        { id: 'b3_16', text: "Llegada del PA a la sinapsis (señale la incorrecta):", options: ["Permite liberar neurotransmisores", "Despolariza la membrana presináptica", "Abre canales de calcio", "Libera calcio al exterior celular"], correct: 3, explanation: "INCORRECTA: El calcio ENTRA a la célula." },

        // Q17 (Reducida)
        { id: 'b3_17', text: "La difusión pasiva simple:", options: ["Sigue cinética de saturación", "Es un proceso selectivo por canales", "Es un proceso no selectivo que depende del soluto", "Requiere proteínas transportadoras"], correct: 2 },

        // Q18 (Reducida)
        { id: 'b3_18', text: "Receptores de neurotransmisores (incorrecto):", options: ["NMDA activados por ligando y voltaje", "Serotonina tiene autorreceptores", "Receptores de glicina son metabotrópicos", "Glutamato tiene ionotrópicos y metabotrópicos"], correct: 2, explanation: "INCORRECTA: Glicina es ionotrópico (Cl-)." },

        // Q19 (Reducida)
        { id: 'b3_19', text: "Síntesis de neurotransmisores correcta:", options: ["AChE es precursora de ACh", "Noradrenalina es precursora de dopamina", "GABA es precursor de glutamato", "DOPA es precursora de dopamina"], correct: 3 },

        // Q20 (Reducida)
        { id: 'b3_20', text: "Los eicosanoides:", options: ["Son derivados del ácido araquidónico", "Son proteínas de membrana", "Median uniones celulares", "Son neurotrofinas"], correct: 0 },

        // Q21 (Reducida)
        { id: 'b3_21', text: "Células madre hematopoyéticas:", options: ["Generan una gran progenie", "Solo dan línea mieloide", "Tienen escasa capacidad regenerativa", "Residen en el hígado adulto"], correct: 0 },

        // Q22 (Reducida)
        { id: 'b3_22', text: "Coagulación (señale la incorrecta):", options: ["Plaquetas son imprescindibles para iniciar cualquier coagulación", "tPA es necesario para la fibrinólisis", "Trombomodulina es necesaria", "Endotelio sano limita el coágulo"], correct: 0, explanation: "INCORRECTA: La vía extrínseca puede iniciar por factor tisular sin plaquetas (aunque son necesarias para la hemostasia eficaz)." },

        // Q23 (Reducida)
        { id: 'b3_23', text: "Las cadherinas:", options: ["Son moléculas de señalización paracrina", "Son moléculas de señalización por contacto", "Actúan sobre neuronas presinápticas", "Median la inflamación"], correct: 1 },

        // Q24 (Reducida)
        { id: 'b3_24', text: "S-nitrosilación (señale la incorrecta):", options: ["Activa la guanilato ciclasa", "Modifica grupos sulfhidrilos (tioles)", "Modifica grupos hemo", "Es reversible"], correct: 2, explanation: "INCORRECTA: Es en Cisteína, no grupo Hemo." },

        // Q25 (Reducida)
        { id: 'b3_25', text: "¿En qué proceso NO actúan directamente las plaquetas?", options: ["Hemostasia primaria", "Activación plaquetaria", "Vasodilatación", "Retracción del coágulo"], correct: 2, explanation: "Suelen liberar vasoconstrictores." },

        // Q26 (Reducida)
        { id: 'b3_26', text: "Potencial de reposo:", options: ["Requiere canales por ligando", "Existe eflujo de K+ e influjo de Na+", "Solo en células excitables", "Equilibrio es cero si concentraciones iguales"], correct: 1 },

        // Q27 (Reducida)
        { id: 'b3_27', text: "Propiedades pasivas de membrana:", options: ["No afectan velocidad PA", "Determinan atenuación espacial", "Son determinantes en integración sináptica", "Dependen de canales voltaje"], correct: 2, explanation: "Lambda determina la atenuación." },

        // Q28 (Reducida)
        { id: 'b3_28', text: "Grupos sanguíneos incorrecto:", options: ["AB+ tiene antígenos A, B y H", "Anticuerpos anti-A y B son naturales", "Paciente AB- puede recibir O+", "Dos padres Rh+ pueden tener hijo Rh-"], correct: 2, explanation: "INCORRECTA: Rh- no puede recibir Rh+." },

        // Q29 (Reducida)
        { id: 'b3_29', text: "Recaptación correcta:", options: ["Glutamato por transportador de indolaminas", "Neuropéptidos por fosfatasas", "ACh por transportador", "Noradrenalina por transportador presináptico"], correct: 3 },

        // Q30 (Reducida)
        { id: 'b3_30', text: "Transmisión sináptica:", options: ["Neuropéptidos son más rápidos", "Toxinas estimulan liberación", "En el potencial de reversión hay flujo neto", "Si solo abre Cl-, reversión coincide con ECl"], correct: 3 },

        // Q31 (Reducida)
        { id: 'b3_31', text: "Contracción muscular:", options: ["Química contrae liso sin cambiar Vm", "Esquelético tiene marcapasos", "Relajación por salida de Ca al exterior", "Hormonas relajan esquelético"], correct: 0 },

        // Q32 (Reducida)
        { id: 'b3_32', text: "Neurotransmisores incorrecto:", options: ["Serotonina es una catecolamina", "Glutamato es excitatorio", "ACh es molécula pequeña", "GABA es inhibitorio"], correct: 0, explanation: "INCORRECTA: Serotonina es indolamina." },

        // Q33 (Reducida)
        { id: 'b3_33', text: "Nutrición correcto:", options: ["Vitaminas y minerales son esenciales", "Proteínas 300g/día", "Carbohidratos <20%", "Recién nacido bajos requerimientos"], correct: 0 },

        // Q34 (Reducida)
        { id: 'b3_34', text: "Eritrocitos:", options: ["HIF-1 media respuesta hipoxia", "HbF tiene menor afinidad", "Sin EPO hay apoptosis", "Ejercicio desplaza curva a izquierda"], correct: 2 },

        // Q35 (Reducida)
        { id: 'b3_35', text: "Integración sináptica:", options: ["IPSP siempre hiperpolariza (falso)", "Axodendrítica más potente que axosomática", "EPSP siempre despolariza", "Si reversión < umbral es inhibidora"], correct: 3 },

        // Q36 (Reducida)
        { id: 'b3_36', text: "Fuerza muscular:", options: ["Fibras rápidas se reclutan antes", "Fuerza regulada por reclutamiento", "Isotónica mantiene longitud", "Isométrica precede isotónica"], correct: 1 },

        // Q37 (Reducida)
        { id: 'b3_37', text: "Endocitosis:", options: ["Hierro degradado", "Mediada por receptor es inespecífica", "Pinocitosis es inespecífica", "Transcitosis en misma región"], correct: 2 },

        // Q38 (Reducida)
        { id: 'b3_38', text: "Receptores sensoriales:", options: ["Codificación por intensidad", "Tónico es adaptación lenta", "Inhibición lateral disminuye discriminación", "Propioceptores externos"], correct: 1 },

        // Q39 (Reducida)
        { id: 'b3_39', text: "Eficacia sináptica incorrecto:", options: ["Habituación decremento", "LTP tardía estructural", "LTP temprana solo eficacia", "LTP ocurre a baja frecuencia"], correct: 3, explanation: "INCORRECTA: Baja frecuencia causa LTD." },

        // Q40 (Reducida)
        { id: 'b3_40', text: "Solución Isoosmolar e Hipotónica:", options: ["150 NaCl + 150 Urea", "75 NaCl + 75 KCl", "75 NaCl + 150 Benceno", "75 NaCl + 75 Benceno"], correct: 2, explanation: "300 mOsm total (Isoosmolar), pero Benceno penetra -> 150 mOsm efectivos (Hipotónica)." },

        // Q41 (Reducida)
        { id: 'b3_41', text: "Segundo mensajero vía Gq:", options: ["Proteína G", "Diacilglicerol (DAG)", "Ligando", "Fosfolipasa C"], correct: 1 },

        // Q42 (Reducida)
        { id: 'b3_42', text: "Causa de edema:", options: ["Hipoalbuminemia", "Aumento presión oncótica", "Disminución permeabilidad", "Aumento presión oncótica plasma"], correct: 0 },

        // Q43 (Reducida)
        { id: 'b3_43', text: "Transporte membrana:", options: ["Na/K introduce 3K", "Receptor endocitosis se recicla", "Simporte mueve ambos en contra", "Permeasas son canales"], correct: 1 },

        // Q44 (Reducida)
        { id: 'b3_44', text: "Velocidad PA:", options: ["Diámetro > Mielina", "Menor diámetro mayor velocidad", "Mielina baja capacitancia y sube resistencia", "Desmielinización no afecta"], correct: 2 },

        // Q45 (Reducida)
        { id: 'b3_45', text: "Leucocitos incorrecto:", options: ["Basófilos liberan histamina", "Neutrófilos fagocitan", "Monocitos diapédesis", "Sólo participan en inmunidad adquirida"], correct: 3, explanation: "INCORRECTA: Participan en innata." },

        // Q46 (Reducida)
        { id: 'b3_46', text: "Cadherinas:", options: ["Uniones heterofílicas", "Funciones tróficas", "Movilidad tisular", "Su pérdida se asocia a metástasis"], correct: 3 },

        // Q47 (Reducida)
        { id: 'b3_47', text: "Sinergia:", options: ["Efecto idéntico", "Bloqueo", "Respuesta mayor que la suma", "Respuesta menor"], correct: 2 },

        // Q48 (Reducida)
        { id: 'b3_48', text: "Potencial reposo:", options: ["Determinado por Na", "Independiente transporte activo", "Próximo al potencial de equilibrio del K+", "Depende de Ca++"], correct: 2 },

        // Q49 (Reducida)
        { id: 'b3_49', text: "Despolarización por:", options: ["Aumento permeabilidad Cl-", "Reducción permeabilidad Na+", "Aumento permeabilidad Ca++", "Reducción permeabilidad K+"], correct: 2 },

        // Q50 (Reducida)
        { id: 'b3_50', text: "Potencial electrotónico viaja más si:", options: ["Mayor resistencia interna", "Mayor constante de espacio (lambda)", "Menor resistencia membrana", "Mayor capacitancia"], correct: 1 },

        // Q51 (Reducida)
        { id: 'b3_51', text: "Sumación de múltiples axones:", options: ["LTP", "Sumación temporal", "Sumación espacial", "Sensibilización"], correct: 2 },

        // Q52 (Reducida)
        { id: 'b3_52', text: "Gráfica PA (Incorrecta):", options: ["Punto A gradiente Na", "Punto B salida K excede entrada Na", "Punto C K alejado eq", "Punto E refractario"], correct: 1, explanation: "INCORRECTA: En despolarización (B), entrada Na supera salida K." },

        // Q53 (Reducida)
        { id: 'b3_53', text: "Transportadores que hidrolizan ATP:", options: ["Solo a favor", "Canales iónicos", "Proteínas de membrana (Bombas)", "Pasivo"], correct: 2 },

        // Q54 (Reducida)
        { id: 'b3_54', text: "Difusión facilitada:", options: ["Permeasas", "Canales", "Transporta a favor", "Velocidad lineal ilimitada"], correct: 2 },

        // Q55 (Reducida)
        { id: 'b3_55', text: "Transporte LDL (incorrecta):", options: ["Endocitosis receptor", "Clatrina", "Vesículas degradan en RE", "Receptores reciclan"], correct: 2, explanation: "INCORRECTA: Van a lisosomas." },

        // Q56 (Reducida)
        { id: 'b3_56', text: "Receptores celulares:", options: ["Todos proteínas", "Todos enzimas", "Todos en núcleo", "Todos en membrana"], correct: 0 },

        // Q57 (Reducida)
        { id: 'b3_57', text: "Señalización peptídica:", options: ["Mismo receptor siempre", "Puede tener efectos distintos", "Solo atraviesa membrana", "Factor transcripción"], correct: 1 },

        // Q58 (Reducida)
        { id: 'b3_58', text: "Receptores hormonales:", options: ["Menor afinidad", "Células vecinas", "Menos específicos", "Activan órganos simultáneamente"], correct: 3 },

        // Q59 (Reducida)
        { id: 'b3_59', text: "Unión Miosina-Actina:", options: ["Baja Ca", "Fija ATP", "Tropomiosina libera sitio", "Ca une a miosina"], correct: 2 },

        // Q60 (Reducida)
        { id: 'b3_60', text: "Músculo liso diferencia:", options: ["Ausencia sarcómeras", "Mayor velocidad", "Mayor consumo", "Fatiga rápida"], correct: 0 },

        // Q61 (Reducida)
        { id: 'b3_61', text: "Contracción isométrica:", options: ["No consumo", "No acortamiento músculo", "No tensión", "No acortamiento sarcómeras"], correct: 1 },

        // Q62 (Reducida)
        { id: 'b3_62', text: "Gradiente electroquímico:", options: ["Favorece activo", "Favorece iones por canales", "Favorece permeasas", "Suma químico + eléctrico"], correct: 3 },

        // Q63 (Reducida)
        { id: 'b3_63', text: "Glucosa intestinal:", options: ["Primario", "Simporte Na+", "Antiporte", "A favor gradiente"], correct: 1 },

        // Q64 (Reducida)
        { id: 'b3_64', text: "Fagocitosis:", options: ["Iones", "Glucosa", "Recicla", "Destruye bacterias"], correct: 3 },

        // Q65 (Reducida)
        { id: 'b3_65', text: "Receptores NT incorrecta:", options: ["Canales", "Proteína G", "Membrana nuclear", "Membrana plasmática"], correct: 2 },

        // Q66 (Reducida)
        { id: 'b3_66', text: "Integrinas:", options: ["NT", "Neurotrofinas", "Citoquinas", "Moléculas de adhesión"], correct: 3 },

        // Q67 (Reducida)
        { id: 'b3_67', text: "Conexinas incorrecta:", options: ["Poros", "Paso proteínas", "Acoplamiento", "Solo neuronas"], correct: 3 },

        // Q68 (Reducida)
        { id: 'b3_68', text: "Potencial equilibrio incorrecta:", options: ["Depende gradiente", "Depende carga", "Varía si varían concentraciones", "Depende de diferencia de potencial actual"], correct: 3 },

        // Q69 (Reducida)
        { id: 'b3_69', text: "Vm positivo que reposo:", options: ["Despolarizada", "Hiperpolarizada", "Aleja umbral", "Abre Cl-"], correct: 0 },

        // Q70 (Reducida)
        { id: 'b3_70', text: "Potenciales locales incorrecta:", options: ["Cambios Vm", "Suman", "Son PA", "Respuesta corriente"], correct: 2 },

        // Q71 (Reducida)
        { id: 'b3_71', text: "Canales K+ voltaje:", options: ["Abren por NA", "Inactivan", "Fase hiperpolarizante", "Salida K"], correct: 2 },

        // Q72 (Reducida)
        { id: 'b3_72', text: "Velocidad PA incorrecta:", options: ["Resistencia axial", "Resistencia membrana", "Capacitancia", "Intensidad estímulo"], correct: 3 },

        // Q73 (Reducida)
        { id: 'b3_73', text: "Na/K ATPasa:", options: ["Osmolaridad", "Isoosmótico", "Genera PA", "Mueve cargas (electrogénica)"], correct: 3 },

        // Q74 (Reducida)
        { id: 'b3_74', text: "Facilitada:", options: ["Lineal", "Velocidad máxima saturación", "Más soluto menor vel", "Independiente"], correct: 1 },

        // Q75 (Reducida)
        { id: 'b3_75', text: "Endocitosis incorrecta:", options: ["Transporta iones libres", "Macromoléculas", "Recicla", "Regula"], correct: 0 },

        // Q76 (Reducida)
        { id: 'b3_76', text: "ACh incorrecta:", options: ["Sintetiza L-Dopa", "Vesículas", "Terminal", "Rotura enzimática"], correct: 0 },

        // Q77 (Reducida)
        { id: 'b3_77', text: "Glutamato incorrecta:", options: ["Tipos", "Bloqueo Ca++", "Despolarizada", "Iono"], correct: 1, explanation: "INCORRECTA: Bloqueo por Mg++." },

        // Q78 (Reducida)
        { id: 'b3_78', text: "Excitotoxicidad:", options: ["ACh", "Serotonina", "Glutamato", "GABA"], correct: 2 },

        // Q79 (Reducida)
        { id: 'b3_79', text: "Hiperpolarización:", options: ["GABA-A", "AMPA", "Nicotínico", "Adrenérgico"], correct: 0 },

        // Q80 (Reducida)
        { id: 'b3_80', text: "Inhibición MAO:", options: ["Aumento ACh", "Caída glicina", "Incremento catecolaminas", "Descenso endorfinas"], correct: 2 },

        // Q81 (Reducida)
        { id: 'b3_81', text: "Difusión simple:", options: ["Na", "CO2", "Galactosa", "Glucosa"], correct: 1 },

        // Q82 (Reducida)
        { id: 'b3_82', text: "Activo incorrecto:", options: ["Contra gradiente", "Desequilibrio", "Secundario hidroliza ATP", "Primario usa ATP"], correct: 2 },

        // Q83 (Reducida)
        { id: 'b3_83', text: "Facilitada:", options: ["Continuidad", "Se satura", "Lineal", "Energía"], correct: 1 },

        // Q84 (Reducida)
        { id: 'b3_84', text: "Tonicidad:", options: ["No depende", "Hipertónica hincha", "Hipotónica hincha", "Ideal hipotónica"], correct: 2 },

        // Q85 (Reducida)
        { id: 'b3_85', text: "Proteínas transporte:", options: ["Canales", "Endocitosis", "Activo", "Simple"], correct: 1 },

        // Q86 (Reducida)
        { id: 'b3_86', text: "Permeabilidad reposo incorrecta:", options: ["Solo Na", "K y Na", "Fuga", "Influyen"], correct: 0 },

        // Q87 (Reducida)
        { id: 'b3_87', text: "Conexinas:", options: ["Adhesión", "Canales intercelulares", "NT", "Hormonas"], correct: 1 },

        // Q88 (Reducida)
        { id: 'b3_88', text: "Sinapsis incorrecta:", options: ["Ca libera", "Hormonas", "NT intracelulares", "G postsináptico"], correct: 2 },

        // Q89 (Reducida)
        { id: 'b3_89', text: "Excitador:", options: ["ACh", "Glutamato", "Glicina", "GABA"], correct: 1 },

        // Q90 (Reducida)
        { id: 'b3_90', text: "Hematopoyesis incorrecta:", options: ["Todas se dividen", "Hígado", "EPO", "Megacariocito"], correct: 0 },

        // Q91 (Reducida)
        { id: 'b3_91', text: "Eritrocitos:", options: ["Multi", "Reservas", "Distribuyen O2", "Horas"], correct: 2 },

        // Q92 (Reducida)
        { id: 'b3_92', text: "AB puede recibir:", options: ["A+", "O+", "AB+", "B-"], correct: 2, explanation: "AB+ es receptor universal." },

        // Q93 (Reducida)
        { id: 'b3_93', text: "Plaquetas incorrecta:", options: ["Fragmentos", "Defensa extravasan", "Tapón", "Gránulos"], correct: 1 },

        // Q94 (Reducida)
        { id: 'b3_94', text: "Circulatorio:", options: ["Mayor presión arterias", "Flujo gradiente", "Sistólica 60", "Diámetro no afecta"], correct: 0 },

        // Q95 (Reducida)
        { id: 'b3_95', text: "Capilares:", options: ["Fenestrados", "SNC todo", "Starling regulan", "Transcitosis"], correct: 2 }
    ];

    // --- Logic ---
    let currentQuestions = [];
    let userAnswers = {};
    let markedQuestions = new Set();
    let currentMode = 'ordered';

    function selectBattery(mode) {
        currentMode = mode;
        if (mode === 'exam') {
            startQuiz('random');
        } else {
            document.getElementById('order-options').style.display = 'block';
            document.getElementById('order-options').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function startQuiz(mode) {
        userAnswers = {};
        markedQuestions.clear();
        let indices = battery3_optimized.map((_, i) => i);
        
        if (mode === 'random' || currentMode === 'exam') {
            indices.sort(() => Math.random() - 0.5);
        }
        
        if (currentMode === 'exam') {
            indices = indices.slice(0, 20);
        }

        loadQuestions(indices);
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('results-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
    }

    function loadQuestions(indices) {
        currentQuestions = indices;
        const container = document.getElementById('questions-list');
        const navGrid = document.getElementById('nav-grid');
        
        container.innerHTML = '';
        navGrid.innerHTML = '';

        indices.forEach((qIndex, displayIndex) => {
            const q = battery3_optimized[qIndex];
            
            let optionIndices = q.options.map((_, i) => i);
            optionIndices.sort(() => Math.random() - 0.5);

            const div = document.createElement('div');
            div.className = 'question-container';
            div.id = `q-${qIndex}`;
            div.innerHTML = `
                <div class="question-header">
                    <span class="question-text">${displayIndex}. ${q.text}</span>
                    <span class="mark-check" onclick="toggleMark(${qIndex})" id="mark-${qIndex}" title="Marcar">★</span>
                </div>
                <div class="options-grid">
                    ${optionIndices.map(optIdx => `
                        <div class="option" onclick="selectAnswer(${qIndex}, ${optIdx}, this, ${q.correct})">
                            ${q.options[optIdx]}
                        </div>
                    `).join('')}
                </div>
                <div class="feedback" id="feedback-${qIndex}"></div>
            `;
            container.appendChild(div);

            const navBtn = document.createElement('button');
            navBtn.className = 'nav-btn';
            navBtn.innerText = displayIndex;
            navBtn.id = `nav-${qIndex}`;
            navBtn.onclick = () => document.getElementById(`q-${qIndex}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            navGrid.appendChild(navBtn);
        });
    }

    function selectAnswer(qIndex, selectedOptIdx, optionElem, correctOptIdx) {
        if (userAnswers[qIndex]) return;

        const isCorrect = selectedOptIdx === correctOptIdx;
        userAnswers[qIndex] = { selectedOption: selectedOptIdx, isCorrect: isCorrect };

        const parent = optionElem.parentNode;
        const options = parent.getElementsByClassName('option');
        
        for(let opt of options) {
            opt.classList.add('disabled');
            if (opt.innerText.trim() === battery3_optimized[qIndex].options[correctOptIdx].trim()) {
                opt.classList.add('correct');
            }
        }

        if (!isCorrect) optionElem.classList.add('incorrect');

        const feedbackEl = document.getElementById(`feedback-${qIndex}`);
        feedbackEl.style.display = 'block';
        feedbackEl.innerHTML = `<strong>${isCorrect ? '¡Correcto!' : 'Respuesta Incorrecta'}</strong><br>${battery3_optimized[qIndex].explanation || ''}`;
        feedbackEl.classList.add(isCorrect ? 'success' : 'error');

        document.getElementById(`nav-${qIndex}`).classList.add(isCorrect ? 'correct' : 'incorrect');
    }

    function toggleMark(qIndex) {
        if (markedQuestions.has(qIndex)) {
            markedQuestions.delete(qIndex);
            document.getElementById(`mark-${qIndex}`).classList.remove('marked');
            document.getElementById(`nav-${qIndex}`).classList.remove('marked');
        } else {
            markedQuestions.add(qIndex);
            document.getElementById(`mark-${qIndex}`).classList.add('marked');
            document.getElementById(`nav-${qIndex}`).classList.add('marked');
        }
    }

    function finishQuiz() {
        const total = currentQuestions.length;
        const correct = Object.values(userAnswers).filter(a => a.isCorrect).length;
        const score = total > 0 ? ((correct / total) * 10).toFixed(1) : 0;

        document.getElementById('score-display').innerText = `Nota: ${score} / 10`;
        document.getElementById('stats-display').innerText = `Aciertos: ${correct} / ${total}`;
        
        document.getElementById('quiz-screen').classList.remove('active');
        document.getElementById('results-screen').classList.add('active');
    }

    function resetQuiz(criteria) {
        let nextIndices = [];
        if (criteria === 'all') {
            startQuiz('ordered');
            return;
        }
        if (criteria === 'failed') {
            nextIndices = currentQuestions.filter(idx => userAnswers[idx] && !userAnswers[idx].isCorrect);
        } else if (criteria === 'marked') {
            nextIndices = Array.from(markedQuestions);
        } else if (criteria === 'failed_marked') {
            const failed = currentQuestions.filter(idx => userAnswers[idx] && !userAnswers[idx].isCorrect);
            const marked = Array.from(markedQuestions);
            nextIndices = [...new Set([...failed, ...marked])];
        }

        if (nextIndices.length === 0) {
            alert("No hay preguntas para ese criterio.");
            return;
        }

        userAnswers = {};
        nextIndices.sort(() => Math.random() - 0.5);
        loadQuestions(nextIndices);
        document.getElementById('results-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
    }
</script>
</body>
</html>
